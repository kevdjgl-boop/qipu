<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monedero V.2.19 (Reestructuración Estética)</title>
    <!-- Incluye Tailwind CSS para estilizado rápido y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluye Font Awesome para íconos de balance -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Incluye Chart.js para la gráfica de gastos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Configuración para usar la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            overflow-x: hidden;
            //padding-bottom: 4rem; 
            width: 100vw; /* 4. Haz que el body ocupe el 100vw */
            height: 100vh;      /* AÑADIDO: Fija la altura del body a la ventana */
            overflow: hidden;   /* CAMBIADO: Evita CUALQUIER scroll en el body */
            margin: 0;          /* AÑADIDO: Quita márgenes por defecto */
        }

        #app-layout {
            display: flex; /* La magia para ponerlos uno al lado del otro */
        }           
        
        #main-content-wrapper {
            flex-grow: 1; /* Ocupa el espacio restante */
            height: 100vh;
            overflow-y: auto;
            padding-bottom: 2rem;
        }

        #content-column {
        display: flex;
        flex-direction: column; /* Apila la barra y el contenido verticalmente */
        flex-grow: 1;         /* Ocupa el resto del ancho */
        //height: 100vh;        /* Ocupa toda la altura */
        //overflow: hidden;       /* Evita que esta columna tenga scroll */
        position: relative;
        }
        /* Ocultar texto de estado cuando el sidebar está colapsado */
        #app-layout:not(.sidebar-is-open) #auth-status-text {
        display: none;
        }
        .no-scroll {
        overflow-y: hidden !important;
        }

        .section-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border: none; /* 2. Quitamos bordes de colores */
        }
        /* Dashboard principal - Estilo destacado */
        #global-main-card {
            background-color: #111827; /* Gray-900 */
            color: white;
            border-bottom: none; /* 2. Quitamos el borde inferior */
        }
        #initial-loading-screen {
        position: fixed;  /* La clave: lo saca del flujo normal */
        inset: 0;         /* Abreviatura de: top:0, left:0, right:0, bottom:0 */
        background-color: #f3f4f6; /* El mismo color de fondo del body */
        z-index: 100;     /* Lo pone por encima de todo */
        
        /* Centra el contenido (ya lo tenías con Tailwind) */
        //display: flex;
        //justify-content: center;
        align-items: center;

        /* Ignora las clases de espaciado/tamaño de Tailwind */
        padding-top: 0 !important;
        height: 100vh !important;
        max-width: 100% !important;
        }
        /* Estilo para los métricos dentro del dark card */
        .metric-value {
             font-size: 2rem; /* 32px */
             font-weight: 800; /* Extra bold */
             line-height: 1.2;
             margin-top: 0.5rem;
             display: block;
        }
        .metric-label {
             font-size: 0.75rem; /* 12px */
             font-weight: 600;
             text-transform: uppercase;
        }

        /* --- ESTILOS DE INPUTS Y SELECTS (3. Sin bordes y fondo #E1E3E7) --- */
        .custom-input, .custom-select-button {
            background-color: #E1E3E7; /* Fondo gris claro */
            border: none !important; /* Quitar bordes */
            box-shadow: none !important;
            padding: 0.75rem !important;
            border-radius: 0.5rem !important;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .custom-input:focus, .custom-select-button:focus {
            background-color: #d8d8d8; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); /* Sutil ring focus */
        }
        .custom-select-options {
            border: 1px solid #d1d5db;
        }

        /* --- ESTILOS CRÍTICOS PARA TARJETAS DE SALDO (Glassmorphism) --- */
        .balance-glass-card {
            position: relative;
            overflow: hidden; 
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 1.5rem; 
            padding: 1.5rem; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            min-height: 300px; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .balance-glass-card::before {
            content: '';
            position: absolute;
            top: -100px; 
            left: -100px;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            filter: blur(80px); 
            opacity: 0.4; 
            z-index: -1; 
        }
        .balance-glass-card.saldo-glow::before {
            background-image: radial-gradient(circle, #2dd4bf, #3b82f6);
        }
        .balance-glass-card.gasto-glow::before {
            background-image: radial-gradient(circle, #fb923c, #f43f5e);
        }
        .glass-card-amount {
            font-weight: 800;
            color: #111827; 
            font-size: 3rem;
            line-height: 1;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            display: block;
        }
        /* --- FIN ESTILOS GLASSMORPHISM --- */

        /* --- ESTILO TARJETA DE PARTICIPANTE (Dark Glass 2.0) --- */
        .participant-summary-card {
            background-color: rgba(17, 24, 39, 0.9);
            color: white;
            border-radius: 1.5rem;
            padding: 1.5rem;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .participant-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 50%;
            background: radial-gradient(circle at 10% 10%, rgba(79, 70, 229, 0.3), transparent 70%); 
            filter: blur(50px);
            z-index: 0;
            pointer-events: none;
        }
        .participant-content {
            position: relative;
            z-index: 1; 
        }
        .metric-detail-container {
            background-color: rgba(255, 255, 255, 0.1); 
            padding: 1rem;
            border-radius: 1rem;
        }
        .main-balance-amount {
            font-size: 2.25rem; 
            font-weight: 900;
            line-height: 1.1;
            display: block;
            margin-top: 0.5rem;
        }
        .balance-positive-dark { color: #34D399; } /* Green-400 */
        .balance-negative-dark { color: #F87171; } /* Red-400 */
        /* --- FIN ESTILO TARJETA PARTICIPANTE --- */


        /* --- NUEVO: ESTILO PARA TARJETAS DEL HISTORIAL (Glass) --- */
        .history-card {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            padding: 1rem;
            display: flex;
            align-items: center;
            transition: transform 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.5);
            position: relative;
        }
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        .history-date-col {
            padding-right: 1rem;
            border-right: 1px solid #e5e7eb;
            text-align: center;
            flex-shrink: 0;
            min-width: 60px;
        }
        /* Oculta el botón "Configuración" original */
        #open-participants-sidebar-btn {
            display: none;
        }
        /* Estilo para el botón de toggle en el sidebar */
        #close-sidebar-btn {
            position: absolute;
            top: 1.5rem; /* 24px */

            /* Se alinea a la DERECHA del sidebar ABIERTO (400px) */
            left: calc(400px - 2rem - 1.5rem); /* (Ancho Abierto) - (Ancho Botón) - (Padding Derecho) */

            z-index: 60; /* Encima del contenido del sidebar */
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #4b5563; /* text-gray-600 */
            width: 2rem; /* w-8 */
            height: 2rem; /* h-8 */
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease-out, left 0.3s ease-out;
            border: none;
        }
        #close-sidebar-btn:hover {
            background-color: #e5e7eb; /* bg-gray-200 */
        }
        #close-sidebar-btn i {
            transition: transform 0.3s ease-out;
        }

        /* Cuando el sidebar está COLAPSADO (clase .open NO está) */
        #participant-sidebar:not(.open) #close-sidebar-btn {
            /* Se centra en la barra colapsada de 80px */
            left: calc(80px / 2 - 1rem); /* (Ancho Colapsado / 2) - (Ancho Botón / 2) */
            top: 1.5rem; /* Lo mantenemos arriba */
        }

        /* Cambiar el icono (rotarlo) cuando está colapsado */
        #participant-sidebar:not(.open) #close-sidebar-btn i {
            transform: rotate(180deg); /* La flecha apunta a la derecha */
        }
        .history-day-num {
            font-size: 1.8rem;
            font-weight: 800;
            line-height: 1;
            color: #3b82f6; /* Blue-500 */
        }
        .history-day-name {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #6b7280; /* Gray-500 */
        }
        .history-content-col {
            flex-grow: 1;
            padding-left: 1rem;
        }
        .history-amount-col {
            flex-shrink: 0;
            padding-left: 0.5rem;
            text-align: right;
        }
        /* --- FIN NUEVO ESTILO HISTORIAL --- */
        
        /* 1. Estilo para el contenedor del gráfico colapsable */
        #chart-collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        #chart-collapsible-content.open {
            max-height: 1000px; /* Suficientemente grande para el contenido */
            transition: max-height 0.7s ease-in;
        }


        .balance-positive { color: #10B981; } /* Green */
        .balance-negative { color: #EF4444; } /* Red */

        /* Estilo para hacer la tarjeta de gasto clickeable */
        .expense-header {
            cursor: pointer;
            user-select: none;
        }
        /* Estilo específico para la tarjeta de participante (más grueso) */
        .participant-card {
            /* Mantenemos el estilo para el sidebar */
            border: 1px solid #d8b4fe; /* Purple-300 */
            background-color: #f3e8ff; /* Purple-50 */
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

            /* --- ESTILOS CRÍTICOS DEL SIDEBAR --- */
        #participant-sidebar {
            position: sticky;
            top: 0;
            left: 0;
            height: 98vh;
            background-color: #fff;
            z-index: 50;
            flex-shrink: 0;
            width: 80px;
            transition: width 0.3s ease-out;

            /* --- CAMBIOS AQUÍ --- */
            position: relative; /* AÑADIDO: Para ser el 'padre' de los contenedores absolutos */
            overflow: hidden;   /* CAMBIADO: Oculta todo lo que se desborde */
            border-top-right-radius: 1.5rem;    /* 24px */
            border-bottom-right-radius: 1.5rem; /* 24px */
        }
        #participant-sidebar.open {
            width: 400px; /* ANCHO EXPANDIDO (tu max-width anterior) */
        }

            /* --- AÑADE ESTE BLOQUE COMPLETO --- */

        /* 1. Estilos para el nuevo contenedor de iconos */
        #sidebar-collapsed-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Damos espacio para el botón de toggle que está en absolute */
            padding-top: 6rem; 
            gap: 1.5rem; /* Espacio entre iconos */
        }

        .icon-link {
            position: relative;
            color: #4b5563; /* text-gray-600 */
            font-size: 1.5rem; /* text-2xl */
            padding: 0.75rem; /* p-3 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: background-color 0.2s, color 0.2s;
        }

        .icon-link:hover {
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #4f46e5; /* text-indigo-600 */
        }
        /* ===== AÑADE ESTE NUEVO BLOQUE DE CSS ===== */
        .icon-badge {
            position: absolute;
            top: 4px; /* Ajusta la posición vertical */
            right: 4px; /* Ajusta la posición horizontal */
            
            /* El color de fondo (puedes usar el rojo de "gasto" o el índigo de "filtro") */
            background-color: #4F46E5; /* Indigo-600 */
            color: white;
            
            font-size: 0.7rem; /* 11px */
            font-weight: 700;
            line-height: 1; /* Para centrar el número */
            
            /* Esto crea el "cuadrado con esquinas redondeadas" */
            padding: 4px 6px;
            border-radius: 0.375rem; /* rounded-md */
            min-width: 1.5rem; /* 20px (para que se vea bien con 1 dígito) */
            text-align: center;
            
            /* Oculto por defecto */
            display: none; 
            transition: transform 0.2s ease;
        }

        /* Clase para mostrarlo (que añadiremos con JS) */
        .icon-badge.show {
            display: inline-block;
            transform: scale(1);
        }
/* ===== FIN DEL NUEVO BLOQUE DE CSS ===== */

        /* 2. Lógica para mostrar/ocultar los contenedores */

      /* --- AÑADE ESTE NUEVO BLOQUE DE CSS --- */

        /* 1. Estilos para AMBOS contenedores de contenido (Colapsado y Expandido) */
        #sidebar-collapsed-content,
        #sidebar-expanded-content {
        width: 400px; 
        box-sizing: border-box;
        //overflow-y: auto; 
        position: absolute; 
        top: 0;
        left: 0;
        height: 100%;
        transition: opacity 0.3s ease-out, filter 0.3s ease-out, visibility 0.3s;
        padding-top: 5rem; /* Empuja el contenido hacia abajo (ajusta si es necesario) */
        display: flex;             /* Habilita Flexbox */
        flex-direction: column;    /* Coloca los elementos en columna */
        //justify-content: space-between; /* Distribuye el espacio entre los elementos */
        /* Puedes añadir padding-bottom aquí si es necesario para el scroll */
        padding-bottom: 2rem; 
        }

        /* 2. Estilos específicos para el CONTENIDO EXPANDIDO */
        #sidebar-expanded-content {
            width: 400px; /* Ancho fijo */
            box-sizing: border-box;
            overflow-y: auto; /* El scroll ahora va aquí DENTRO */
            /* La clase .p-6 que ya tiene le da el padding */
        }

        /* 3. Estilos específicos para el CONTENIDO COLAPSADO (Iconos) */
        #sidebar-collapsed-content {
            width: 80px; /* Ancho fijo */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 6rem;
            gap: 1.5rem;
        }

        #sidebar-expanded-content > div:last-child { 
        margin-top: auto; /* <-- ESTO LO EMPUJA AL FINAL */
        flex-shrink: 0;   /* Evita que se encoja si el contenido es largo */

        /* Re-aplicamos padding/border porque p-6 ya no aplica directamente */
        padding-top: 1.5rem; /* pt-6 */
        border-top: 1px solid #e5e7eb; /* border-t border-gray-200 */
        padding-bottom: 1.5rem; /* Añade espacio abajo */
        padding-left: 1.5rem;  /* Añade padding lateral */
        padding-right: 1.5rem; /* Añade padding lateral */
        }

        /* 4. La LÓGICA DE VISIBILIDAD (¡Aquí ocurre la magia!) */

        /* Por defecto (colapsado): Ocultar expandido, mostrar iconos */
        #participant-sidebar:not(.open) #sidebar-expanded-content {
            opacity: 0;
            filter: blur(5px); /* Inicia borroso */
            visibility: hidden; /* Oculto y no-interactuable */
        }
        #participant-sidebar:not(.open) #sidebar-collapsed-content {
            opacity: 1;
            filter: blur(0px); /* Enfocado */
            visibility: visible;
        }

        /* Cuando está .open: Ocultar iconos, mostrar expandido */
        #participant-sidebar.open #sidebar-expanded-content {
            opacity: 1;
            filter: blur(0px); /* Termina enfocado */
            visibility: visible;
        }
        #participant-sidebar.open #sidebar-collapsed-content {
            opacity: 0;
            filter: blur(5px); /* Se va borroso */
            visibility: hidden;
        }

        /* 3. Darle un ancho fijo al contenido expandido (reemplaza la regla eliminada) */
        #sidebar-expanded-content {
            width: 400px;
            box-sizing: border-box;
            /* Ya no usamos white-space: nowrap, dejamos que el texto fluya */
        }

        /* El backdrop ya no es necesario con este layout */
        .backdrop {
            display: none !important;
        }

        /* Ya no necesitamos bloquear el scroll del body */
        .no-scroll {
            overflow-y: auto !important; 
        }
        /* --- FIN ESTILOS SIDEBAR --- */
        
        .header-btn {
            background-color: #4F46E5; /* Indigo-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #open-participants-sidebar-btn:hover {
            background-color: #4338CA; /* Indigo-700 */
        }


        /* Estilo para el indicador de conexión */
        .sync-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
            transition: background-color 0.3s;
        }
        .sync-green { background-color: #10B981; } /* Green */
        .sync-red { background-color: #EF4444; } /* Red */

        /* --- ESTILOS PARA CUSTOM SELECT --- */
        .custom-select-options {
            max-height: 160px; /* Limitar altura */
            overflow-y: auto;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .custom-select-options::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .custom-select-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .custom-select-option:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .custom-select-option.selected {
            background-color: #eef2ff; /* indigo-50 */
            font-weight: 600;
            color: #4f46e5; /* indigo-600 */
        }
        /* --- FIN ESTILOS CUSTOM SELECT --- */

        /* --- ESTILOS PARA BARRA DE PROGRESO --- */
        .progress-bar-container {
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
            height: 8px;
            width: 100%;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-out, background-color 0.5s ease-out;
        }
        
        /* --- ESTILOS PARA POPOVER DE FILTROS Y ETIQUETAS --- */
        #filter-popover {
            transition: opacity 0.2s ease-out, visibility 0.2s ease-out, transform 0.2s ease-out;
            max-height: 400px; /* Limitar altura máxima */
            overflow-y: auto; /* Scroll si es necesario */
        }
        #filter-popover.hidden {
           opacity: 0;
           visibility: hidden;
           transform: translateY(-10px);
        }
          #filter-popover-button .active-indicator {
            display: none;
          }
          #filter-popover-button.active .active-indicator {
            display: inline-block;
          }
          /* Estilos para las etiquetas de filtro en el popover */
        .filter-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            border-radius: 9999px; /* fully rounded */
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* medium */
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            border: 1px solid transparent;
        }
        .filter-tag.category-tag {
            background-color: #e0e7ff; /* indigo-100 */
            color: #3730a3; /* indigo-800 */
            border-color: #c7d2fe; /* indigo-200 */
        }
          .filter-tag.participant-tag {
            background-color: #f3e8ff; /* purple-100 */
            color: #5b21b6; /* purple-800 */
            border-color: #e9d5ff; /* purple-200 */
        }
        /* NUEVO: Estilo para etiquetas de método de pago */
        .filter-tag.payment-method-tag {
             background-color: #d1fae5; /* green-100 */
             color: #065f46; /* green-800 */
             border-color: #a7f3d0; /* green-200 */
          }
        .filter-tag:hover {
             box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3); /* Ring effect on hover */
        }
        .filter-tag.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-color: #4f46e5;
            font-weight: 600;
        }
          .filter-tag.participant-tag.active {
            background-color: #7e22ce; /* purple-700 */
            border-color: #7e22ce;
          }
          /* NUEVO: Estilo activo para etiquetas de método de pago */
          .filter-tag.payment-method-tag.active {
            background-color: #047857; /* green-700 */
            border-color: #047857;
          }
        /* Estilos para las etiquetas en las tarjetas de gasto */
        .expense-card-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.1rem 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.65rem; /* Smaller than text-xs */
            font-weight: 600; /* semibold */
            margin-right: 0.25rem;
            line-height: 1;
        }
        .expense-card-tag.category {
             background-color: #dbeafe; /* blue-100 */
             color: #1e40af; /* blue-800 */
        }
          .expense-card-tag.participant {
             background-color: #fef3c7; /* amber-100 */
             color: #92400e; /* amber-800 */
          }
          /* NUEVO: Estilo para etiqueta de método de pago en tarjeta */
          .expense-card-tag.payment-method {
              background-color: #e0f2fe; /* cyan-100 */
              color: #0e7490; /* cyan-800 */
          }
        .category-toggle-btn {
            background: none;
            border: none;
            padding-bottom: 0.5rem; /* Ajusta el padding que ya tenía el borde */
            width: 100%;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-toggle-btn:focus {
             outline: none; /* Quita el borde azul feo al hacer clic */
        }


        /* Contenedor del contenido colapsable */
        .category-collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out; /* Animación al cerrar */
        }

        /* Estado abierto del contenido */
        .category-collapsible-content.open {
            max-height: 5000px; /* Suficientemente grande */
            transition: max-height 0.7s ease-in; /* Animación al abrir */
            margin-top: 0.75rem; /* Añade un pequeño espacio arriba al abrir */
        }

        /* Rotación del icono chevron cuando está abierto */
        .category-toggle-btn.open .category-chevron {
            transform: rotate(180deg);
        }

    </style>
    <!-- Incluye GSAP para animaciones -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
</head>
<body class="min-h-screen">

    <!-- Backdrop para el Sidebar -->
    <div id="sidebar-backdrop" class="backdrop"></div>
      
    <!-- PANTALLA DE CARGA INICIAL (Solo para datos) -->
    <div id="initial-loading-screen" class="max-w-7xl mx-auto px-4 md:px-8 pt-20 flex justify-center items-center h-64">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-indigo-500"></i>
            <p class="mt-3 text-gray-600 font-semibold">Cargando datos financieros...</p>
        </div>
    </div>


    <!-- Contenido principal de la aplicación (Secciones 1, 2, 3) -->
    
    
    <!-- MOBILE MENU (oculto en escritorio) -->
    <div id="mobile-menu" class="lg:hidden bg-white border-t border-gray-200 p-3 shadow-2xl flex justify-around fixed bottom-0 left-0 right-0 z-40">
        <button onclick="document.querySelector('main').scrollIntoView({ behavior: 'smooth' })" class="text-red-500 text-xs text-center"><i class="fas fa-plus-circle text-2xl"></i><br>Gasto</button>
        <button onclick="document.querySelector('#participants-config-section').scrollIntoView({ behavior: 'smooth' })" class="text-purple-500 text-xs text-center"><i class="fas fa-users text-2xl"></i><br>Participantes</button>
        <button onclick="document.querySelector('section:last-of-type').scrollIntoView({ behavior: 'smooth' })" class="text-gray-500 text-xs text-center"><i class="fas fa-list-alt text-2xl"></i><br>Informe</button>
    </div>
    
    <!-- ========================================================================================= -->
    <!-- SIDEBAR DE CONFIGURACIÓN DE PARTICIPANTES -->
    <!-- ========================================================================================= -->
    <div id="app-layout" class="hidden">
        <div id="participant-sidebar">
                <button id="close-sidebar-btn" class="text-gray-500 hover:text-gray-900 transition">
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    <div id="sidebar-collapsed-content">
                                <a href="#" class="icon-link" title="Participantes">
                                    <i class="fas fa-users fa-fw"></i>
                                    <span id="sidebar-participant-count" class="icon-badge">0</span>
                                </a>
                                <a href="#" class="icon-link" title="Monedero">
                                    <i class="fas fa-wallet fa-fw"></i>
                                </a>
                                <a href="#" class="icon-link" title="Herramientas de Datos">
                                    <i class="fas fa-file-export fa-fw"></i>
                                </a>
                    </div>
        
                            <!-- Auth Status - SIMPLIFICADO -->
               <div id="content-column">             
                
                </div>

            <div id="sidebar-expanded-content" class="p-6">

                <div id="sidebar-main-content">

                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-2xl font-bold text-purple-700">Configuración</h2>                    
                </div>
                
                <h3 class="text-xl font-bold text-purple-700 mb-4">Participantes Activos</h3>

                <!-- Botón de Añadir (Dentro del Sidebar) -->
                <button id="open-add-participant-modal-sidebar" class="w-full py-2 mb-4 bg-purple-500 text-white font-bold rounded-lg hover:bg-purple-600 transition">
                    + Añadir Nuevo
                </button>
                
                <div id="participants-list" class="space-y-4">
                    <!-- Lista dinámica de participantes (Compacta) se renderiza aquí -->
                </div>

                <!-- SECCIÓN DE MONEDERO COMPARTIDO -->
                <div id="wallet-section-container">
                    <h3 class="text-xl font-bold text-indigo-700 mt-6 mb-4 border-t pt-4">Gestión del Monedero</h3>

                    <!-- Controles PRE-Monedero (Crear/Unirse) -->
                    <div id="pre-wallet-controls" class="space-y-4">
                        <div class="p-4 border rounded-lg bg-indigo-50">
                            <h4 class="font-bold text-gray-700">Crear un Nuevo Monedero</h4>
                            <p class="text-xs text-gray-500 mb-3">Ideal para empezar de cero o si eres el primero del grupo.</p>
                            <button id="create-wallet-btn" class="w-full py-2 bg-indigo-500 text-white font-bold rounded-lg hover:bg-indigo-600 transition">Crear Monedero</button>
                            <p id="migration-notice" class="text-xs text-blue-600 mt-2 hidden"><i class="fas fa-info-circle"></i> Se migrarán tus datos existentes a este nuevo monedero.</p>
                        </div>
                    
                        <div class="my-2 text-center text-sm font-semibold text-gray-400">O</div>
                    
                        <div class="p-4 border rounded-lg bg-gray-50">
                            <h4 class="font-bold text-gray-700">Unirse a un Monedero Existente</h4>
                            <form id="join-wallet-form" class="flex flex-col items-center space-y-2 mt-2">
                                <input type="text" id="join-wallet-id-input" placeholder="Pegar ID del Monedero" required class="w-full text-center p-2 border border-gray-300 rounded-lg">
                                <button type="submit" class="w-full py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition">Unirse</button>
                            </form>
                        </div>
                    </div>

                    <!-- Controles POST-Monedero (Info y Compartir) -->
                    <div id="post-wallet-controls" class="hidden space-y-3">
                        <div class="p-4 border border-indigo-200 rounded-lg bg-indigo-50 space-y-3">
                            <div>
                                <label class="text-xs font-semibold text-gray-700">ID de este Monedero (para invitar):</label>
                                <div class="flex items-center mt-1">
                                    <input type="text" id="share-wallet-id" readonly class="w-full p-2 border bg-white border-gray-300 rounded-l-lg text-xs">
                                    <button id="copy-wallet-id-btn" class="px-3 py-2 bg-indigo-500 text-white rounded-r-lg hover:bg-indigo-600"><i class="fas fa-copy"></i></button>
                                </div>
                            </div>
                            <p id="current-user-id" class="text-xs text-gray-600 break-words">
                                Mi UID: Cargando...
                            </p>
                        </div>
                        <!-- HERRAMIENTAS DE DATOS -->
                        <div id="data-management-section" class="mt-6 pt-4 border-t border-gray-300 space-y-2">
                            <h4 class="text-sm font-bold text-gray-700">Herramientas de Datos</h4>
                            <button id="export-json-btn" class="w-full py-2 text-xs bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">
                                <i class="fas fa-file-export"></i> Exportar Datos a Texto
                            </button>
                            <button id="restore-json-btn" class="w-full py-2 text-xs bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700 transition">
                                <i class="fas fa-file-import"></i> Importar/Restaurar Datos
                            </button>
                        </div>
                    </div>
                 </div>
                 </div>
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <button id="logout-btn" class="w-full bg-red-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition flex items-center justify-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
            <div id="main-content-wrapper" class="hidden2">
            <!-- ========================================================================================= -->
            <!-- SECCIÓN 1: DASHBOARD PRINCIPAL Y PARTICIPANTES (100% ANCHO) -->
            <!-- ========================================================================================= -->
            <section class="max-w-7xl mx-auto px-4 md:px-8 pt-6 space-y-6">
                <div class="flex justify-between items-center border-b pb-2 mb-4">
                    <h1 class="text-3xl font-extrabold text-gray-800 flex items-center">
                        Dashboard Principal 
                    </h1>
                    <!-- Botones de la Cabecera -->
                    <div class="flex items-center space-x-2">
                        <div id="auth-status-container" class="flex items-center bg-white rounded-lg shadow-sm p-2">
                            <p id="auth-status" class="text-xs text-gray-600 flex items-center">
                                <span id="connection-dot" class="sync-indicator sync-red"></span>
                                <span id="auth-status-text" class="ml-1.5">Conectando...</span>
                            </p>
                        </div>
                        <button id="open-participants-sidebar-btn" class="header-btn">
                            <i class="fas fa-users-cog"></i> <span>Configuración</span>
                        </button>
                    </div>
                </div>

                <!-- Dashboard Layout (Contenido Principal) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        
                        <!-- NUEVO: TARJETAS DE SALDO ESTILO GLASSMORPHISM -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Tarjeta Saldo Global -->
                            <div class="balance-glass-card saldo-glow">
                                <div>
                                    <div class="glass-card-header">
                                        <span class="glass-card-title">Saldo Global</span>
                                        <div class="glass-card-icon">
                                            <i class="fas fa-wallet"></i>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <span id="display-remaining-budget" class="glass-card-amount saldo-text">S/ 0.00</span>
                                    <span class="glass-card-subtitle">Disponible</span>
                                </div>
                            </div>
                            
                            <!-- Tarjeta Gasto Total -->
                            <div class="balance-glass-card gasto-glow">
                                <div>
                                    <div class="glass-card-header">
                                        <span class="glass-card-title">Gasto Total</span>
                                        <div class="glass-card-icon">
                                            <i class="fas fa-receipt"></i>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <span id="display-total-spent" class="glass-card-amount gasto-text">S/ 0.00</span>
                                    <span class="glass-card-subtitle">En este ciclo</span>
                                </div>
                            </div>
                        </div>
                        <!-- FIN NUEVO: TARJETAS DE SALDO ESTILO GLASSMORPHISM -->

                    
                        <!-- CARDS INDIVIDUALES Y AHORRO MUTUO -->
                        <div class="section-card space-y-4">
                            <h3 class="text-lg font-bold text-gray-700">Saldos Individuales y Metas</h3>
                            <div id="participant-summary-cards" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <!-- Tarjetas de resumen individual se renderizan aquí -->
                            </div>
                            <div class="grid grid-cols-2 gap-4 pt-2 border-t border-gray-200">
                                <div class="section-card p-4 text-center bg-yellow-50">
                                    <p class="text-sm font-semibold uppercase text-yellow-700">Gastos Fijos Total</p>
                                    <span id="display-fixed-total" class="text-2xl font-extrabold text-yellow-600 block mt-2">S/ 0.00</span>
                                </div>
                                <div class="section-card p-4 text-center bg-purple-50">
                                    <p class="text-sm font-semibold uppercase text-purple-700">Meta Ahorro Mutuo</p>
                                    <span id="display-shared-savings-goal" class="text-2xl font-extrabold text-purple-600 block mt-2">S/ 0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- NUEVO: RESUMEN DE TARJETAS DE CRÉDITO -->
                        <div id="credit-card-summary-section" class="section-card space-y-4">
                            <h3 class="text-lg font-bold text-gray-700">Consumo de Tarjetas de Crédito</h3>
                            <div id="credit-card-summary-cards" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <!-- Las tarjetas de resumen de TC se renderizan aquí -->
                                <p class="text-gray-500 italic text-sm col-span-full">No hay tarjetas de crédito configuradas.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- COLUMNA 3: Balance de Cuentas (Siempre visible) -->
                    <div class="lg:col-span-1">
                        <div class="section-card h-full flex flex-col">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-bold text-indigo-700 flex items-center">
                                    <i class="fas fa-balance-scale mr-2"></i> Balance de Cuentas
                                </h2>
                            </div>
                            <div id="balance-content" class="mt-4 flex-grow flex flex-col justify-between">
                                <div id="shared-balance-summary" class="space-y-3 text-sm">
                                    <!-- Contenido del balance renderizado por JS -->
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <button id="liquidate-month-btn" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg hover:bg-red-700 transition duration-300">
                                        <i class="fas fa-handshake mr-2"></i> LIQUIDAR
                                    </button>
                                    <p class="text-xs text-gray-600 mt-2 text-center">Ajusta los saldos a cero.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- GRÁFICO DE DISTRIBUCIÓN DE GASTOS (Full Width) -->
                <div class="section-card">
                    <button id="toggle-chart-btn" class="w-full text-left flex justify-between items-center text-xl font-bold text-gray-700 mb-4 focus:outline-none">
                        Distribución de Gastos
                        <i id="chart-toggle-icon" class="fas fa-chevron-down transition-transform duration-300"></i>
                    </button>
                    <div id="chart-collapsible-content">
                        <div class="relative h-64 md:h-80 pt-2 border-t border-gray-200">
                            <canvas id="category-chart"></canvas>
                            <p id="chart-no-data" class="absolute inset-0 flex items-center justify-center text-gray-500 italic hidden">No hay datos para mostrar.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ========================================================================================= -->
            <!-- SECCIÓN 2: REGISTRO DE GASTO Y BOTONES DE CONFIGURACIÓN (100% ANCHO) -->
            <!-- ========================================================================================= -->
            <div class="max-w-7xl mx-auto px-4 md:px-8 pt-6">
                <main class="space-y-6">
                    <section class="section-card">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-red-700">Registrar Nuevo Gasto</h2>
                            
                            <!-- Botones de Configuración Rápida (Movidos aquí) -->
                            <div class="flex space-x-2">
                                <button id="open-categories-modal-btn" class="py-1 px-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition duration-300 text-xs">
                                    Categorías
                                </button>
                                <button id="open-payment-methods-modal-btn" class="py-1 px-3 bg-yellow-500 text-white font-bold rounded-xl hover:bg-yellow-600 transition duration-300 text-xs">
                                    Métodos Pago
                                </button>
                            </div>
                        </div>
                        <form id="expense-form" class="space-y-4">
                            
                            <!-- Fila 1: Descripción, Monto -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-2">
                                    <label for="expense-description" class="block text-sm font-medium text-gray-700">Descripción</label>
                                    <input type="text" id="expense-description" required class="w-full mt-1 custom-input">
                                </div>
                                <div>
                                    <label for="expense-amount" class="block text-sm font-medium text-gray-700">Monto (S/)</label>
                                    <input type="number" id="expense-amount" min="0.01" step="0.01" required class="w-full mt-1 custom-input">
                                </div>
                            </div>
                            
                            <!-- Fila 2: Pagador, Tipo de Gasto, Método de Pago -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Pagado Por (Custom Select) -->
                                <div>
                                    <label for="expense-paid-by-button" class="block text-sm font-medium text-gray-700">Pagado Por</label>
                                    <div class="relative custom-select-container mt-1">
                                        <button type="button" id="expense-paid-by-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            <span class="custom-select-display text-gray-500">Selecciona quién pagó</span>
                                            <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200"></i>
                                        </button>
                                        <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20 border border-gray-200">
                                            <!-- Opciones populadas por JS -->
                                        </div>
                                        <input type="hidden" id="expense-paid-by" required>
                                    </div>
                                </div>
                                <!-- Tipo de Gasto (Custom Select) -->
                                <div>
                                    <label for="expense-type-button" class="block text-sm font-medium text-gray-700">Tipo de Gasto</label>
                                    <div class="relative custom-select-container mt-1">
                                        <button type="button" id="expense-type-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            <span class="custom-select-display">Personal</span>
                                            <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200"></i>
                                        </button>
                                        <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20 border border-gray-200">
                                            <div class="custom-select-option selected" data-value="personal">Personal</div>
                                            <div class="custom-select-option" data-value="shared">Compartido</div>
                                        </div>
                                        <input type="hidden" id="expense-type" value="personal" required>
                                    </div>
                                </div>
                                <!-- Método de Pago (Custom Select) -->
                                <div>
                                    <label for="expense-payment-method-id-button" class="block text-sm font-medium text-gray-700">Método de Pago</label>
                                    <div class="relative custom-select-container mt-1">
                                        <button type="button" id="expense-payment-method-id-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            <span class="custom-select-display text-gray-500">Selecciona método</span>
                                            <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200"></i>
                                        </button>
                                        <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20 border border-gray-200">
                                            <!-- Opciones populadas por JS -->
                                        </div>
                                        <input type="hidden" id="expense-payment-method-id" required>
                                    </div>
                                </div>
                            </div>


                            <!-- Fila 3: Categoría y Subcategoría -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Categoría (Custom Select) -->
                                <div>
                                    <label for="expense-category-button" class="block text-sm font-medium text-gray-700">Categoría</label>
                                    <div class="relative custom-select-container mt-1">
                                        <button type="button" id="expense-category-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center">
                                            <span class="custom-select-display text-gray-500">Selecciona categoría</span>
                                            <i class="fas fa-chevron-down text-gray-400"></i>
                                        </button>
                                        <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20"></div>
                                        <input type="hidden" id="expense-category" required>
                                    </div>
                                </div>
                                <!-- Subcategoría (Custom Select) -->
                                <div>
                                    <label for="expense-subcategory-button" class="block text-sm font-medium text-gray-700">Subcategoría</label>
                                    <div class="relative custom-select-container mt-1">
                                        <button type="button" id="expense-subcategory-button" disabled class="custom-select-button w-full text-left custom-input bg-gray-100 flex justify-between items-center">
                                            <span class="custom-select-display text-gray-500">Selecciona subcategoría</span>
                                            <i class="fas fa-chevron-down text-gray-400"></i>
                                        </button>
                                        <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20"></div>
                                        <input type="hidden" id="expense-subcategory">
                                    </div>
                                </div>
                            </div>

                            <!-- Fila 4: Opciones y Botón de Añadir -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4 items-end">
                                <!-- Columna 1 y 2: Gasto Fijo y Recurrencia -->
                                <div class="flex items-end space-x-4 md:col-span-2">
                                    <div class="flex items-center h-12">
                                        <input id="expense-is-fixed" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="expense-is-fixed" class="ml-2 block text-sm font-medium text-gray-900">Gasto Fijo</label>
                                    </div>
                                    <div id="fixed-recurrence-container" class="hidden">
                                        <label for="fixed-recurrence-months" class="block text-sm font-medium text-red-700">Meses</label>
                                        <input type="number" id="fixed-recurrence-months" min="1" max="60" value="12" class="w-24 mt-1 custom-input">
                                    </div>
                                </div>
                                
                                <!-- Columna 3: Botón de Añadir Gasto -->
                                <div class="md:col-span-1">
                                    <button type="submit" class="w-full py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition duration-300">
                                        Añadir Gasto
                                    </button>
                                </div>
                            </div>

                            <!-- Información de Ciclo de Tarjeta de Crédito (Condicional) -->
                            <div id="credit-card-details" class="space-y-2 p-3 border border-yellow-300 rounded-lg bg-yellow-50 hidden">
                                <p class="font-bold text-xs text-yellow-800">Detalles de Facturación:</p>
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-700">Inicio de Ciclo: <strong id="cc-cycle-start-display" class="font-semibold"></strong></span>
                                    <span class="text-gray-700">Límite de Pago: <strong id="cc-payment-date-display" class="font-semibold"></strong></span>
                                </div>
                            </div>
                        </form>
                    </section>
                </main>
            </div>

            <!-- ========================================================================================= -->
            <!-- SECCIÓN 3: INFORMES (GASTOS FIJOS, CALENDARIO, HISTORIAL) -->
            <!-- ========================================================================================= -->
            <div class="max-w-7xl mx-auto px-4 md:px-8 mt-6">
                <section class="section-card space-y-6">
                    
                    <!-- Encabezado del Informe y Filtro de Mes -->
                    <div class="flex flex-col md:flex-row justify-between md:items-center pb-2 mb-4 gap-4">
                        <h2 class="text-xl font-bold text-gray-800">Informe de Gastos por Categoría</h2>
                        
                        <!-- Ciclo de Visualización -->
                        <div id="month-selector" class="flex items-center justify-between p-2 bg-gray-50 rounded-lg border border-gray-200 w-full max-w-xs md:max-w-sm">
                            <button id="prev-month-btn" class="p-2 bg-white rounded-lg hover:bg-gray-200 transition font-bold text-lg shadow-sm">
                                &lt;
                            </button>
                            <div class="text-center">
                                <h3 id="current-month-name" class="text-xl font-extrabold text-gray-800 leading-none">Cargando</h3>
                                <p id="current-year" class="text-sm text-gray-500 -mt-1">...</p>
                            </div>
                            <button id="next-month-btn" class="p-2 bg-white rounded-lg hover:bg-gray-200 transition font-bold text-lg shadow-sm">
                                &gt;
                            </button>
                        </div>
                    </div>

                    <!-- MODIFICADO: Contenedor para el botón de filtros y el popover -->
                    <div class="relative mb-4">
                        <!-- Botón para abrir/cerrar el popover de filtros -->
                        <button id="filter-popover-button" class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-filter mr-2"></i>
                            Filtros
                            <!-- Indicador visual si hay filtros activos -->
                            <span class="active-indicator ml-2 h-2 w-2 bg-indigo-500 rounded-full"></span>
                        </button>

                        <!-- El Popover de Filtros (inicialmente oculto) -->
                        <div id="filter-popover" class="absolute hidden mt-2 w-full max-w-md bg-white rounded-lg shadow-xl border border-gray-200 z-30 p-4 space-y-4">
                            <!-- Botón para cerrar el popover -->
                            <button id="close-filter-popover-btn" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                            <h4 class="text-lg font-semibold text-gray-800">Filtrar Transacciones</h4>
                            <!-- Área para mostrar etiquetas seleccionadas -->
                            <div id="selected-filter-tags" class="flex flex-wrap gap-1 border-b pb-2 mb-2 min-h-[2rem]">
                                <!-- Etiquetas seleccionadas se añadirán aquí -->
                                <span id="no-filters-label" class="text-xs text-gray-500 italic">No hay filtros aplicados.</span>
                            </div>
                            <!-- Filtro por descripción -->
                            <div>
                                <label for="filter-description" class="block text-xs font-medium text-gray-600 mb-1">Buscar por Descripción:</label>
                                <input type="text" id="filter-description" placeholder="Ej: Supermercado, Luz..." class="w-full mt-1 custom-input text-sm">
                            </div>
                            <!-- Filtro por etiquetas de Categoría -->
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Filtrar por Categoría:</label>
                                <div id="filter-tag-categories" class="flex flex-wrap -m-1">
                                    <!-- Etiquetas de categoría se generarán aquí -->
                                    <span class="text-xs text-gray-500 italic m-1">Cargando categorías...</span>
                                </div>
                            </div>
                            <!-- Filtro por etiquetas de Participante -->
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Filtrar por Pagador:</label>
                                <div id="filter-tag-participants" class="flex flex-wrap -m-1">
                                    <!-- Etiquetas de participante se generarán aquí -->
                                    <span class="text-xs text-gray-500 italic m-1">Cargando participantes...</span>
                                </div>
                            </div>
                            <!-- NUEVO: Filtro por etiquetas de Método de Pago -->
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Filtrar por Método de Pago:</label>
                                <div id="filter-tag-payment-methods" class="flex flex-wrap -m-1">
                                    <!-- Etiquetas de método de pago se generarán aquí -->
                                    <span class="text-xs text-gray-500 italic m-1">Cargando métodos...</span>
                                </div>
                            </div>
                            <button id="reset-filters-btn" class="w-full py-2 text-sm bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 mt-4">
                                Limpiar Filtros
                            </button>
                        </div>
                    </div>
                    <!-- FIN Contenedor Filtros/Popover -->

                    
                    <!-- Rejilla de Informes -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                        <!-- Columna 1 y 2: Historial de Transacciones -->
                        <div class="lg:col-span-2">
                            <div class="space-y-4">
                                <h3 class="text-xl font-bold text-gray-700">Historial de Transacciones</h3>
                                <span class="text-xs text-purple-600 font-semibold block -mt-2" id="expense-diagnostic"></span>
                                <div id="expense-report-by-category" class="space-y-3">
                                    <p class="text-gray-500 text-center py-4 italic">No hay gastos en este ciclo.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Columna 3 (1/3): Próximos Gastos Fijos -->
                        <aside class="lg:col-span-1">
                            <div class="section-card h-full">
                                <h3 class="text-lg font-bold text-red-700 mb-4 flex items-center">
                                    <i class="fas fa-calendar-alt mr-2"></i> Próximos Gastos Fijos
                                </h3>
                                <div id="fixed-expenses-summary" class="space-y-2 text-sm">
                                    <p class="text-gray-500 italic">No hay gastos fijos registrados.</p>
                                </div>
                            </div>
                        </aside>

                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- ========================================================================================= -->
    <!-- MODALES -->
    <!-- ========================================================================================= -->

    <!-- NUEVO: Modal de Importación de Datos -->
    <div id="import-json-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-[60]">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Importar/Restaurar Datos</h3>
            <p class="text-sm text-gray-600 mb-4">Pega el texto de respaldo (JSON) en el siguiente campo para restaurar tus datos. Esto sobrescribirá todos los datos del monedero actual.</p>
            <form id="import-json-form">
                <textarea id="json-input-area" class="w-full h-48 p-3 border rounded bg-gray-50 text-xs font-mono focus:ring-2 focus:ring-indigo-500" placeholder="Pega el texto JSON aquí..."></textarea>
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <button type="submit" id="confirm-import-btn" class="py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">
                        Confirmar Importación
                    </button>
                    <button type="button" id="cancel-import-btn" class="py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Mensajes -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-[70]">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4 text-gray-800" id="modal-title">Atención</h3>
            <p id="modal-text" class="mb-4 text-gray-600"></p>
            
            <!-- NUEVA ÁREA DE DETALLE DE ERROR -->
            <div id="modal-error-detail" class="bg-red-50 p-3 rounded-lg border border-red-200 mt-4 hidden">
                <p class="text-xs font-semibold text-red-700 mb-1">Detalle Técnico:</p>
                <code id="modal-error-code" class="text-xs text-red-600 break-words block"></code>
            </div>
            <!-- FIN NUEVA ÁREA DE DETALLE DE ERROR -->
            
            <button id="close-modal-btn" class="w-full py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition duration-300">Cerrar</button>
        </div>
    </div>
    
    <!-- Modal de Categorías -->
    <div id="categories-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
            <h3 class="text-2xl font-bold mb-4 text-green-700">Configuración de Categorías y Presupuestos</h3>
            <form id="category-form" class="space-y-3 mb-6 p-4 border border-green-200 rounded-lg bg-green-50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" id="category-name" placeholder="Nueva Categoría (Ej: Hogar)" required class="w-full custom-input">
                    <input type="number" id="category-budget" placeholder="Presupuesto Mensual (S/)" min="0" class="w-full custom-input">
                </div>
                <input type="text" id="subcategory-list" placeholder="Subcategorías (Separadas por coma: Servicios, Comida, ...)" class="w-full custom-input">
                <button type="submit" class="w-full py-2 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition duration-300">
                    Guardar Categoría
                </button>
            </form>
            
            <h4 class="font-bold text-gray-700 mb-3">Categorías Existentes:</h4>
            <div id="categories-display" class="space-y-2 max-h-64 overflow-y-auto">
                <p class="text-sm text-gray-500 italic" id="no-categories">No hay categorías definidas.</p>
                <!-- Categorías se cargan aquí -->
            </div>
            
            <button id="close-categories-modal-btn" class="w-full mt-6 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition duration-300">Cerrar</button>
        </div>
    </div>
    
    <!-- Modal de Métodos de Pago -->
    <div id="payment-methods-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
            <h3 class="text-2xl font-bold mb-4 text-yellow-700">Configuración de Métodos de Pago</h3>
            
            <h4 class="font-bold text-gray-700 mb-3">Métodos Existentes:</h4>
            <div id="payment-methods-display" class="space-y-2 mb-6 max-h-48 overflow-y-auto">
                <p class="text-sm text-gray-500 italic">No hay métodos definidos.</p>
                <!-- Métodos se cargan aquí con botón de edición -->
            </div>
            
            <h4 class="font-bold text-gray-700 mb-3" id="payment-form-title">Añadir Nuevo Método:</h4>
            <form id="payment-method-form" class="space-y-3 p-4 border border-yellow-200 rounded-lg bg-yellow-50">
                <input type="hidden" id="method-id-to-edit">
                <input type="text" id="method-name" placeholder="Nombre del Método (Ej: Visa Banco X)" required class="w-full custom-input">
                <select type="select" id="method-type" class="w-full p-2 border border-gray-300 rounded-lg bg-white" required>
                    <option value="cash">Efectivo/Débito</option>
                    <option value="credit">Tarjeta de Crédito</option>
                </select>
                
                <div id="cc-config-fields" class="space-y-3 hidden">
                    <h4 class="font-bold text-yellow-800">Configuración de Ciclo (Crédito)</h4>
                    <label for="cc-config-payment-day" class="block text-sm font-medium text-gray-700">Día Límite de Pago (1-31)</label>
                    <input type="number" id="cc-config-payment-day" min="1" max="31" placeholder="Ej: 5 (pagas el 5 de cada mes)" class="w-full custom-input">
                </div>
                
                <button type="submit" id="save-method-btn" class="w-full py-2 bg-yellow-500 text-white font-bold rounded-xl shadow-lg hover:bg-yellow-600 transition duration-300">
                    Añadir Método
                </button>
                <button type="button" id="cancel-edit-method-btn" class="w-full py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition duration-300 hidden">
                    Cancelar Edición
                </button>
            </form>
            
            <button id="close-payment-methods-modal-btn" class="w-full mt-6 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition duration-300">Cerrar</button>
        </div>
    </div>
    
    <!-- Modal de Añadir/Editar Participante -->
    <div id="add-participant-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-2xl font-bold mb-4 text-purple-700" id="participant-modal-title">Añadir Participante</h3>
            <form id="participant-form" class="space-y-4">
                <input type="hidden" id="participant-id-to-edit">
                
                <label for="p-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                <input type="text" id="p-name" required class="w-full custom-input">
                
                <label for="p-budget" class="block text-sm font-medium text-gray-700">Monto Total del Mes (S/)</label>
                <input type="number" id="p-budget" min="0" required class="w-full custom-input">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="p-shared-savings" class="block text-sm font-medium text-purple-700">Ahorro Mutuo (%):</label>
                        <input type="number" id="p-shared-savings" min="0" max="100" required class="w-full mt-1 custom-input">
                    </div>
                    <div>
                        <label for="p-independent-savings" class="block text-sm font-medium text-purple-700">Ahorro Indep. (%):</label>
                        <input type="number" id="p-independent-savings" min="0" max="100" required class="w-full mt-1 custom-input">
                    </div>
                </div>
                
                <button type="submit" id="save-participant-btn" class="w-full py-3 bg-purple-500 text-white font-bold rounded-xl hover:bg-purple-600 transition duration-300">
                    Guardar Participante
                </button>
            </form>
            <button id="close-participant-modal-btn" class="w-full mt-4 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition duration-300">Cerrar</button>
        </div>
    </div>

    <!-- Modal de Edición de Gasto -->
    <div id="edit-expense-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
            <h3 class="text-2xl font-bold mb-4 text-red-700">Editar Gasto</h3>
            <form id="edit-expense-form" class="space-y-4">
                <input type="hidden" id="edit-expense-id">
                
                <!-- Fila 1: Descripción y Monto -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label for="edit-expense-description" class="block text-sm font-medium text-gray-700">Descripción</label>
                        <input type="text" id="edit-expense-description" required class="w-full mt-1 custom-input">
                    </div>
                    <div>
                        <label for="edit-expense-amount" class="block text-sm font-medium text-gray-700">Monto (S/)</label>
                        <input type="number" id="edit-expense-amount" min="0.01" step="0.01" required class="w-full mt-1 custom-input">
                    </div>
                </div>

                <!-- Fila 2: Pagador, Tipo, Método de Pago -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="edit-expense-payer-button" class="block text-sm font-medium text-gray-700">Pagado Por</label>
                        <div class="relative custom-select-container mt-1">
                            <button type="button" id="edit-expense-payer-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center">
                                <span class="custom-select-display text-gray-500">Selecciona pagador</span>
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </button>
                            <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-30"></div>
                            <input type="hidden" id="edit-expense-payer">
                        </div>
                           <button type="button" id="add-guest-payer-btn" class="mt-2 w-full text-xs py-1 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">
                               + Añadir Invitado
                           </button>
                    </div>
                    <div>
                        <label for="edit-expense-type-button" class="block text-sm font-medium text-gray-700">Tipo de Gasto</label>
                        <div class="relative custom-select-container mt-1">
                            <button type="button" id="edit-expense-type-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center">
                                <span class="custom-select-display"></span>
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </button>
                            <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-30">
                                 <div class="custom-select-option" data-value="personal">Personal</div>
                                 <div class="custom-select-option" data-value="shared">Compartido</div>
                            </div>
                            <input type="hidden" id="edit-expense-type">
                        </div>
                    </div>
                    <div>
                        <label for="edit-expense-payment-method-id-button" class="block text-sm font-medium text-gray-700">Método de Pago</label>
                        <div class="relative custom-select-container mt-1">
                            <button type="button" id="edit-expense-payment-method-id-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center">
                                <span class="custom-select-display text-gray-500">Selecciona método</span>
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </button>
                            <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-30"></div>
                            <input type="hidden" id="edit-expense-payment-method-id">
                        </div>
                    </div>
                </div>
                <div id="guest-payer-input-container" class="hidden">
                             <label for="guest-payer-name" class="block text-sm font-medium text-gray-700">Nombre del Invitado</label>
                             <input type="text" id="guest-payer-name" class="w-full mt-1 custom-input">
                </div>

                <!-- Fila 3: Categoría y Subcategoría -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-expense-category-button" class="block text-sm font-medium text-gray-700">Categoría</label>
                         <div class="relative custom-select-container mt-1">
                              <button type="button" id="edit-expense-category-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center">
                                  <span class="custom-select-display text-gray-500">Selecciona categoría</span>
                                  <i class="fas fa-chevron-down text-gray-400"></i>
                              </button>
                              <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20"></div>
                              <input type="hidden" id="edit-expense-category" required>
                         </div>
                    </div>
                    <div>
                        <label for="edit-expense-subcategory-button" class="block text-sm font-medium text-gray-700">Subcategoría</label>
                        <div class="relative custom-select-container mt-1">
                            <button type="button" id="edit-expense-subcategory-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center">
                                <span class="custom-select-display text-gray-500">Selecciona subcategoría</span>
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </button>
                            <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20"></div>
                            <input type="hidden" id="edit-expense-subcategory">
                        </div>
                    </div>
                </div>
                
                    <!-- Checkbox Gasto Fijo -->
                <div class="flex items-center">
                    <input id="edit-expense-is-fixed" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="edit-expense-is-fixed" class="ml-2 block text-sm text-gray-900">Marcar como Gasto Fijo</label>
                </div>

                <button type="submit" class="w-full py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition duration-300 mt-4">
                    Guardar Cambios
                </button>
            </form>
            <button id="close-edit-expense-modal-btn" class="w-full mt-4 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition duration-300">Cerrar</button>
        </div>
    </div>
    
    <!-- Modal de Confirmación de Cierre de Sesión -->
    <div id="logout-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4 text-red-700">Confirmar Cierre de Sesión</h3>
            <p class="mb-6 text-gray-600">
                ¿Estás seguro de que quieres cerrar la sesión? Serás redirigido al portal de inicio de sesión.
            </p>
            <div class="grid grid-cols-2 gap-3">
                <button id="confirm-logout-btn" class="py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition">
                    Sí, Cerrar Sesión
                </button>
                <button id="cancel-logout-btn" class="py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition">
                    Cancelar
                </button>
            </div>
        </div>
    </div>


    <!-- Scripts de Firebase -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc, writeBatch, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        // ====================================================================================
        // --- CONFIGURACIÓN Y ESTADO GLOBAL ---
        // ====================================================================================
        
        const myFirebaseConfig = {
            apiKey: "AIzaSyA63OZWFM30Tu17DGxAmbtVsNFWeQU3k4s",
            authDomain: "qipu-d1dcd.firebaseapp.com",
            projectId: "qipu-d1dcd",
            storageBucket: "qipu-d1dcd.firebasestorage.app",
            messagingSenderId: "398775085739",
            appId: "1:398775085739:web:be8643b5d9fea9ef8da5ee",
        };

        const REDIRECT_URL_LOGOUT = 'index.html';

        const IS_CANVAS_ENV = typeof __initial_auth_token !== 'undefined';
        
        let firebaseConfig = IS_CANVAS_ENV 
            ? (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : myFirebaseConfig)
            : myFirebaseConfig;

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let userId = 'loading';
        let currentWalletId = null; 
        let isFirebaseActive = Object.keys(firebaseConfig).length > 0 && !Object.keys(firebaseConfig).some(k => firebaseConfig[k].startsWith('TU_')); 

        // --- NUEVAS RUTAS DE FIRESTORE ---
        const getUserProfileRef = (db, uid) => doc(db, 'artifacts', appId, 'users', uid);
        const getOldUserFinanceDocRef = (db, uid) => doc(db, 'artifacts', appId, 'users', uid, 'finance_tracker', 'main_finance_state');
        const getWalletDocRef = (db, walletId) => doc(db, 'artifacts', appId, 'public/data/wallets', walletId);
        const getWalletsCollectionRef = (db) => collection(db, 'artifacts', appId, 'public/data/wallets');
        
        const LOCAL_STORAGE_KEY = 'finance_tracker_local_data';

        const MONTH_NAMES = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        const DAY_NAMES = [
            'Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'
        ];

        let appState = {
            participants: [],
            categories: [],
            paymentMethods: [],
            expenses: []
        };
        
        let currentFilterDate = new Date();
        currentFilterDate.setDate(1); 
        
        let myParticipantId = null; 
        let unsubscribeListener = null;
        let categoryChart = null;

        // NUEVO: Estado para los filtros activos
        let activeFilters = {
             description: '',
             category: null, // Almacenará el nombre de la categoría
             participant: null, // Almacenará el ID del participante
             paymentMethod: null // NUEVO: Almacenará el ID del método de pago
        };


        // --- Utilidades ---
        const generateUUID = () => crypto.randomUUID();
        
        const showModal = (message, errorCode = null, title = "Atención") => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').innerHTML = message; // Use innerHTML to allow textarea
            
            const errorDetailEl = document.getElementById('modal-error-detail');
            const errorCodeEl = document.getElementById('modal-error-code');

            if (errorCode) {
                errorCodeEl.textContent = errorCode;
                errorDetailEl.classList.remove('hidden');
            } else {
                errorDetailEl.classList.add('hidden');
            }
            
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
            document.body.classList.add('no-scroll');
        };

        document.getElementById('close-modal-btn').addEventListener('click', () => {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-modal').classList.remove('flex');
            document.body.classList.remove('no-scroll');
        });
        
        const formatCurrency = (value) => new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        const formatDate = (isoString) => {
            if (!isoString) return '';
            const date = new Date(isoString + "T00:00:00Z"); // Use Z for UTC to avoid timezone issues with date-only strings
            return date.toLocaleDateString('es-ES', { day: '2-digit', timeZone: 'UTC' }); // Specify UTC timezone
        }
        const getFilterMonthString = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }
        
        // CORREGIDO: Lógica de cálculo de ciclo de tarjeta de crédito mejorada
 function getCycleDates(method, referenceDate) {
    if (method.type !== 'credit' || !method.paymentDay) {
        return { startDate: null, closingDate: null, paymentDate: null };
    }

    const paymentDay = method.paymentDay;
    const gracePeriodDays = 25; // Días entre cierre y pago

    const refYear = referenceDate.getUTCFullYear();
    const refMonth = referenceDate.getUTCMonth(); // 0 = Enero
    const refDay = referenceDate.getUTCDate();
    const referenceDateUTC = new Date(Date.UTC(refYear, refMonth, refDay));

    // Fecha de pago ESTE mes y fecha de cierre asociada
    let paymentDateThisMonth = new Date(Date.UTC(refYear, refMonth, paymentDay));
    let closingDateForThisMonthPay = new Date(paymentDateThisMonth.getTime());
    closingDateForThisMonthPay.setUTCDate(closingDateForThisMonthPay.getUTCDate() - gracePeriodDays);

    // Fecha de pago SIGUIENTE mes y fecha de cierre asociada
    let paymentDateNextMonth = new Date(Date.UTC(refYear, refMonth + 1, paymentDay));
    let closingDateForNextMonthPay = new Date(paymentDateNextMonth.getTime());
    closingDateForNextMonthPay.setUTCDate(closingDateForNextMonthPay.getUTCDate() - gracePeriodDays);

    let activeClosingDate;
    let cyclePaymentDate;

    // Determinar ciclo activo
    if (referenceDateUTC > closingDateForThisMonthPay) {
        // Si hoy es DESPUÉS del cierre asociado al pago de ESTE mes,
        // el ciclo activo es el que cierra ANTES del pago del SIGUIENTE mes.
        activeClosingDate = closingDateForNextMonthPay;
        cyclePaymentDate = paymentDateNextMonth;
    } else {
        // Si hoy es ANTES O IGUAL al cierre asociado al pago de ESTE mes,
        // el ciclo activo es el que cierra ANTES del pago de ESTE mes.
        activeClosingDate = closingDateForThisMonthPay;
        cyclePaymentDate = paymentDateThisMonth;
    }

    // Calcular fecha de inicio del ciclo activo
    let activeStartDate = new Date(activeClosingDate.getTime());
    activeStartDate.setUTCMonth(activeStartDate.getUTCMonth() - 1);
    activeStartDate.setUTCDate(activeStartDate.getUTCDate() + 1);

    const toISODateString = (date) => date.toISOString().split('T')[0];

    return {
        startDate: toISODateString(activeStartDate),
        closingDate: toISODateString(activeClosingDate),
        paymentDate: toISODateString(cyclePaymentDate)
    };
}


        // --- Funciones de Autenticación (REDUCIDAS) ---
        
        function openLogoutConfirmModal() {
            document.getElementById('logout-confirm-modal').classList.add('flex');
            document.getElementById('logout-confirm-modal').classList.remove('hidden');
        }

        function closeLogoutConfirmModal() {
            document.getElementById('logout-confirm-modal').classList.add('hidden');
             document.getElementById('logout-confirm-modal').classList.remove('flex');
        }
        
        document.getElementById('confirm-logout-btn').addEventListener('click', async () => {
            closeLogoutConfirmModal();
            try {
                if (unsubscribeListener) {
                    unsubscribeListener();
                    unsubscribeListener = null;
                }
                await signOut(auth);
                // La redirección la manejará onAuthStateChanged
            } catch (e) {
                showModal(`No se pudo cerrar la sesión: ${e.message}`, e.message, "Fallo al Cerrar Sesión");
            }
        });

        document.getElementById('cancel-logout-btn').addEventListener('click', closeLogoutConfirmModal);

        // --- Lógica de INICIALIZACIÓN y GESTIÓN DE MONEDERO ---
        async function initializeFirebase() {
            if (!isFirebaseActive) {
                loadLocalState();
                document.getElementById('auth-status').textContent = "⚠️ MODO LOCAL DE EMERGENCIA.";
                document.getElementById('initial-loading-screen').classList.add('hidden');
                document.getElementById('main-content-wrapper').classList.remove('hidden');
                setupUILogic(false);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    try { // <-- ADDED TRY BLOCK FOR ROBUSTNESS
                        // Si estamos en Canvas y no hay usuario, intentar logueo con token
                        if (IS_CANVAS_ENV && !user && initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                // El listener se volverá a ejecutar con el nuevo estado, así que salimos.
                                return; 
                            } catch (e) {
                                console.error("Fallo el inicio de sesión en Canvas:", e);
                                // Si falla, operar en modo local.
                                loadLocalState(); 
                                setupUILogic(false);
                                return;
                            }
                        }

                        // Si hay un usuario (de cualquier método), proceder.
                        if (user) {
                            userId = user.uid;
                            document.getElementById('current-user-id').innerHTML = `Mi UID: <strong>${userId}</strong>`;
                            
                            // Revisar si el usuario ya está en un monedero
                            const userProfileRef = getUserProfileRef(db, userId);
                            const userProfileSnap = await getDoc(userProfileRef);

                            if (userProfileSnap.exists() && userProfileSnap.data().walletId) {
                                // El usuario ya tiene un monedero, cargar datos
                                currentWalletId = userProfileSnap.data().walletId;
                                document.getElementById('initial-loading-screen').classList.add('hidden');
                                document.getElementById('main-content-wrapper').classList.remove('hidden');
                                setupUILogic(true);
                                setupRealTimeDataListener();
                            } else {
                                // Es un usuario nuevo o sin monedero, guiarlo a la configuración
                                document.getElementById('initial-loading-screen').classList.add('hidden');
                                document.getElementById('main-content-wrapper').classList.remove('hidden');
                                setupUILogic(true); 
                                updateWalletSidebarView(false); 
                                
                                const sidebar = document.getElementById('participant-sidebar');
                                if (!sidebar.classList.contains('open')) {
                                    const backdrop = document.getElementById('sidebar-backdrop');
                                    sidebar.classList.add('open');
                                    backdrop.classList.add('open');
                                    document.body.classList.add('no-scroll');
                                }
                                showModal("Bienvenido. Para empezar, crea un nuevo monedero o únete a uno existente.", null, "Primeros Pasos");
                            }
                        } else {
                            // Si NO hay usuario y NO estamos en Canvas, redirigir al login.
                            if (!IS_CANVAS_ENV) {
                                window.location.href = REDIRECT_URL_LOGOUT;
                            } else {
                                // Estado sin autenticación dentro de Canvas (modo local)
                                userId = 'anonymous_canvas';
                                loadLocalState();
                                document.getElementById('initial-loading-screen').classList.add('hidden');
                                document.getElementById('main-content-wrapper').classList.remove('hidden');
                                document.getElementById('connection-dot').classList.remove('sync-red');
                                document.getElementById('connection-dot').classList.add('sync-green');
                                document.getElementById('auth-status-text').textContent = '🌐 Sesión de Canvas Activa.';
                                setupUILogic(false);
                            }
                        }
                    } catch (error) { // <-- ADDED CATCH BLOCK
                        console.error("Error durante el cambio de estado de autenticación:", error);
                        showModal("Ocurrió un error al verificar tu sesión. Por favor, intenta recargar la página.", error.message, "Error de Autenticación");
                        document.getElementById('initial-loading-screen').classList.add('hidden');
                        document.getElementById('main-content-wrapper').classList.remove('hidden');
                        document.getElementById('connection-dot').classList.add('sync-red');
                        document.getElementById('connection-dot').classList.remove('sync-green');
                        document.getElementById('auth-status-text').textContent = 'Error de conexión.';}
                });
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                showModal("Error crítico al inicializar Firebase.", error.message, "Fallo de Conexión");
                loadLocalState(); 
                setupUILogic(false);
            }
        }
        
        function updateWalletSidebarView(hasWallet) {
            const preControls = document.getElementById('pre-wallet-controls');
            const postControls = document.getElementById('post-wallet-controls');
            if(hasWallet) {
                preControls.classList.add('hidden');
                postControls.classList.remove('hidden');
            } else {
                preControls.classList.remove('hidden');
                postControls.classList.add('hidden');
                // Chequear si hay datos viejos para migrar
                const migrationNotice = document.getElementById('migration-notice');
                const oldDataRef = getOldUserFinanceDocRef(db, userId);
                getDoc(oldDataRef).then(docSnap => {
                    if (docSnap.exists()) {
                        migrationNotice.classList.remove('hidden');
                    }
                });
            }
        }

        async function handleCreateWallet() {
            try {
                const newWalletRef = await addDoc(getWalletsCollectionRef(db), { createdAt: new Date().toISOString(), owner: userId });
                currentWalletId = newWalletRef.id;

                const defaultWalletState = {
                    participants: [],
                    categories: [],
                    paymentMethods: [{ id: 'm1', name: 'Efectivo', type: 'cash' }, { id: 'm2', name: 'Débito', type: 'cash' }],
                    expenses: []
                };

                let walletData;

                const oldDataRef = getOldUserFinanceDocRef(db, userId);
                const oldDataSnap = await getDoc(oldDataRef);

                if (oldDataSnap.exists()) {
                    // Migrar datos viejos, asegurando que todas las propiedades existan
                    walletData = { ...defaultWalletState, ...oldDataSnap.data() };
                    
                    // Asegurarse de que al menos un participante esté vinculado al usuario actual
                    const currentUserIsParticipant = walletData.participants.some(p => p.firebaseUid === userId);
                    if (!currentUserIsParticipant && walletData.participants.length > 0) {
                        walletData.participants[0].firebaseUid = userId;
                    } else if (walletData.participants.length === 0) {
                        // Si los datos migrados no tenían participantes, añadir al usuario actual.
                        walletData.participants.push({ id: generateUUID(), name: 'Yo', budget: 1000, sharedSavingsPercent: 10, independentSavingsPercent: 5, firebaseUid: userId });
                    }
                } else {
                    // Crear un monedero nuevo desde cero
                    walletData = { ...defaultWalletState };
                    walletData.participants.push({ id: generateUUID(), name: 'Yo', budget: 1000, sharedSavingsPercent: 10, independentSavingsPercent: 5, firebaseUid: userId });
                }
                
                const batch = writeBatch(db);
                batch.set(getWalletDocRef(db, currentWalletId), walletData); // Establecer datos en el nuevo monedero
                batch.set(getUserProfileRef(db, userId), { walletId: currentWalletId }); // Vincular usuario al monedero

                await batch.commit();
                
                // Cerrar sidebar y cargar la UI principal
                const sidebar = document.getElementById('participant-sidebar');
                const backdrop = document.getElementById('sidebar-backdrop');
                sidebar.classList.remove('open');
                backdrop.classList.remove('open');
                document.body.classList.remove('no-scroll');

                
                setupRealTimeDataListener();
            } catch (error) {
                console.error("Error al crear el monedero:", error);
                showModal("No se pudo crear el monedero. Revisa tu conexión y los permisos de la base de datos.", error.message, "Error Crítico");
            }
        }

        async function handleJoinWallet(e) {
            e.preventDefault();
            const walletIdToJoin = document.getElementById('join-wallet-id-input').value.trim();
            if (!walletIdToJoin) return;

            const walletRef = getWalletDocRef(db, walletIdToJoin);
            const walletSnap = await getDoc(walletRef);

            if (!walletSnap.exists()) {
                return showModal("El ID del monedero no es válido.", null, "Error al Unirse");
            }
            
            currentWalletId = walletIdToJoin;
            await setDoc(getUserProfileRef(db, userId), { walletId: currentWalletId });

            // Cerrar sidebar y cargar la UI principal
            const sidebar = document.getElementById('participant-sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');
            sidebar.classList.remove('open');
            backdrop.classList.remove('open');
            document.body.classList.remove('no-scroll');
            
            
            setupRealTimeDataListener();
        }

        function setupDataManagementListeners() {
            // --- Export Logic (no changes) ---
            document.getElementById('export-json-btn').addEventListener('click', () => {
                const jsonString = JSON.stringify(appState);
                const modalTextEl = document.getElementById('modal-text');
                
                showModal("Copia este texto. Es el respaldo completo de tus datos.", null, "Exportar Datos");
                
                modalTextEl.innerHTML = "Copia este texto. Es el respaldo completo de tus datos." + 
                `<textarea readonly class="w-full h-32 mt-2 p-2 border rounded bg-gray-100 text-xs font-mono">${jsonString}</textarea>`;
                
                modalTextEl.querySelector('textarea').select();
            });

            // --- Import Logic (New Modal System) ---
            const importModal = document.getElementById('import-json-modal');
            const importForm = document.getElementById('import-json-form');
            const jsonInputArea = document.getElementById('json-input-area');
            const cancelImportBtn = document.getElementById('cancel-import-btn');

            // Open the modal
            document.getElementById('restore-json-btn').addEventListener('click', () => {
                importModal.classList.remove('hidden');
                importModal.classList.add('flex');
            });

            // Close the modal
            cancelImportBtn.addEventListener('click', () => {
                importModal.classList.add('hidden');
                importModal.classList.remove('flex');
                jsonInputArea.value = ''; // Clear textarea
            });

            // Handle the import submission
            importForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const jsonString = jsonInputArea.value.trim();
                
                if (!jsonString) {
                    showModal("El campo de texto está vacío. Por favor, pega tus datos de respaldo.", null, "Error");
                    return;
                }

                try {
                    const importedState = JSON.parse(jsonString);
                    if (importedState && typeof importedState.participants !== 'undefined' && typeof importedState.expenses !== 'undefined') {
                        if (isFirebaseActive && db && currentWalletId) {
                            await setDoc(getWalletDocRef(db, currentWalletId), importedState);
                            
                            // Close import modal before showing success message
                            importModal.classList.add('hidden');
                            importModal.classList.remove('flex');
                            jsonInputArea.value = '';

                            showModal("Datos restaurados y sincronizados. La página se recargará.", null, "Restauración Completa");
                            setTimeout(() => window.location.reload(), 2000);
                        } else {
                             // Fallback for local mode
                            appState = importedState;
                            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appState));
                            renderUI();
                            showModal("Datos restaurados localmente.", null, "Restauración Completa");
                        }
                    } else {
                       throw new Error("El formato del JSON no es válido. Faltan propiedades esenciales (participants/expenses).");
                    }
                } catch (error) { 
                   showModal(`Error al procesar el JSON: ${error.message}`, error.stack, "Error de Importación"); 
                }
            });
        }

        function setupRealTimeDataListener() {
             if (!db || !currentWalletId) return;
             if (unsubscribeListener) unsubscribeListener();
             
            const docRef = getWalletDocRef(db, currentWalletId);
             
            unsubscribeListener = onSnapshot(docRef, docSnap => {
                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    
                    const defaultState = { participants: [], categories: [], paymentMethods: [], expenses: [] };
                    appState = { ...defaultState, ...loadedData };
                    
                    const linkedParticipant = appState.participants.find(p => p.firebaseUid === userId);
                    myParticipantId = linkedParticipant ? linkedParticipant.id : null;
                    
                    document.getElementById('share-wallet-id').value = currentWalletId;
                    document.getElementById('connection-dot').classList.remove('sync-red');
                    document.getElementById('connection-dot').classList.add('sync-green');
                    document.getElementById('auth-status-text').textContent = '✅ Conectado al monedero.';                    
                    updateWalletSidebarView(true); // Mostrar info del monedero actual
                    renderUI(); 
                } else {
                    // El monedero fue eliminado, forzar al usuario a crear/unirse de nuevo.
                    showModal("Este monedero ya no existe. Por favor, crea uno nuevo o únete a otro.", null, "Monedero no encontrado");
                    updateWalletSidebarView(false);
                }
            }, error => {
                console.error("Error en Firestore:", error);
                showModal("Error al cargar datos.", error.message, "Error de Datos");
            });
        }

        // --- Funciones de Soporte ---
        function loadLocalState() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                try {
                    const loadedData = JSON.parse(savedData);
                    appState = { ...appState, ...loadedData };
                } catch (e) { console.error("Error al cargar estado local:", e); }
            }
        }

        async function saveState(updates) {
            if (isFirebaseActive && db && currentWalletId) {
                try {
                    await updateDoc(getWalletDocRef(db, currentWalletId), updates);
                } catch (error) {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ ...appState, ...updates }));
                    showModal("Error al guardar en la nube. Se guardó localmente.", error.message, "Fallo de Guardado");
                }
            } else {
                appState = { ...appState, ...updates };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appState));
                renderUI(); 
            }
        }
        
        function linkParticipantToUser(participantId) {
            if (!userId || userId === 'anonymous_canvas' || userId === 'loading') {
                return showModal("Debes estar autenticado para vincular una cuenta.", null, "Acceso Denegado");
            }

            const newParticipants = appState.participants.map(p => {
                // Desvincular si este usuario ya estaba vinculado a otro participante
                if (p.firebaseUid === userId) p.firebaseUid = null;
                // Vincular al nuevo participante
                if (p.id === participantId) p.firebaseUid = userId;
                return p;
            });

            saveState({ participants: newParticipants });
            showModal("¡Cuenta vinculada exitosamente!", null, "Vinculación Exitosa");
        }

        // NUEVO: Función para configurar los listeners de los filtros dinámicos y el popover
        function setupDynamicFilterListeners() {
            const popoverButton = document.getElementById('filter-popover-button');
            const popover = document.getElementById('filter-popover');
            const closePopoverButton = document.getElementById('close-filter-popover-btn');
            const resetFiltersButton = document.getElementById('reset-filters-btn');
            const descriptionInput = document.getElementById('filter-description');
            const categoryTagsContainer = document.getElementById('filter-tag-categories');
            const participantTagsContainer = document.getElementById('filter-tag-participants');
            const paymentMethodTagsContainer = document.getElementById('filter-tag-payment-methods'); // NUEVO
            const selectedTagsContainer = document.getElementById('selected-filter-tags');

            // Abrir/Cerrar Popover
            popoverButton.addEventListener('click', (e) => {
                e.stopPropagation(); 
                popover.classList.toggle('hidden');
            });
            closePopoverButton.addEventListener('click', () => {
                popover.classList.add('hidden');
            });

            // Cerrar popover si se hace click fuera
            document.addEventListener('click', (e) => {
                 if (!popover.classList.contains('hidden') && !popover.contains(e.target) && e.target !== popoverButton && !popoverButton.contains(e.target)) {
                     popover.classList.add('hidden');
                 }
            });

            // Aplicar filtro de descripción al escribir
            descriptionInput.addEventListener('input', (e) => {
                activeFilters.description = e.target.value.toLowerCase();
                renderUI(); 
            }); 

            // Manejar clicks en las etiquetas de categoría
            categoryTagsContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.filter-tag.category-tag');
                if (target) {
                    const categoryName = target.dataset.value;
                    activeFilters.category = activeFilters.category === categoryName ? null : categoryName;
                    renderUI(); 
                }
            });

            // Manejar clicks en las etiquetas de participante
            participantTagsContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.filter-tag.participant-tag');
                 if (target) {
                    const participantId = target.dataset.value;
                    activeFilters.participant = activeFilters.participant === participantId ? null : participantId;
                    renderUI(); 
                }
            });
            
             // NUEVO: Manejar clicks en las etiquetas de método de pago
            paymentMethodTagsContainer.addEventListener('click', (e) => {
                 const target = e.target.closest('.filter-tag.payment-method-tag');
                 if (target) {
                    const methodId = target.dataset.value;
                    activeFilters.paymentMethod = activeFilters.paymentMethod === methodId ? null : methodId;
                    renderUI(); 
                }
             });

            // Botón para limpiar filtros
            resetFiltersButton.addEventListener('click', () => {
                 descriptionInput.value = ''; 
                 activeFilters.description = '';
                 activeFilters.category = null;
                 activeFilters.participant = null;
                 activeFilters.paymentMethod = null; // NUEVO
                 renderUI(); 
            });

             // MODIFICADO: Delegación para remover etiquetas seleccionadas
            selectedTagsContainer.addEventListener('click', (e) => {
                 const target = e.target.closest('.selected-tag-remove');
                 if(target) {
                     const filterType = target.dataset.type;
                     if(filterType === 'category') {
                         activeFilters.category = null;
                     } else if (filterType === 'participant') {
                         activeFilters.participant = null;
                     } else if (filterType === 'paymentMethod') { // NUEVO
                         activeFilters.paymentMethod = null;
                     }
                     renderUI();
                 }
            });
        }
        
        // MODIFICADO: Función para actualizar el estado visual del botón de filtros y las etiquetas seleccionadas
        function updateFilterUIState() {
            const popoverButton = document.getElementById('filter-popover-button');
            const selectedTagsContainer = document.getElementById('selected-filter-tags');
            const noFiltersLabel = document.getElementById('no-filters-label');
            
            const descActive = !!activeFilters.description; 
            const catActive = !!activeFilters.category;
            const partActive = !!activeFilters.participant;
            const pmActive = !!activeFilters.paymentMethod; // NUEVO
            const isActive = descActive || catActive || partActive || pmActive; // Modificado

            // Actualizar botón principal
            popoverButton.classList.toggle('active', isActive);
            popoverButton.classList.toggle('bg-indigo-100', isActive);
            popoverButton.classList.toggle('text-indigo-700', isActive);

            // Actualizar etiquetas seleccionadas en el popover
            selectedTagsContainer.innerHTML = ''; // Limpiar
            let hasSelectedTags = false;

             if (catActive) {
                selectedTagsContainer.insertAdjacentHTML('beforeend', `
                    <span class="filter-tag category-tag active">
                        ${activeFilters.category}
                        <button data-type="category" class="selected-tag-remove ml-1.5 text-indigo-100 hover:text-white">&times;</button>
                    </span>
                `);
                hasSelectedTags = true;
            }
             if (partActive) {
                 const participant = appState.participants.find(p => p.id === activeFilters.participant);
                 if (participant) {
                     selectedTagsContainer.insertAdjacentHTML('beforeend', `
                         <span class="filter-tag participant-tag active">
                             ${participant.name}
                             <button data-type="participant" class="selected-tag-remove ml-1.5 text-purple-100 hover:text-white">&times;</button>
                         </span>
                     `);
                     hasSelectedTags = true;
                 }
            }
             // NUEVO: Añadir etiqueta seleccionada para método de pago
             if (pmActive) {
                 const paymentMethod = appState.paymentMethods.find(m => m.id === activeFilters.paymentMethod);
                 if(paymentMethod) {
                     selectedTagsContainer.insertAdjacentHTML('beforeend', `
                         <span class="filter-tag payment-method-tag active">
                             ${paymentMethod.name}
                             <button data-type="paymentMethod" class="selected-tag-remove ml-1.5 text-green-100 hover:text-white">&times;</button>
                         </span>
                     `);
                     hasSelectedTags = true;
                 }
            }
            
            // Mostrar/ocultar el label "No hay filtros"
             if(noFiltersLabel) noFiltersLabel.classList.toggle('hidden', catActive || partActive || pmActive); // Modificado


            // Actualizar estado 'active' de las etiquetas clickeables en las listas
            document.querySelectorAll('#filter-tag-categories .filter-tag').forEach(tag => {
                 tag.classList.toggle('active', tag.dataset.value === activeFilters.category);
            });
            document.querySelectorAll('#filter-tag-participants .filter-tag').forEach(tag => {
                 tag.classList.toggle('active', tag.dataset.value === activeFilters.participant);
            });
             // NUEVO: Actualizar estado activo de etiquetas de método de pago
             document.querySelectorAll('#filter-tag-payment-methods .filter-tag').forEach(tag => {
                 tag.classList.toggle('active', tag.dataset.value === activeFilters.paymentMethod);
             });
            
             // Sincronizar el input de descripción con el estado (si fue limpiado por 'reset')
             const descriptionInput = document.getElementById('filter-description');
             if(descriptionInput && descriptionInput.value !== activeFilters.description) {
                 descriptionInput.value = activeFilters.description;
             }
        }


        function setupUILogic(isFirebaseMode) {
            const backdrop = document.getElementById('sidebar-backdrop');
            const participantSidebar = document.getElementById('participant-sidebar');
            const chartContent = document.getElementById('chart-collapsible-content');
            const chartToggleBtn = document.getElementById('toggle-chart-btn');
            const chartToggleIcon = document.getElementById('chart-toggle-icon');

            // 1. Lógica de Colapsado de Gráfico (Distribución de Gastos)
            chartContent.classList.remove('open'); // Cerrado por defecto (CSS lo maneja)
            chartToggleIcon.classList.remove('rotate-180');

            chartToggleBtn.addEventListener('click', () => {
                const isOpen = chartContent.classList.toggle('open');
                chartToggleIcon.classList.toggle('rotate-180', isOpen);
            });

            // Resto de Listeners de la UI principal
            setupCustomSelects();
            setupMonthSelectorListeners(); 
            setupCategoryModalListeners();
            setupPaymentMethodListeners();
            setupParticipantModalListeners(backdrop, participantSidebar); 
            setupExpenseFormListeners();
            setupExpenseModalListeners(); 
            setupLiquidateListeners(); 
            setupDynamicFilterListeners(); // Configura listeners del popover y filtros internos
            
            // CORREGIDO: Añadir listener para el botón de logout principal
            document.getElementById('logout-btn').addEventListener('click', openLogoutConfirmModal);

            // Listeners de la nueva lógica de monederos
            document.getElementById('copy-wallet-id-btn').addEventListener('click', () => {
                const walletIdInput = document.getElementById('share-wallet-id');
                walletIdInput.select();
                document.execCommand('copy');
                showModal('ID del monedero copiado al portapapeles.', null, 'Copiado');
            });
             document.getElementById('create-wallet-btn').addEventListener('click', handleCreateWallet);
            document.getElementById('join-wallet-form').addEventListener('submit', handleJoinWallet);
            
            if (!isFirebaseMode) renderUI(); 
        }

        // --- El resto de las funciones (render, cálculo, etc.) se mantienen mayormente sin cambios ---
        
        // CORREGIDO: Añadir más chequeos en setupCustomSelects
        function setupCustomSelects() {
            window.addEventListener('click', (e) => {
                document.querySelectorAll('.custom-select-container').forEach(container => {
                    if (!container.contains(e.target)) {
                        const optionsDiv = container.querySelector('.custom-select-options');
                        if (optionsDiv) optionsDiv.classList.add('hidden'); 
                        const chevronIcon = container.querySelector('.fa-chevron-down');
                        if (chevronIcon) chevronIcon.classList.remove('rotate-180');
                    }
                });
             });


            document.querySelectorAll('.custom-select-container').forEach(container => {
                const button = container.querySelector('.custom-select-button');
                const optionsContainer = container.querySelector('.custom-select-options');
                const chevron = button ? button.querySelector('.fa-chevron-down') : null; // Get chevron here
                
                if (!button || !optionsContainer) {
                    // console.warn('Custom select missing button or options container:', container);
                    return;
                }

                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Close other open selects
                    document.querySelectorAll('.custom-select-options').forEach(otherOptions => {
                        if (otherOptions !== optionsContainer) {
                            otherOptions.classList.add('hidden');
                            const parentContainer = otherOptions.closest('.custom-select-container');
                             if (parentContainer) {
                                 const otherChevron = parentContainer.querySelector('.fa-chevron-down');
                                 if (otherChevron) otherChevron.classList.remove('rotate-180');
                             }
                        }
                    });
                    
                    // Toggle current select
                    optionsContainer.classList.toggle('hidden');
                    if (chevron) chevron.classList.toggle('rotate-180'); // Use chevron variable
                });

                optionsContainer.addEventListener('click', (e) => {
                    const option = e.target.closest('.custom-select-option');
                    if (option) {
                        const hiddenInput = container.querySelector('input[type="hidden"]');
                        const display = button.querySelector('.custom-select-display');
                        
                        if (!hiddenInput || !display) return; // Chequeo adicional

                        display.textContent = option.textContent.trim();
                        display.classList.remove('text-gray-500');
                        hiddenInput.value = option.dataset.value;

                        optionsContainer.querySelectorAll('.custom-select-option').forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');

                        optionsContainer.classList.add('hidden');
                        if(chevron) chevron.classList.remove('rotate-180'); // Use chevron variable
                        hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                });
            });
        }
        
        function setupLiquidateListeners() {
            document.getElementById('liquidate-month-btn').addEventListener('click', liquidateMonth);
        }

        async function liquidateMonth() {
            if (!db || userId === 'loading') return showModal("La base de datos no está lista.");
            
            const { participantData, guestDebtTotal } = calculateSummary(appState, appState.expenses.filter(e => e.date.startsWith(getFilterMonthString(currentFilterDate))));
            const balances = participantData.filter(p => Math.abs(p.balance) > 0.01);
            if (balances.length === 0 && guestDebtTotal === 0) return showModal("Las cuentas ya están claras.", null, "Liquidación Completa");
            
            if (window.prompt(`Se crearán transacciones de ajuste. Escribe 'LIQUIDAR' para confirmar.`) !== 'LIQUIDAR') return showModal("Liquidación cancelada.");

            const newExpenses = [...appState.expenses];
            const now = new Date().toISOString().split('T')[0];
            let numSettlements = 0;

            const debtors = balances.filter(p => p.balance < 0).sort((a, b) => a.balance - b.balance); 
            const creditors = balances.filter(p => p.balance > 0).sort((a, b) => b.balance - a.balance); 

            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i], creditor = creditors[j];
                const amount = Math.min(Math.abs(debtor.balance), creditor.balance);

                if (amount > 0.01) {
                    newExpenses.push({ id: generateUUID(), type: 'personal', description: `REEMBOLSO: ${debtor.name} a ${creditor.name}`, amount, payerId: debtor.id, category: 'Liquidación', subcategory: 'Reembolso', paymentMethodId: 'm1', date: now, dateCreated: new Date().toISOString() });
                    numSettlements++;
                    debtor.balance += amount;
                    creditor.balance -= amount;
                }
                if (Math.abs(debtor.balance) < 0.01) i++;
                if (creditor.balance < 0.01) j++;
            }
            await saveState({ expenses: newExpenses });
            showModal(`¡Liquidación completada! Se crearon ${numSettlements} ajustes.`, null, "Liquidación Exitosa");
        }
        
        function setupParticipantModalListeners(backdrop, sidebar) {
            const modal = document.getElementById('add-participant-modal');
            const form = document.getElementById('participant-form');
            
            const toggleSidebar = (open) => {
                const sidebar = document.getElementById('participant-sidebar'); // Asegúrate de tener la referencia
                const appLayout = document.getElementById('app-layout');      // Referencia al layout principal
                sidebar.classList.toggle('open', open);
                appLayout.classList.toggle('sidebar-is-open', open);
                //backdrop.classList.toggle('open', open);
                //document.body.classList.toggle('no-scroll', open);
            };
            
            //document.getElementById('open-participants-sidebar-btn').addEventListener('click', () => toggleSidebar(true));
            document.getElementById('close-sidebar-btn').addEventListener('click', () => {
            // Obtiene el estado actual del sidebar
            const sidebar = document.getElementById('participant-sidebar');
            const isOpen = sidebar.classList.contains('open');

            // Llama a la función con el estado INVERSO para bascular
            toggleSidebar(!isOpen); 
            });
            backdrop.addEventListener('click', () => {
                if (sidebar.classList.contains('open')) {
                    toggleSidebar(false);
                }
            });

            document.getElementById('open-add-participant-modal-sidebar').addEventListener('click', () => {
                document.getElementById('participant-id-to-edit').value = '';
                document.getElementById('participant-modal-title').textContent = 'Añadir Participante';
                form.reset();
                modal.classList.add('flex');
                modal.classList.remove('hidden');
            });
            
            document.getElementById('close-participant-modal-btn').addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('participant-id-to-edit').value;
                const name = document.getElementById('p-name').value.trim();
                const budget = parseFloat(document.getElementById('p-budget').value) || 0;
                const ssa = parseFloat(document.getElementById('p-shared-savings').value) || 0;
                const isa = parseFloat(document.getElementById('p-independent-savings').value) || 0;

                if (ssa + isa > 100) return showModal("La suma de ahorros no puede superar el 100%.");

                if (id) {
                    const participants = appState.participants.map(p => p.id === id ? { ...p, name, budget, sharedSavingsPercent: ssa, independentSavingsPercent: isa } : p);
                    saveState({ participants });
                } else {
                    const newParticipant = { id: `p${generateUUID()}`, name, budget, sharedSavingsPercent: ssa, independentSavingsPercent: isa, firebaseUid: null };
                    saveState({ participants: [...appState.participants, newParticipant] });
                }
                modal.classList.add('hidden');
            });
        }

        function openParticipantEditModal(id) {
            const p = appState.participants.find(p => p.id === id);
            if (!p) return;
            document.getElementById('participant-id-to-edit').value = id;
            document.getElementById('participant-modal-title').textContent = `Editar Participante: ${p.name}`;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-budget').value = p.budget;
            document.getElementById('p-shared-savings').value = p.sharedSavingsPercent;
            document.getElementById('p-independent-savings').value = p.independentSavingsPercent;
            const modal = document.getElementById('add-participant-modal');
            modal.classList.add('flex');
            modal.classList.remove('hidden');
            document.body.classList.add('no-scroll');
        }

        function removeParticipant(id) {
            if (appState.participants.length <= 1) {
                return showModal("Debe haber al menos un participante.");
            }
             // NUEVO: Desactivar filtro si se elimina el participante activo
            if(activeFilters.participant === id) {
                activeFilters.participant = null;
            }
            const newParticipants = appState.participants.filter(p => p.id !== id);
            const newExpenses = appState.expenses.filter(e => e.payerId !== id);
            saveState({ participants: newParticipants, expenses: newExpenses });
            showModal(`Participante y sus gastos asociados eliminados.`);
        }

        function renderMonthSelector() {
            const monthNameEl = document.getElementById('current-month-name');
            const yearEl = document.getElementById('current-year');
            if (monthNameEl && yearEl) {
                monthNameEl.textContent = MONTH_NAMES[currentFilterDate.getMonth()];
                yearEl.textContent = currentFilterDate.getFullYear();
            }
        }

        function setupMonthSelectorListeners() {
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentFilterDate.setMonth(currentFilterDate.getMonth() - 1);
                renderUI();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentFilterDate.setMonth(currentFilterDate.getMonth() + 1);
                renderUI();
            });
        }
        
        function removeExpense(id) {
            const newExpenses = appState.expenses.filter(e => e.id !== id);
            saveState({ expenses: newExpenses });
            showModal('Gasto eliminado.');
        }

        function setupCategoryModalListeners() {
            const modal = document.getElementById('categories-modal');
            document.getElementById('open-categories-modal-btn').addEventListener('click', () => {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            });
            document.getElementById('close-categories-modal-btn').addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });
        
            document.getElementById('category-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('category-name').value.trim();
                const budget = parseFloat(document.getElementById('category-budget').value) || 0;
                const subcategoriesString = document.getElementById('subcategory-list').value.trim();
                if (!name) return;

                const subcategories = subcategoriesString ? subcategoriesString.split(',').map(s => s.trim()).filter(s => s) : [];
                const newCategories = [...appState.categories];
                const existingIndex = newCategories.findIndex(c => c.name.toLowerCase() === name.toLowerCase());

                if (existingIndex !== -1) {
                    newCategories[existingIndex].budget = budget;
                    newCategories[existingIndex].subcategories = Array.from(new Set([...newCategories[existingIndex].subcategories, ...subcategories]));
                } else {
                    newCategories.push({ name, subcategories, budget });
                }

                saveState({ categories: newCategories });
                showModal(`Categoría '${name}' guardada.`);
                e.target.reset();
            });
        }

        function setupPaymentMethodListeners() {
            const modal = document.getElementById('payment-methods-modal');
            document.getElementById('open-payment-methods-modal-btn').addEventListener('click', () => {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            });
            document.getElementById('close-payment-methods-modal-btn').addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                resetPaymentForm();
            });
            document.getElementById('method-type').addEventListener('change', (e) => {
                document.getElementById('cc-config-fields').classList.toggle('hidden', e.target.value !== 'credit');
            });
            document.getElementById('cancel-edit-method-btn').addEventListener('click', resetPaymentForm);

            document.getElementById('payment-method-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('method-id-to-edit').value;
                const name = document.getElementById('method-name').value.trim();
                const type = document.getElementById('method-type').value;
                const method = { name, type };

                if (type === 'credit') {
                    const paymentDay = parseInt(document.getElementById('cc-config-payment-day').value);
                    if (isNaN(paymentDay) || paymentDay < 1 || paymentDay > 31) {
                        return showModal("El día de pago para tarjetas de crédito debe ser válido (1-31).");
                    }
                    method.paymentDay = paymentDay;
                }

                let newMethods;
                if (id) {
                    newMethods = appState.paymentMethods.map(m => m.id === id ? { ...m, ...method } : m);
                } else {
                    method.id = `m${generateUUID()}`;
                    newMethods = [...appState.paymentMethods, method];
                }
                saveState({ paymentMethods: newMethods });
                modal.classList.add('hidden');
                resetPaymentForm();
            });
        }

        function setupExpenseFormListeners() {
            document.getElementById('expense-is-fixed').addEventListener('change', (e) => {
                document.getElementById('fixed-recurrence-container').classList.toggle('hidden', !e.target.checked);
            });

            document.getElementById('expense-category').addEventListener('change', (e) => {
                const categoryName = e.target.value;
                const subCatContainer = document.querySelector('#expense-subcategory-button').closest('.custom-select-container');
                const subCatOptions = subCatContainer.querySelector('.custom-select-options');
                const subCatDisplay = subCatContainer.querySelector('.custom-select-display');
                const subCatInput = subCatContainer.querySelector('input[type="hidden"]');
                const subCatButton = subCatContainer.querySelector('button');

                subCatOptions.innerHTML = '';
                subCatDisplay.textContent = 'Selecciona subcategoría';
                subCatInput.value = '';

                const selectedCategory = appState.categories.find(c => c.name === categoryName);
                if (selectedCategory && selectedCategory.subcategories.length > 0) {
                    selectedCategory.subcategories.forEach(sub => {
                        subCatOptions.insertAdjacentHTML('beforeend', `<div class="custom-select-option" data-value="${sub}">${sub}</div>`);
                    });
                    subCatButton.disabled = false;
                    subCatButton.classList.remove('bg-gray-100');
                } else {
                    subCatButton.disabled = true;
                    subCatButton.classList.add('bg-gray-100');
                }
            });

            document.getElementById('expense-payment-method-id').addEventListener('change', (e) => {
                const selectedMethodId = e.target.value;
                const method = appState.paymentMethods.find(m => m.id === selectedMethodId);
                const ccDetails = document.getElementById('credit-card-details');
                if (method && method.type === 'credit') {
                    ccDetails.classList.remove('hidden');
                    const { startDate, paymentDate } = getCycleDates(method, new Date()); // Usa la fecha actual para el formulario
                    document.getElementById('cc-cycle-start-display').textContent = formatDate(startDate);
                    document.getElementById('cc-payment-date-display').textContent = formatDate(paymentDate);
                } else {
                    ccDetails.classList.add('hidden');
                }
            });

            document.getElementById('expense-form').addEventListener('submit', (e) => {
                e.preventDefault();
                try {
                    const description = document.getElementById('expense-description').value.trim();
                    const amount = parseFloat(document.getElementById('expense-amount').value);
                    const payerId = document.getElementById('expense-paid-by').value;
                    const type = document.getElementById('expense-type').value;
                    const category = document.getElementById('expense-category').value;
                    const subcategory = document.getElementById('expense-subcategory').value;
                    const paymentMethodId = document.getElementById('expense-payment-method-id').value;
                    const isFixed = document.getElementById('expense-is-fixed').checked;

                    if (!description || !amount || !payerId || !category || !paymentMethodId) {
                        return showModal("Por favor, completa todos los campos requeridos.");
                    }

                    const paymentMethod = appState.paymentMethods.find(m => m.id === paymentMethodId);
                    const { startDate, paymentDate } = paymentMethod && paymentMethod.type === 'credit' ? getCycleDates(paymentMethod, new Date()) : {}; // Usa la fecha actual para el formulario
                    const fixedRecurrenceMonths = isFixed ? parseInt(document.getElementById('fixed-recurrence-months').value) || 1 : 0;

                    const newExpense = {
                        id: generateUUID(), description, amount, payerId, type, category, subcategory, paymentMethodId,
                        isFixed,
                        date: new Date().toISOString().split('T')[0],
                        dateCreated: new Date().toISOString(),
                        ccCycleStart: startDate || null,
                        ccPaymentDate: paymentDate || null,
                        fixedRecurrenceMonths,
                    };
                    saveState({ expenses: [...appState.expenses, newExpense] });
                    e.target.reset();
                    // Reiniciar la apariencia de los selects a su estado inicial
                    document.querySelectorAll('.custom-select-display').forEach(d => {
                        d.textContent = 'Selecciona una opción';
                        d.classList.add('text-gray-500');
                    });
                    document.querySelector('#expense-type-button .custom-select-display').textContent = 'Personal';
                } catch (error) {
                    showModal("Error al añadir el gasto.", error.message);
                }
            });
        }

        function setupExpenseModalListeners() {
            const modal = document.getElementById('edit-expense-modal');
            const guestContainer = document.getElementById('guest-payer-input-container');
            const guestInput = document.getElementById('guest-payer-name');

            document.getElementById('close-edit-expense-modal-btn').addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            document.getElementById('add-guest-payer-btn').addEventListener('click', () => {
                guestContainer.classList.toggle('hidden');
                
                const payerButton = document.getElementById('edit-expense-payer-button');
                const payerDisplay = payerButton.querySelector('.custom-select-display');
                const payerInput = document.getElementById('edit-expense-payer');

                payerInput.value = '';
                payerDisplay.textContent = 'Selecciona pagador';
                payerDisplay.classList.add('text-gray-500');

                if (!guestContainer.classList.contains('hidden')) {
                    guestInput.focus();
                }
            });
            
            document.getElementById('edit-expense-category').addEventListener('change', (e) => {
                const categoryName = e.target.value;
                const subCatContainer = document.querySelector('#edit-expense-subcategory-button').closest('.custom-select-container');
                const subCatOptions = subCatContainer.querySelector('.custom-select-options');
                const subCatDisplay = subCatContainer.querySelector('.custom-select-display');
                const subCatInput = subCatContainer.querySelector('input[type="hidden"]');
                const subCatButton = subCatContainer.querySelector('button');

                subCatOptions.innerHTML = '';
                subCatDisplay.textContent = 'Selecciona subcategoría';
                subCatInput.value = '';

                const selectedCategory = appState.categories.find(c => c.name === categoryName);
                if (selectedCategory && selectedCategory.subcategories.length > 0) {
                    selectedCategory.subcategories.forEach(sub => {
                        subCatOptions.insertAdjacentHTML('beforeend', `<div class="custom-select-option" data-value="${sub}">${sub}</div>`);
                    });
                    subCatButton.disabled = false;
                    subCatButton.classList.remove('bg-gray-100');
                } else {
                    subCatButton.disabled = true;
                    subCatButton.classList.add('bg-gray-100');
                }
            });

            document.getElementById('edit-expense-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-expense-id').value;
                const newDescription = document.getElementById('edit-expense-description').value.trim();
                const newAmount = parseFloat(document.getElementById('edit-expense-amount').value);
                const newCategory = document.getElementById('edit-expense-category').value;
                const newSubcategory = document.getElementById('edit-expense-subcategory').value;
                const newType = document.getElementById('edit-expense-type').value;
                const newPaymentMethodId = document.getElementById('edit-expense-payment-method-id').value;
                const newIsFixed = document.getElementById('edit-expense-is-fixed').checked;
                let newPayerId = document.getElementById('edit-expense-payer').value;
                let newPayerName = '';

                if (!guestContainer.classList.contains('hidden') && guestInput.value.trim()) {
                    newPayerId = `guest_${generateUUID()}`;
                    newPayerName = guestInput.value.trim();
                } else if (!newPayerId) {
                    return showModal("Selecciona un pagador o añade un invitado.");
                }

                if (newAmount <= 0 || !newDescription || !newCategory) {
                    return showModal("Completa todos los campos: descripción, monto, y categoría.");
                }

                const updatedExpenses = appState.expenses.map(exp => {
                    if (exp.id === id) {
                        return { 
                            ...exp, 
                            description: newDescription, 
                            amount: newAmount, 
                            category: newCategory, 
                            subcategory: newSubcategory,
                            type: newType,
                            isFixed: newIsFixed,
                            paymentMethodId: newPaymentMethodId,
                            payerId: newPayerId, 
                            payerNameGuest: newPayerName 
                        };
                    }
                    return exp;
                });

                saveState({ expenses: updatedExpenses });
                modal.classList.add('hidden');
            });
        }

        function calculateSummary(state, filteredExpenses) {
            const participants = state.participants;
            const participantData = participants.map(p => ({
                ...p,
                spent: 0,
                contributionPaid: 0,
                expectedContribution: 0,
                sharedSavingsGoal: (p.budget * p.sharedSavingsPercent) / 100,
                independentSavingsGoal: (p.budget * p.independentSavingsPercent) / 100,
                availableForSpending: p.budget * (1 - (p.sharedSavingsPercent + p.independentSavingsPercent) / 100)
            }));
            
            const participantMap = new Map(participantData.map(p => [p.id, p]));
            let totalSpent = 0;
            let guestDebtTotal = 0;

            filteredExpenses.forEach(expense => {
                const amount = expense.amount || 0;
                totalSpent += amount;
                const payer = participantMap.get(expense.payerId);
                if (payer) {
                    payer.contributionPaid += amount;
                }
                
                const isShared = expense.type === 'shared';

                if (isShared) { // Handle shared logic
                    const numPayees = expense.payerId.startsWith('guest_') ? participants.length + 1 : participants.length;
                    const splitAmount = amount / numPayees;
                    participantData.forEach(p => {
                        p.spent += splitAmount;
                    });
                    if (expense.payerId.startsWith('guest_')) {
                        guestDebtTotal += splitAmount;
                    }
                    expense.splitAmount = splitAmount;
                } else { // Handle personal logic
                     if (payer) {
                         payer.spent += amount;
                     }
                }
            });

            let globalTotalRemainingBudget = 0;
            let globalSharedSavingsGoal = 0;

            participantData.forEach(p => {
                p.balance = p.contributionPaid - p.spent;
                p.remainingBudget = p.availableForSpending - p.spent;
                globalTotalRemainingBudget += p.remainingBudget; // Simplified calculation
                globalSharedSavingsGoal += p.sharedSavingsGoal;
            });


            return {
                globalTotalRemainingBudget,
                globalSharedSavingsGoal,
                totalSpent,
                guestDebtTotal: Math.round(guestDebtTotal * 100) / 100,
                participantData,
            };
        }

        function animateNumber(elementId, finalValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            const currentValueText = element.textContent.replace(/[S/$,]/g, '').trim().replace(',', '.');
            const currentValue = parseFloat(currentValueText) || 0;
            const data = { value: currentValue };
            gsap.to(data, {
                value: finalValue,
                duration: 1.0,
                ease: "power2.out",
                onUpdate: () => {
                    element.textContent = formatCurrency(data.value);
                    element.classList.toggle('metric-spent', data.value < 0);
                    element.classList.toggle('metric-remaining', data.value >= 0);
                }
            });
        }

        function renderDashboard(summary) {
            animateNumber('display-remaining-budget', summary.globalTotalRemainingBudget);
            document.getElementById('display-total-spent').textContent = formatCurrency(summary.totalSpent);
            document.getElementById('display-shared-savings-goal').textContent = formatCurrency(summary.globalSharedSavingsGoal);
            
            const totalFixed = appState.expenses
                .filter(e => e.isFixed)
                .reduce((sum, exp) => sum + exp.amount, 0);
            document.getElementById('display-fixed-total').textContent = formatCurrency(totalFixed);
            
            const participantCardsEl = document.getElementById('participant-summary-cards');
            participantCardsEl.innerHTML = summary.participantData.map(p => {
                const summaryData = summary.participantData.find(pd => pd.id === p.id) || {};
                const remainingColor = p.remainingBudget < 0 ? 'text-red-600' : 'text-green-600';
                const personalFixedExpenses = appState.expenses
                    .filter(e => e.isFixed && e.type === 'personal' && e.payerId === p.id)
                    .reduce((sum, exp) => sum + exp.amount, 0);

                return `
                <div class="section-card p-4 flex flex-col justify-between">
                    <div>
                        <p class="text-sm font-semibold text-gray-700">${p.name}</p>
                        <div class="mt-1">
                            <p class="text-xs text-gray-500">Saldo Restante:</p>
                            <span class="text-xl font-bold ${remainingColor}">${formatCurrency(p.remainingBudget)}</span>
                        </div>
                    </div>
                    <div class="text-xs mt-3 pt-3 border-t space-y-1">
                          <div class="flex justify-between">
                              <span>Ahorro Personal:</span>
                              <strong class="text-teal-600">${formatCurrency(p.independentSavingsGoal)}</strong>
                          </div>
                          <div class="flex justify-between">
                              <span>Aporte Ahorro Mutuo:</span>
                              <strong class="text-purple-600">${formatCurrency(p.sharedSavingsGoal)}</strong>
                          </div>
                          <div class="flex justify-between">
                              <span>Gastos Fijos Pers.:</span>
                              <strong class="text-yellow-600">${formatCurrency(personalFixedExpenses)}</strong>
                          </div>
                          <div class="flex justify-between font-bold">
                              <span>Gasto Total:</span>
                              <strong class="text-red-600">${formatCurrency(p.spent)}</strong>
                          </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderParticipantsConfig(participants, summary) {
                const countBadge = document.getElementById('sidebar-participant-count');
                if (countBadge) {
                const count = participants.length;
                countBadge.textContent = count;
                // Muestra la insignia solo si hay más de 0 participantes
                countBadge.classList.toggle('show', count > 0);
            }

                const listEl = document.getElementById('participants-list');
                listEl.innerHTML = participants.map(p => {
                const summaryData = summary.participantData.find(pd => pd.id === p.id) || {};
                const balanceColor = summaryData.remainingBudget < 0 ? 'text-red-600' : 'text-green-600';
                
                let linkButtonHtml = '';
                const isLinkedToMe = p.firebaseUid === userId;
                const isLinkedToSomeoneElse = p.firebaseUid && p.firebaseUid !== userId;

                if (isLinkedToMe) {
                    linkButtonHtml = `<span class="text-xs text-green-700 font-bold flex items-center justify-center py-1 mt-2 bg-green-100 rounded-lg"><i class="fas fa-link mr-1"></i> Vinculado a ti</span>`;
                } else if (isLinkedToSomeoneElse) {
                    linkButtonHtml = `<span class="text-xs text-gray-700 font-bold flex items-center justify-center py-1 mt-2 bg-gray-100 rounded-lg"><i class="fas fa-user-lock mr-1"></i> Vinculado (otro)</span>`;
                } else if (userId && userId !== 'anonymous_canvas' && !myParticipantId) {
                    linkButtonHtml = `<button data-id="${p.id}" class="link-participant-btn w-full py-1 mt-2 bg-indigo-500 text-white text-xs font-bold rounded-lg hover:bg-indigo-600">Vincular mi Cuenta</button>`;
                }

                return `
                <div class="participant-card space-y-2 relative">
                    <button data-id="${p.id}" class="remove-participant-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1"><i class="fas fa-times"></i></button>
                    <h4 class="font-extrabold text-xl text-purple-900">${p.name}</h4>
                    <p class="text-sm text-gray-600">Presupuesto: <span class="font-semibold">${formatCurrency(p.budget)}</span></p>
                    <p class="text-lg font-extrabold border-t pt-2">Saldo: <span class="${balanceColor}">${formatCurrency(summaryData.remainingBudget)}</span></p>
                    ${linkButtonHtml}
                    <button data-id="${p.id}" class="edit-participant-btn w-full py-1 mt-2 bg-purple-400 text-white text-sm font-bold rounded-lg hover:bg-purple-500">Editar</button>
                </div>`;
            }).join('');

            listEl.querySelectorAll('.edit-participant-btn').forEach(btn => btn.addEventListener('click', e => openParticipantEditModal(e.currentTarget.dataset.id)));
            listEl.querySelectorAll('.remove-participant-btn').forEach(btn => btn.addEventListener('click', e => removeParticipant(e.currentTarget.dataset.id)));
            listEl.querySelectorAll('.link-participant-btn').forEach(btn => btn.addEventListener('click', e => linkParticipantToUser(e.currentTarget.dataset.id)));
            updateExpenseFormParticipants(participants);
            // MODIFICADO: Actualizar etiquetas de filtro de participantes
            updateDynamicFilterTagOptions();
        }

        // MODIFICADO: Poblar contenedores de etiquetas en el popover
        function updateDynamicFilterTagOptions() {
            const categoryTagsContainer = document.getElementById('filter-tag-categories');
            const participantTagsContainer = document.getElementById('filter-tag-participants');
            const paymentMethodTagsContainer = document.getElementById('filter-tag-payment-methods'); // NUEVO
            
            categoryTagsContainer.innerHTML = ''; // Limpiar
            participantTagsContainer.innerHTML = ''; // Limpiar
            paymentMethodTagsContainer.innerHTML = ''; // Limpiar

            // Añadir etiquetas de categoría
            if (appState.categories.length > 0) {
                appState.categories.forEach(cat => {
                    const isActive = activeFilters.category === cat.name;
                    categoryTagsContainer.insertAdjacentHTML('beforeend', 
                        `<button data-value="${cat.name}" class="filter-tag category-tag ${isActive ? 'active' : ''}">${cat.name}</button>`
                    );
                });
            } else {
                 categoryTagsContainer.innerHTML = '<span class="text-xs text-gray-500 italic m-1">No hay categorías.</span>';
            }

            // Añadir etiquetas de participante
            if (appState.participants.length > 0) {
                appState.participants.forEach(p => {
                    const isActive = activeFilters.participant === p.id;
                    participantTagsContainer.insertAdjacentHTML('beforeend', 
                        `<button data-value="${p.id}" class="filter-tag participant-tag ${isActive ? 'active' : ''}">${p.name}</button>`
                    );
                });
            } else {
                 participantTagsContainer.innerHTML = '<span class="text-xs text-gray-500 italic m-1">No hay participantes.</span>';
            }

             // NUEVO: Añadir etiquetas de método de pago
             if(appState.paymentMethods.length > 0) {
                 appState.paymentMethods.forEach(m => {
                     const isActive = activeFilters.paymentMethod === m.id;
                     paymentMethodTagsContainer.insertAdjacentHTML('beforeend', 
                         `<button data-value="${m.id}" class="filter-tag payment-method-tag ${isActive ? 'active' : ''}">${m.name}</button>`
                     );
                 });
             } else {
                 paymentMethodTagsContainer.innerHTML = '<span class="text-xs text-gray-500 italic m-1">No hay métodos de pago.</span>';
             }
        }


        function renderCategoriesModal(categories) {
            const displayEl = document.getElementById('categories-display');
            const optionsContainer = document.querySelector('#expense-category-button').nextElementSibling;
            const editCategoryOptions = document.querySelector('#edit-expense-category-button')?.nextElementSibling;

            displayEl.innerHTML = '';
            optionsContainer.innerHTML = '';
            if(editCategoryOptions) editCategoryOptions.innerHTML = '';

            if (categories.length === 0) {
                displayEl.innerHTML = '<p class="text-sm italic">No hay categorías definidas.</p>';
            } else {
                categories.forEach(cat => {
                    const budgetInfo = cat.budget > 0 ? `Presupuesto: ${formatCurrency(cat.budget)}` : 'Sin presupuesto';
                    displayEl.insertAdjacentHTML('beforeend', `
                    <div class="p-3 bg-white rounded-lg border flex justify-between items-start">
                        <div>
                            <span class="font-bold">${cat.name}</span>
                            <p class="text-xs text-gray-600">${budgetInfo}</p>
                            <p class="text-xs text-gray-500 mt-1">Subcategorías: ${cat.subcategories.join(', ') || 'Ninguna'}</p>
                        </div>
                        <button data-name="${cat.name}" class="remove-category-btn text-gray-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </div>`);
                    const optionHTML = `<div class="custom-select-option" data-value="${cat.name}">${cat.name}</div>`;
                    optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
                    if(editCategoryOptions) editCategoryOptions.insertAdjacentHTML('beforeend', optionHTML);
                });
                displayEl.querySelectorAll('.remove-category-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => removeCategory(e.currentTarget.dataset.name));
                });
            }
             // MODIFICADO: Actualizar etiquetas de filtro de categorías
            updateDynamicFilterTagOptions();
        }

        function removeCategory(nameToRemove) {
            // NUEVO: Desactivar filtro si se elimina la categoría activa
            if(activeFilters.category === nameToRemove) {
                activeFilters.category = null;
            }
            saveState({ categories: appState.categories.filter(c => c.name !== nameToRemove) });
        }

        function openExpenseEditModal(expenseId) {
            const expense = appState.expenses.find(e => e.id === expenseId);
            if (!expense) return;
            const modal = document.getElementById('edit-expense-modal');

            document.getElementById('edit-expense-id').value = expense.id;
            document.getElementById('edit-expense-description').value = expense.description;
            document.getElementById('edit-expense-amount').value = expense.amount;
            document.getElementById('edit-expense-is-fixed').checked = expense.isFixed;

            const setCustomSelect = (type, value) => {
                const button = document.getElementById(`edit-expense-${type}-button`);
                if (!button) return;
                const display = button.querySelector('.custom-select-display');
                const input = document.getElementById(`edit-expense-${type}`);
                if (!input) return;

                const optionsContainer = button.nextElementSibling;
                // CORREGIDO: Asegurarse que optionsContainer existe antes de buscar dentro
                if (!optionsContainer) return; 
                const option = Array.from(optionsContainer.querySelectorAll('.custom-select-option')).find(opt => opt.dataset.value === value);
                
                display.textContent = option ? option.textContent.trim() : `Seleccionar`;
                display.classList.toggle('text-gray-500', !option);
                input.value = value;
                
                optionsContainer.querySelectorAll('.custom-select-option').forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.value === value);
                });
            };

            setCustomSelect('payer', expense.payerId);
            setCustomSelect('type', expense.type);
            setCustomSelect('payment-method-id', expense.paymentMethodId);
            
            const categoryInput = document.getElementById('edit-expense-category');
            setCustomSelect('category', expense.category);
            // Asegurarse que categoryInput existe antes de disparar evento
            if (categoryInput) categoryInput.dispatchEvent(new Event('change', { bubbles: true })); 

            setTimeout(() => {
                setCustomSelect('subcategory', expense.subcategory);
            }, 0);

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // NUEVA FUNCIÓN CLAVE PARA INICIALIZAR SELECTS
        function initializeCustomSelect(containerId) {
            const container = document.getElementById(containerId).closest('.custom-select-container');
            if (!container) return;
            
            const button = container.querySelector('.custom-select-button');
            const optionsContainer = container.querySelector('.custom-select-options');
            const hiddenInput = container.querySelector('input[type="hidden"]');
            const display = button?.querySelector('.custom-select-display');

            if (!button || !optionsContainer || !hiddenInput || !display) return;
            
            // 1. Encontrar todas las opciones disponibles
            const options = Array.from(optionsContainer.querySelectorAll('.custom-select-option'));

            // 2. Si hay opciones y el input está vacío, auto-seleccionar la primera opción
            if (options.length > 0 && !hiddenInput.value) {
                const firstOption = options[0];
                hiddenInput.value = firstOption.dataset.value;
                display.textContent = firstOption.textContent.trim();
                display.classList.remove('text-gray-500');
                
                options.forEach(opt => opt.classList.remove('selected'));
                firstOption.classList.add('selected');
            } else if (options.length > 0 && hiddenInput.value) {
                // 3. Si hay un valor, asegurar que la UI lo refleje y esté seleccionado
                const selectedOption = options.find(opt => opt.dataset.value === hiddenInput.value);
                if (selectedOption) {
                    display.textContent = selectedOption.textContent.trim();
                    display.classList.remove('text-gray-500');
                    options.forEach(opt => opt.classList.remove('selected'));
                    selectedOption.classList.add('selected');
                }
            } else if (options.length === 0) {
                 // 4. Si no hay opciones, resetear el display
                 hiddenInput.value = '';
                 display.textContent = 'Selecciona una opción';
                 display.classList.add('text-gray-500');
            }
            
            // 5. Disparar evento change si hay un valor, por si necesita actualizar otro select (ej. Categoría -> Subcategoría)
            if (hiddenInput.value) {
                 hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
        // FIN NUEVA FUNCIÓN CLAVE

        function updateExpenseFormParticipants(participants) {
            const payerOptions = document.querySelector('#expense-paid-by-button').nextElementSibling;
            const editPayerOptions = document.querySelector('#edit-expense-payer-button').nextElementSibling;
            // CORRECCION: Verificar si los elementos existen
            if (!payerOptions || !editPayerOptions) return; 
            payerOptions.innerHTML = '';
            editPayerOptions.innerHTML = '';
            participants.forEach(p => {
                const optionHtml = `<div class="custom-select-option" data-value="${p.id}">${p.name}</div>`;
                payerOptions.insertAdjacentHTML('beforeend', optionHtml);
                editPayerOptions.insertAdjacentHTML('beforeend', optionHtml);
            });
            // NOTA: La inicialización se movió a renderUI para manejar el estado completo.
        }

        function resetPaymentForm() {
            document.getElementById('payment-method-form').reset();
            document.getElementById('method-id-to-edit').value = '';
            document.getElementById('cc-config-fields').classList.add('hidden');
            document.getElementById('payment-form-title').textContent = 'Añadir Nuevo Método:';
            document.getElementById('save-method-btn').textContent = 'Añadir Método';
            document.getElementById('cancel-edit-method-btn').classList.add('hidden');
        }

        function openPaymentMethodEditModal(id) {
            const method = appState.paymentMethods.find(m => m.id === id);
            if (!method) return;
            resetPaymentForm();
            document.getElementById('method-id-to-edit').value = id;
            document.getElementById('method-name').value = method.name;
            document.getElementById('method-type').value = method.type;
            document.getElementById('payment-form-title').textContent = `Editar: ${method.name}`;
            document.getElementById('save-method-btn').textContent = 'Guardar Cambios';
            document.getElementById('cancel-edit-method-btn').classList.remove('hidden');
            if (method.type === 'credit') {
                document.getElementById('cc-config-fields').classList.remove('hidden');
                document.getElementById('cc-config-payment-day').value = method.paymentDay;
            }
        }

        function removePaymentMethod(idToRemove) {
            if (['m1', 'm2'].includes(idToRemove)) return showModal("No puedes eliminar los métodos de pago predeterminados.");
            // NUEVO: Desactivar filtro si se elimina el método activo
            if(activeFilters.paymentMethod === idToRemove) {
                activeFilters.paymentMethod = null;
            }
            saveState({ paymentMethods: appState.paymentMethods.filter(m => m.id !== idToRemove) });
        }

        function renderPaymentMethodsModal(methods) {
            const displayEl = document.getElementById('payment-methods-display');
            const optionsContainer = document.querySelector('#expense-payment-method-id-button').nextElementSibling;
            const editOptionsContainer = document.querySelector('#edit-expense-payment-method-id-button').nextElementSibling;
            
            displayEl.innerHTML = '';
             // CORRECCION: Verificar si los elementos existen
            if (optionsContainer) optionsContainer.innerHTML = ''; 
            if(editOptionsContainer) editOptionsContainer.innerHTML = '';

            methods.forEach(m => {
                const details = m.type === 'credit' ? `Pago: Día ${m.paymentDay}` : 'Transacción inmediata.';
                displayEl.insertAdjacentHTML('beforeend', `
                <div class="p-3 bg-white border flex justify-between items-center">
                    <div><span class="font-bold">${m.name}</span><p class="text-xs text-gray-600">${details}</p></div>
                    <div class="flex space-x-2">
                        <button data-id="${m.id}" class="edit-method-btn text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button>
                        ${!['m1', 'm2'].includes(m.id) ? `<button data-id="${m.id}" class="remove-method-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                </div>`);
                const optionHTML = `<div class="custom-select-option" data-value="${m.id}">${m.name}</div>`;
                if (optionsContainer) optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
                if(editOptionsContainer) editOptionsContainer.insertAdjacentHTML('beforeend', optionHTML);
            });

            displayEl.querySelectorAll('.remove-method-btn').forEach(btn => btn.addEventListener('click', e => removePaymentMethod(e.currentTarget.dataset.id)));
            displayEl.querySelectorAll('.edit-method-btn').forEach(btn => btn.addEventListener('click', e => openPaymentMethodEditModal(e.currentTarget.dataset.id)));
             // NUEVO: Actualizar etiquetas de filtro de método de pago
            updateDynamicFilterTagOptions();
            // NOTA: La inicialización se movió a renderUI
        }

        // MODIFICADO: Adaptar a la nueva estructura de tarjeta de historial (más limpio y visual)
        // ===== PEGA ESTE CÓDIGO COMPLETO PARA REEMPLAZAR LA FUNCIÓN ANTIGUA =====
            function createExpenseCardHTML(expense, participantsMap, paymentMethodsMap, showAmount = true) {
                let payerName = participantsMap.get(expense.payerId) || expense.payerNameGuest || 'Desconocido';
                const paymentMethod = paymentMethodsMap.get(expense.paymentMethodId);
                const isShared = expense.type === 'shared';
                const isFixed = expense.isFixed;
                let amountColorClass = isShared ? 'text-red-600' : 'text-blue-600';

                const dateObj = new Date(expense.date + "T00:00:00Z");
                const dayNum = dateObj.getUTCDate();
                const dayName = DAY_NAMES[dateObj.getUTCDay()];

                const subcategoryLabel = expense.subcategory ? ` (${expense.subcategory})` : '';
                const typeLabel = isFixed ? 'Gasto Fijo' : (isShared ? 'Compartido' : 'Personal');

                let typeIcon = isFixed ? 'fas fa-thumbtack text-purple-500' : (isShared ? 'fas fa-users text-red-500' : 'fas fa-user text-blue-500');

                const categoryTag = expense.category ? `<span class="expense-card-tag category">${expense.category}</span>` : '';
                const paymentMethodTag = paymentMethod ? `<span class="expense-card-tag payment-method">${paymentMethod.name}</span>` : '';
                const tagsHTML = `<div class="mt-1">${categoryTag}${paymentMethodTag}</div>`;

                let detailContent = '';
                if (isShared) {
                    const splitAmount = expense.splitAmount || (appState.participants.length > 0 ? expense.amount / appState.participants.length : expense.amount);
                    let balanceTags = appState.participants.map(p => {
                        if (p.id !== expense.payerId) {
                            return `<span class='inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 mr-1'>${p.name}: Debe ${formatCurrency(splitAmount)}</span>`;
                        }
                        return '';
                    }).join('');
                    detailContent = `<p class="text-xs font-semibold text-gray-700 mb-2 border-t pt-2 mt-2">Repartición (${appState.participants.length} personas):</p><div class='flex flex-wrap gap-1 mb-1'>${balanceTags}</div>`;
                }

                const detailSectionHTML = `
                    <div id='detail-${expense.id}' class='expense-detail ${isShared ? 'hidden' : ''}'>
                        <div class='mt-1'>
                            ${detailContent}
                        </div>
                    </div>`;

                const actionButtonsHTML = `
                    <div class='flex gap-4 mt-2 pt-2 border-t border-dashed border-gray-200 justify-end'>
                        <button data-id='${expense.id}' class='edit-expense-btn text-gray-500 hover:text-blue-500 text-xs font-bold flex items-center gap-1'><i class='fas fa-edit'></i> Editar</button>
                        <button data-id='${expense.id}' class='delete-btn text-gray-500 hover:text-red-500 text-xs font-bold flex items-center gap-1'><i class='fas fa-trash'></i> Eliminar</button>
                    </div>`;

                // Estructura final de la tarjeta SIN comentarios internos
                return `
                <div class='history-card' data-expense-id='${expense.id}'>
                    <div class='history-date-col'>
                        <span class='history-day-name'>${dayName}</span>
                        <span class='history-day-num'>${dayNum}</span>
                    </div>

                    <div class='history-content-col'>
                        <div class='flex items-center space-x-2 ${isShared ? "expense-header cursor-pointer" : ""}' ${isShared ? `data-toggle='${expense.id}'` : ""}>
                            <i class="${typeIcon} text-lg flex-shrink-0"></i>
                            <p class='font-bold text-gray-800 flex-1 min-w-0 truncate'>${expense.description}${subcategoryLabel}</p>
                            ${isShared ? '<i class="fas fa-chevron-down text-gray-400 text-xs ml-auto transition-transform duration-200"></i>' : ''}
                        </div>

                        ${tagsHTML}
                        <p class='text-xs text-gray-500 mt-1'>Pagado por: <strong class="font-semibold text-gray-700">${payerName}</strong></p>

                        ${isShared ? detailSectionHTML : ''}

                        ${actionButtonsHTML}
                    </div>

                    <div class='history-amount-col'>
                        <p class='text-xl font-extrabold ${amountColorClass}'>${formatCurrency(expense.amount)}</p>
                        <p class='text-xs text-gray-500 mt-1'>${typeLabel}</p>
                    </div>
                </div>`;
            }
    // ===== FIN DEL CÓDIGO A PEGAR =====

        // MODIFICADO: Aplicar filtros antes de renderizar el reporte y añadir la barra de progreso de presupuesto.
        function renderExpenseReportByCategory(allExpensesInMonth, summary) {
            const reportEl = document.getElementById('expense-report-by-category');
            reportEl.innerHTML = '';
            
            // Obtener valores de los filtros desde el estado global `activeFilters`
            const descriptionFilter = activeFilters.description;
            const categoryFilter = activeFilters.category;
            const participantFilter = activeFilters.participant;
            const paymentMethodFilter = activeFilters.paymentMethod; // NUEVO

            // Filtrar los gastos
            let filteredExpenses = allExpensesInMonth;

            if (descriptionFilter) {
                filteredExpenses = filteredExpenses.filter(e => 
                    e.description.toLowerCase().includes(descriptionFilter) || 
                    (e.subcategory && e.subcategory.toLowerCase().includes(descriptionFilter))
                );
            }
            // CORRECCIÓN CLAVE: Aplicar los filtros de forma más robusta
            if (categoryFilter) {
                filteredExpenses = filteredExpenses.filter(e => e.category === categoryFilter);
            }
            if (participantFilter) {
                filteredExpenses = filteredExpenses.filter(e => e.payerId === participantFilter);
            }
            if (paymentMethodFilter) {
                 filteredExpenses = filteredExpenses.filter(e => e.paymentMethodId === paymentMethodFilter);
            }
            
            // Actualizar diagnóstico con el número de gastos *después* de filtrar
             document.getElementById('expense-diagnostic').textContent = `Mostrando ${filteredExpenses.length} de ${allExpensesInMonth.length} gastos en este ciclo.`;


            if (filteredExpenses.length === 0) {
                reportEl.innerHTML = `<p class='text-gray-500 text-center py-8 italic'>No hay gastos que coincidan con los filtros aplicados.</p>`;
                return;
            }
            
            const participantsMap = new Map(appState.participants.map(p => [p.id, p.name]));
            const paymentMethodsMap = new Map(appState.paymentMethods.map(m => [m.id, m]));
            
            const groupedExpenses = filteredExpenses.reduce((acc, expense) => {
                const category = expense.category || 'Sin Categoría';
                if (!acc[category]) acc[category] = [];
                acc[category].push(expense);
                return acc;
            }, {});

            Object.keys(groupedExpenses).sort().forEach(categoryName => {
                const expenses = groupedExpenses[categoryName];
                const categoryTotal = expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const categoryConfig = appState.categories.find(c => c.name === categoryName);
                const budget = categoryConfig?.budget || 0;

                // Generar un ID único para el contenido colapsable
                const contentId = `category-content-${categoryName.replace(/[^a-zA-Z0-9]/g, '-')}-${Date.now()}`;

                // --- Lógica de Barra de Presupuesto ---
                const remaining = budget - categoryTotal;
                const percentUsed = budget > 0 ? (categoryTotal / budget) * 100 : 0;
                const barWidth = Math.min(100, percentUsed);
                let barColor = 'bg-indigo-500';
                let statusText = budget > 0 ? `Presupuesto: ${formatCurrency(budget)}` : 'Gasto total en esta categoría.';
                let statusTextColor = 'text-gray-600';

                if (budget > 0) {
                    if (percentUsed > 100) {
                        barColor = 'bg-red-500';
                        statusText = `<i class="fas fa-exclamation-triangle mr-1"></i> ¡Excedido por ${formatCurrency(Math.abs(remaining))}!`;
                        statusTextColor = 'text-red-600 font-semibold';
                    } else if (percentUsed > 80) {
                        barColor = 'bg-yellow-500';
                        statusText = `Quedan ${formatCurrency(remaining)} / ${formatCurrency(budget)}.`;
                        statusTextColor = 'text-yellow-600';
                    } else {
                        barColor = 'bg-green-500';
                        statusText = `Quedan ${formatCurrency(remaining)} / ${formatCurrency(budget)}.`;
                        statusTextColor = 'text-green-600';
                    }
                }

                const budgetTrackerHTML = budget > 0 ? `
                    <div class="mt-2 mb-3 space-y-1">
                        <p class="text-xs ${statusTextColor}">${statusText}</p>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill ${barColor}" style="width: ${barWidth}%;"></div>
                        </div>
                    </div>
                ` : `<p class="text-xs text-gray-500 mt-1 mb-3">Gasto total en esta categoría.</p>`;
                // --- Fin Lógica Barra Presupuesto ---

                // Crear el contenedor principal para la categoría
                const categoryContainer = document.createElement('div');
                categoryContainer.className = "bg-gray-50 p-4 rounded-xl border mb-3"; // Separador entre categorías

                // Crear el HTML del encabezado (será un botón)
                const headerHTML = `
                    <button class='category-toggle-btn w-full text-left flex justify-between items-center pb-2 border-b' data-target-id="${contentId}">
                        <h4 class='text-lg font-bold text-gray-700'>${categoryName}</h4>
                        <div class="flex items-center">
                            <span class='font-semibold mr-3'>${formatCurrency(categoryTotal)}</span>
                            <i class="category-chevron fas fa-chevron-down text-gray-400 text-sm transition-transform duration-300"></i>
                        </div>
                    </button>
                `;

                // Crear el HTML del contenido (lo que se va a ocultar/mostrar)
                const contentHTML = `
                    <div id="${contentId}" class="category-collapsible-content">
                        ${budgetTrackerHTML}
                        <div class='space-y-3 mt-3'>
                            ${expenses.sort((a,b) => new Date(b.dateCreated || b.date + "T00:00:00Z") - new Date(a.dateCreated || a.date + "T00:00:00Z")).map(exp => createExpenseCardHTML(exp, participantsMap, paymentMethodsMap, true)).join('')}
                        </div>
                    </div>
                `;

                // Junta el encabezado y el contenido en el contenedor de la categoría
                categoryContainer.innerHTML = headerHTML + contentHTML;
                // Añade el contenedor completo de la categoría al elemento principal del reporte
                reportEl.appendChild(categoryContainer);
            });

            reportEl.removeEventListener('click', handleExpenseReportClick);
            reportEl.addEventListener('click', handleExpenseReportClick);
        }

        // MODIFICADO: Añadir rotación de icono chevron al expandir/colapsar
        function handleExpenseReportClick(e) {
                // Primero, revisa si se hizo clic en un encabezado de CATEGORÍA
                const categoryToggleBtn = e.target.closest('.category-toggle-btn');
                if (categoryToggleBtn) {
                    e.preventDefault(); // Evita que el navegador haga algo raro con el botón
                    const targetId = categoryToggleBtn.dataset.targetId; // El ID del div a mostrar/ocultar
                    const contentElement = document.getElementById(targetId); // El div con el contenido
                    //const chevronIcon = categoryToggleBtn.querySelector('.category-chevron'); // El icono de flecha (no necesitamos rotarlo aquí si usamos la clase 'open' en el botón)

                    if (contentElement) {
                        // Alterna la clase 'open' en el div de contenido (el CSS hace la animación)
                        const isOpen = contentElement.classList.toggle('open');
                        // Alterna la clase 'open' en el botón mismo (para que el CSS rote el icono)
                        categoryToggleBtn.classList.toggle('open', isOpen);
                    }
                    return; // Importante: Si fue clic en categoría, no hagas nada más
                }

                // Si NO fue clic en categoría, revisa si fue clic DENTRO de una tarjeta de GASTO
                const target = e.target.closest('button, .expense-header'); // Busca un botón (Editar/Eliminar) o la cabecera de un gasto compartido
                if (!target) return; // Si no fue en ninguno de esos, no hagas nada

                const id = target.dataset.id; // ID del gasto para Editar/Eliminar
                const expenseIdToggle = target.dataset.toggle; // ID del gasto para desplegar (si es compartido)

                // Si se hizo clic en la cabecera de un GASTO COMPARTIDO (tiene data-toggle)
                if (expenseIdToggle && target.classList.contains('expense-header')) {
                    const detailEl = document.getElementById(`detail-${expenseIdToggle}`); // El div con los detalles de repartición
                    const headerEl = target.closest('.expense-header'); // La cabecera misma
                    const chevronIcon = headerEl?.querySelector('.fa-chevron-down'); // El icono de flecha DENTRO de la tarjeta de gasto

                    if (detailEl) {
                        // Alterna la clase 'hidden' (no usamos 'open' aquí, es un despliegue diferente)
                        detailEl.classList.toggle('hidden');
                        // Rota el icono DENTRO de la tarjeta de gasto
                        if(chevronIcon) chevronIcon.classList.toggle('rotate-180');
                    }
                }
                // Si se hizo clic en el botón EDITAR de un gasto
                else if (id && target.classList.contains('edit-expense-btn')) {
                    openExpenseEditModal(id);
                }
                // Si se hizo clic en el botón ELIMINAR de un gasto
                else if (id && target.classList.contains('delete-btn')) {
                    removeExpense(id);
                }
            }


        function renderFixedExpensesSummary() {
            const fixedEl = document.getElementById('fixed-expenses-summary');
            const filterString = getFilterMonthString(currentFilterDate);
            const fixedExpenses = appState.expenses.filter(e => e.isFixed && e.date.startsWith(filterString));

            if (fixedExpenses.length === 0) {
                 fixedEl.innerHTML = '<p class="text-gray-500 italic">No hay gastos fijos para este ciclo.</p>';
                 return;
            }
            
            const participantsMap = new Map(appState.participants.map(p => [p.id, p.name]));
            const sharedFixed = fixedExpenses.filter(exp => exp.type === 'shared');
            const personalFixed = fixedExpenses.filter(exp => exp.type === 'personal');

            let html = '';

            if (sharedFixed.length > 0) {
                html += `<div class="mb-4">
                            <h4 class="font-bold text-sm text-purple-800 bg-purple-100 p-2 rounded-t-lg">Gastos Fijos del Grupo</h4>
                            <div class="space-y-2 border border-t-0 border-purple-200 p-2 rounded-b-lg">`;
                html += sharedFixed.map(exp => `
                    <div class="p-2 bg-white rounded-md border border-gray-200">
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-gray-800 text-sm">${exp.description}</p>
                            <p class="font-bold text-purple-600 text-sm">${formatCurrency(exp.amount)}</p>
                        </div>
                        <p class="text-xs text-gray-500">Pagado por: ${participantsMap.get(exp.payerId) || 'N/A'}</p>
                    </div>`).join('');
                html += `</div></div>`;
            }

            appState.participants.forEach(p => {
                const pExpenses = personalFixed.filter(exp => exp.payerId === p.id);
                if (pExpenses.length > 0) {
                    html += `<div class="mb-4">
                                     <h4 class="font-bold text-sm text-blue-800 bg-blue-100 p-2 rounded-t-lg">Fijos de ${p.name}</h4>
                                     <div class="space-y-2 border border-t-0 border-blue-200 p-2 rounded-b-lg">`;
                    html += pExpenses.map(exp => `
                        <div class="p-2 bg-white rounded-md border border-gray-200">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold text-gray-800 text-sm">${exp.description}</p>
                                <p class="font-bold text-blue-600 text-sm">${formatCurrency(exp.amount)}</p>
                            </div>
                        </div>`).join('');
                    html += `</div></div>`;
                }
            });

            fixedEl.innerHTML = html;
        }
        
        function renderSharedBalanceSummary(summary) {
            const sharedBalanceEl = document.getElementById('shared-balance-summary');
            const balances = summary.participantData.filter(p => Math.abs(p.balance) > 0.01);
            
            let balanceHtml = '';
            
            if (summary.guestDebtTotal > 0) {
                 balanceHtml += `<div class="p-3 bg-yellow-100 border-yellow-400 rounded-lg flex items-center justify-between"><span class="font-bold text-yellow-800"><i class="fas fa-users mr-2"></i> Invitados Deben</span><p class="font-extrabold text-red-600">${formatCurrency(summary.guestDebtTotal)}</p></div>`;
            }

            if (balances.length === 0 && summary.guestDebtTotal === 0) {
                sharedBalanceEl.innerHTML = `<div class="text-center p-4 bg-indigo-50 rounded-lg"><i class="fas fa-handshake text-indigo-500 text-3xl mb-2"></i><p class="font-bold">¡Cuentas claras!</p></div>`;
                return;
            }
            
            balanceHtml += balances.map(p => {
                const isPositive = p.balance > 0;
                return `
                    <div class="p-3 bg-white border rounded-lg flex items-center justify-between">
                        <span class="font-semibold">${p.name}</span>
                        <p class="font-extrabold text-sm ${isPositive ? 'balance-positive' : 'balance-negative'} flex items-center"><i class="fas ${isPositive ? 'fa-arrow-up' : 'fa-arrow-down'} mr-2"></i>${isPositive ? 'Le deben' : 'Debe'}: ${formatCurrency(Math.abs(p.balance))}</p>
                    </div>`;
            }).join('');
            
            sharedBalanceEl.innerHTML = balanceHtml;
        }

        function renderCategoryChart(filteredExpenses) {
            const ctx = document.getElementById('category-chart').getContext('2d');
            const noDataEl = document.getElementById('chart-no-data');

            if (categoryChart) categoryChart.destroy();
            
            // Aplicar filtros dinámicos también al gráfico
            const descriptionFilter = activeFilters.description;
            const categoryFilter = activeFilters.category;
            const participantFilter = activeFilters.participant;
            const paymentMethodFilter = activeFilters.paymentMethod; // NUEVO


            let chartFilteredExpenses = filteredExpenses;
            if (descriptionFilter) {
                chartFilteredExpenses = chartFilteredExpenses.filter(e => 
                    e.description.toLowerCase().includes(descriptionFilter) || 
                    (e.subcategory && e.subcategory.toLowerCase().includes(descriptionFilter))
                );
            }
            if (categoryFilter) {
                chartFilteredExpenses = chartFilteredExpenses.filter(e => e.category === categoryFilter);
            }
            if (participantFilter) {
                 chartFilteredExpenses = chartFilteredExpenses.filter(e => e.payerId === participantFilter);
            }
            if (paymentMethodFilter) { // NUEVO
                 chartFilteredExpenses = chartFilteredExpenses.filter(e => e.paymentMethodId === paymentMethodFilter);
            }


            if (chartFilteredExpenses.length === 0) {
                noDataEl.classList.remove('hidden');
                 // Destruir gráfico si no hay datos filtrados
                if (categoryChart) {
                    categoryChart.destroy();
                    categoryChart = null;
                }
                return;
            }
            
            noDataEl.classList.add('hidden');

            const groupedData = chartFilteredExpenses.reduce((acc, expense) => {
                const category = expense.category || 'Sin Categoría';
                acc[category] = (acc[category] || 0) + expense.amount;
                return acc;
            }, {});

            const labels = Object.keys(groupedData);
            const datasets = [
                {
                    label: 'Gasto',
                    data: [],
                    backgroundColor: '#4f46e5', // Indigo
                },
                {
                    label: 'Excedente',
                    data: [],
                    backgroundColor: '#ef4444', // Red
                }
            ];

            labels.forEach(label => {
                const totalSpent = groupedData[label];
                const category = appState.categories.find(c => c.name === label);
                const budget = category?.budget || 0;
                
                if (budget > 0 && totalSpent > budget) {
                    datasets[0].data.push(budget);
                    datasets[1].data.push(totalSpent - budget);
                } else {
                    datasets[0].data.push(totalSpent);
                    datasets[1].data.push(0);
                }
            });

            categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { stacked: true, beginAtZero: true },
                        y: { stacked: true }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    label += formatCurrency(context.raw);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // MODIFICADO: renderCreditCardSummary ahora usa los gastos filtrados por mes
function renderCreditCardSummary(expensesForMonth) {
    const allExpenses = appState.expenses || [];
    const paymentMethods = appState.paymentMethods || [];
    const container = document.getElementById('credit-card-summary-cards');
    const section = document.getElementById('credit-card-summary-section');
    const today = new Date(); // Fecha actual

    if (!container || !section) return;

    container.innerHTML = '';
    let totalSpendingDisplayed = 0;

    paymentMethods.forEach(method => {
        let totalSpentOnMethod = 0;
        let expensesToConsider = [];
        let cardSubtitle = `Gasto total en ${MONTH_NAMES[currentFilterDate.getMonth()]}`;
        let paymentDateHTML = '';

        // --- Lógica Diferenciada por Tipo ---
        if (method.type === 'credit') {
            // Calcular ciclo basado en HOY
            const { startDate, closingDate, paymentDate } = getCycleDates(method, today);

            if (startDate && closingDate) {
                // Filtrar gastos DENTRO del ciclo actual
                expensesToConsider = allExpenses.filter(exp =>
                    exp.paymentMethodId === method.id &&
                    exp.date >= startDate &&
                    exp.date <= closingDate
                );
                totalSpentOnMethod = expensesToConsider.reduce((sum, exp) => sum + exp.amount, 0);
                cardSubtitle = `Gasto del ciclo actual (${formatDate(startDate)} al ${formatDate(closingDate)})`;
                if(paymentDate) {
                    paymentDateHTML = `<p class="text-xs text-gray-600 mt-1 text-right">Próximo pago (aprox): <strong class="text-red-600">${formatDate(paymentDate)}</strong></p>`;
                }
            } else {
                totalSpentOnMethod = 0;
                cardSubtitle = "Error al calcular ciclo actual";
            }
        } else {
            // Lógica para efectivo y otros (usa mes calendario)
            expensesToConsider = expensesForMonth.filter(exp => exp.paymentMethodId === method.id);
            totalSpentOnMethod = expensesToConsider.reduce((sum, exp) => sum + exp.amount, 0);
        }
        // --- Fin Lógica Diferenciada ---


        // --- Renderizado (Solo si hubo gasto) ---
        if (totalSpentOnMethod > 0) {
            let cardColorClasses = 'bg-gray-50 border-gray-200';
            let titleColorClass = 'text-gray-800';
            let amountColorClass = 'text-gray-900';

            if (method.type === 'cash') {
                cardColorClasses = 'bg-green-50 border-green-200';
                titleColorClass = 'text-green-800';
                amountColorClass = 'text-green-900';
            } else if (method.type === 'credit') {
                cardColorClasses = 'bg-cyan-50 border-cyan-200';
                titleColorClass = 'text-cyan-800';
                amountColorClass = 'text-cyan-900';
            }

            const cardHTML = `
                <div class="p-4 rounded-lg border ${cardColorClasses}">
                    <p class="font-bold ${titleColorClass}">${method.name}</p>
                    <p class="text-2xl font-extrabold ${amountColorClass} mt-1">${formatCurrency(totalSpentOnMethod)}</p>
                    <div class="mt-3">
                         <p class="text-xs text-gray-600">${cardSubtitle}</p>
                         ${paymentDateHTML}
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHTML);
            totalSpendingDisplayed += totalSpentOnMethod;
        }
    });

    // --- Mostrar/Ocultar Sección ---
    if (totalSpendingDisplayed === 0) {
         section.classList.add('hidden');
         container.innerHTML = `<p class="text-gray-500 italic text-sm col-span-full">No hay gastos registrados para mostrar en este resumen.</p>`;
    } else {
         section.classList.remove('hidden');
         const existingMessage = container.querySelector('p.italic.col-span-full');
         if (existingMessage) {
             existingMessage.remove();
         }
    }
}
        // --- Main Render Function ---
        function renderUI() {
            if (!appState) return;
            const filterMonthString = getFilterMonthString(currentFilterDate);
            let expensesForMonth = (appState.expenses || []).filter(e => e.date && e.date.startsWith(filterMonthString));

            // Si no hay gastos en el mes actual y hay gastos en total Y no es el mes actual, intenta ir al mes del último gasto
            if (expensesForMonth.length === 0 && appState.expenses && appState.expenses.length > 0 && filterMonthString !== getFilterMonthString(new Date())) {
                const validExpenseDates = appState.expenses.map(e => e.date ? new Date(e.date + "T00:00:00Z").getTime() : 0).filter(t => t > 0);
                if (validExpenseDates.length > 0) {
                    const latestExpenseTime = Math.max(...validExpenseDates);
                    const latestExpenseDate = new Date(latestExpenseTime);
                    latestExpenseDate.setUTCDate(1); // Ir al inicio del mes del último gasto
                    if (getFilterMonthString(latestExpenseDate) !== filterMonthString) {
                         console.log("No expenses found for current filter, jumping to last expense month:", latestExpenseDate);
                         currentFilterDate = latestExpenseDate;
                         expensesForMonth = (appState.expenses || []).filter(e => e.date && e.date.startsWith(getFilterMonthString(currentFilterDate)));
                    }
                }
            }


            const summary = calculateSummary(appState, expensesForMonth); // Calcular summary con gastos SIN filtrar dinámicamente
            
            renderMonthSelector();
            renderDashboard(summary);
            renderParticipantsConfig(appState.participants, summary); // Usa el summary original, actualiza etiquetas de filtro
            renderCategoriesModal(appState.categories); // Popula filtros y modal, actualiza etiquetas de filtro
            // Los render de modals deben ir antes para poblar los selects
            renderPaymentMethodsModal(appState.paymentMethods); 
            
            // MODIFICADO: Pasar 'expensesForMonth'
            renderCreditCardSummary(expensesForMonth); 
            
             // Pasar los gastos del mes *antes* de aplicar filtros dinámicos
            renderExpenseReportByCategory(expensesForMonth, summary); 
            renderCategoryChart(expensesForMonth); // Renderizar gráfico con gastos del mes (filtrados dinámicamente dentro)
            renderFixedExpensesSummary(); // Usa appState.expenses, no necesita cambios
            renderSharedBalanceSummary(summary); // Usa el summary original
            
            // CLAVE: Inicializar los selects del formulario de gastos DESPUÉS de poblar las opciones
            initializeCustomSelect('expense-paid-by');
            initializeCustomSelect('expense-payment-method-id');
            initializeCustomSelect('expense-category');
            
            // NUEVO: Actualizar estado visual del botón de filtros y las etiquetas
            updateFilterUIState();
        }

        window.onload = initializeFirebase;
        window.onerror = function (message, source, lineno, colno, error) {
            console.error("Error global:", message, error);
            showModal("Ocurrió un error inesperado.", error?.message || message, "Error Crítico");
            return true; 
        };
    </script>
</body>
</html>
