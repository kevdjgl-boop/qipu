<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monedero V.2.19 (Reestructuración Estética)</title>
    <!-- Incluye Tailwind CSS para estilizado rápido y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluye Font Awesome para íconos de balance -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Incluye Chart.js para la gráfica de gastos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Configuración para usar la fuente Inter -->
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f6f6f6;
        overflow-x: hidden;
        //padding-bottom: 4rem;
        width: 100vw; /* 4. Haz que el body ocupe el 100vw */
        height: 100vh; /* AÑADIDO: Fija la altura del body a la ventana */

        margin: 0; /* AÑADIDO: Quita márgenes por defecto */
      }

      #app-layout {
        /*display: flex;*/ /* La magia para ponerlos uno al lado del otro */
        position: relative;
        height: 100vh;
        overflow: hidden;
        width: 100vw; /* <-- ¡AÑADE ESTO! */
      }

      #main-content-wrapper {
        /* flex-grow: 1; */ /* <-- ELIMINADO */

        display: flex;
        flex-direction: column;

        /* ¡LA MAGIA ESTÁ AQUÍ! */

        /* 1. Lo movemos 80px a la derecha */
        margin-left: 80px;

        /* 2. Le damos el 100% de la altura de la ventana */
        height: 100vh;

        /* 3. El scroll ahora ocurre DENTRO de este div */
        overflow-y: auto;

        /* 4. Evita que el padding rompa el ancho */
        box-sizing: border-box;

        /* (Tus paddings y gaps originales se mantienen) */
        padding-top: 1.5rem;
        padding-left: 1.5rem; /* (Este es el padding interno) */
        padding-right: 1.5rem;
        gap: 1.5rem;
        padding-bottom: 2rem;
      }

      #dashboard-container {
        display: flex;
        flex-direction: column;
        padding: 1.5rem;
      }

      #dashboard-blocks-wrapper {
        display: flex;
        flex-direction: column;
        /*flex-grow: 1;*/ /* ¡CLAVE! Ocupa todo el espacio vertical */
        /*overflow: hidden;*/ /* No debe tener scroll */
        gap: 1.5rem; /* Reemplaza el space-y-6 */
      }

      /* 4. Bloque Superior (50/50)
        Debe tener un tamaño fijo y no encogerse */
      #dashboard-top-block {
        flex-shrink: 0;
      }
      #main-metrics-container {
        height: 150px;
        background-color: #f5f5f5 !important;
      }
      .gap-custom-6px {
        gap: 6px !important;
      }
      .section-card-metric span {
        /* Convertimos 25px a 1.5625rem */
        font-size: 1.5625rem !important;
        /* Ajusta el line-height para que no haya mucho espacio vertical innecesario */
        line-height: 1.1;
      }

      .section-card-gray-bg {
        /*background-color: #f1f1f1 !important;*/ /* El color solicitado */
        /*padding: 1rem;*/ /* Usamos el mismo padding que section-card */
        border-radius: 1rem;
      }
      #saldos-individuales-card {
        border-radius: 1.5rem !important;
        background-color: #ffffff;
        box-shadow: none;
        padding-top: 0.5rem !important; /* <-- NUEVO (Más pequeño) */
        padding-bottom: 0.5rem !important; /* <-- NUEVO (Más pequeño) */
        padding-left: 1rem !important; /* Mantenemos el padding lateral */
        padding-right: 1rem !important; /* Mantenemos el padding lateral */
      }
      /* Tarjeta de Saldo Restante (Roja/Gris) */
      .balance-remaining-card {
        background-color: #ef4444;
        border-radius: 0.5rem;
        /* Padding interior de la tarjeta roja para el diseño compacto */
        padding: 0.3rem 0.75rem;
        height: auto;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
        color: white;
        gap: 0.3rem; /* Mínima separación entre Saldo restante y el monto */
        line-height: 1;
      }

      .balance-remaining-card p {
        font-size: 0.6rem;
        font-weight: 600;
        margin: 0;
        text-transform: uppercase; /* El título "SALDO RESTANTE" está en mayúsculas en tu imagen */
        opacity: 0.9;
        line-height: 1.1;
      }

      .balance-remaining-card span {
        font-size: 1.5rem; /* El monto S/ 00.00 (24px) */
        font-weight: 800;
        margin: 0;
        line-height: 1.1;
      }
      .saldos-individuales-list {
        background-color: #f5f5f5; /* APLICAMOS EL FONDO GRIS AQUÍ */
        border-radius: 0.8rem;
        padding: 1rem; /* Padding interno del bloque gris */
        display: flex;
        flex-direction: column;
        gap: 0.3rem; /* Espacio entre los ítems de la lista */
      }
      #dashboard-container h3 {
        font-size: 1.2rem !important; /* Haz que el título general sea grande y visible */
        font-weight: 800;
        color: #1f2937;
        margin-bottom: 0.5rem;
      }
      .saldos-individuales-list > div {
        font-size: 0.7rem; /* 12.8px */
        color: #1f2937;
        font-weight: 500;
        line-height: 1;
      }

      /* Estilo para el título de cada participante (ej: Kevind) */
      .section-card-gray-bg h2 {
        font-size: 1.5rem; /* text-3xl */
        font-weight: 800;
        color: #151d29;
        margin-bottom: 0.5rem;
        line-height: 1.1;
      }

      /* 5. Bloque Inferior (35/65)
        Debe crecer para ocupar el RESTO de la altura */
      #dashboard-bottom-block {
        flex-grow: 1; /* ¡CLAVE! Ocupa el resto de la altura */
        overflow: hidden; /* No debe tener scroll */

        /* Clases de Tailwind que ya tenías (flex, lg:flex-row, gap) */
      }
      #ahorro-mutuo-card p,
      #gastos-fijos-card p {
        color: #4b5563; /* text-gray-600 */
        text-transform: capitalize;
      }
      #ahorro-mutuo-card span,
      #gastos-fijos-card span {
        font-size: 1.5625rem !important; /* 25px */
        line-height: 1.1;
        display: block;
      }

      /* 6. Las Columnas de Scroll Interno (35% y 65%)
        Estas son las únicas que tendrán scroll */
      .dashboard-column-left,
      .dashboard-column-right {
        /*height: 100%;*/ /* Ocupan la altura de su padre (el bloque 35/65) */
        /*overflow: hidden;*/ /* ¡AQUÍ ESTÁ EL SCROLL INTERNO! */

        /* Espacio entre las tarjetas dentro de la columna */
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      #content-column {
        display: flex;
        flex-direction: column; /* Apila la barra y el contenido verticalmente */
        flex-grow: 1; /* Ocupa el resto del ancho */
        //height: 100vh;        /* Ocupa toda la altura */
        //overflow: hidden;       /* Evita que esta columna tenga scroll */
        position: relative;
      }
      /* Ocultar texto de estado cuando el sidebar está colapsado */
      #app-layout:not(.sidebar-is-open) #auth-status-text {
        display: none;
      }
      .no-scroll {
        overflow-y: hidden !important;
      }

      #participant-summary-cards {
        /* CAMBIADO: De overflow-y a overflow-x */
        overflow-x: auto;
        overflow-y: hidden; /* Prevenimos scroll vertical */

        /* CAMBIADO: Aseguramos que sea flex (aunque ya lo pusimos en la clase HTML) */
        display: flex;
        flex-wrap: nowrap; /* Evita que las tarjetas salten a la siguiente línea */
        scrollbar-width: thin; /* Firefox */
        scrollbar-color: #d1d5db #f5f5f5; /* Pulgar/Pista para Firefox */

        &::-webkit-scrollbar {
          display: block;
          height: 8px; /* Altura de la barra horizontal */
        }
        &::-webkit-scrollbar-track {
          background: #470505;
          border-radius: 4px;
        }
        &::-webkit-scrollbar-thumb {
          background-color: #d1d5db; /* gris-300 */
          border-radius: 4px;
          border: 2px solid #f5f5f5;
        }
      }
      #participant-summary-cards > .section-card-gray-bg {
        min-width: 230px; /* Ancho mínimo de cada tarjeta (ajusta si es necesario) */
        flex-shrink: 0; /* Evita que la tarjeta se encoja */
      }

      /* ===== AJUSTE ESPECIAL para Saldos Individuales (fondo #F5F5F5) ===== */
      #saldos-individuales-card #participant-summary-cards::-webkit-scrollbar-thumb {
        /* El borde debe coincidir con SU fondo específico */
        border: 2px solid #f5f5f5;
      }

      .section-card {
        /*background-color: white;*/
        padding: 1.5rem;
        border-radius: 1rem;
        /*box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);*/
        border: none; /* 2. Quitamos bordes de colores */
      }
      /* Dashboard principal - Estilo destacado */
      #global-main-card {
        background-color: #111827; /* Gray-900 */
        color: white;
        border-bottom: none; /* 2. Quitamos el borde inferior */
      }
      #initial-loading-screen {
        position: fixed; /* La clave: lo saca del flujo normal */
        inset: 0; /* Abreviatura de: top:0, left:0, right:0, bottom:0 */
        background-color: #f3f4f6; /* El mismo color de fondo del body */
        z-index: 100; /* Lo pone por encima de todo */

        /* Centra el contenido (ya lo tenías con Tailwind) */
        //display: flex;
        //justify-content: center;
        align-items: center;

        /* Ignora las clases de espaciado/tamaño de Tailwind */
        padding-top: 0 !important;
        height: 100vh !important;
        max-width: 100% !important;
      }
      /* Estilo para los métricos dentro del dark card */
      .metric-value {
        font-size: 2rem; /* 32px */
        font-weight: 800; /* Extra bold */
        line-height: 1.2;
        margin-top: 0.5rem;
        display: block;
      }

      /* Reglas para la capitalización de la primera letra del título */

      .metric-label {
        font-size: 0.75rem; /* 12px */
        font-weight: 600;
        text-transform: uppercase;
      }

      /* --- ESTILOS DE INPUTS Y SELECTS (3. Sin bordes y fondo #E1E3E7) --- */
      .custom-input,
      .custom-select-button {
        background-color: #e1e3e7; /* Fondo gris claro */
        border: none !important; /* Quitar bordes */
        box-shadow: none !important;
        padding: 0.75rem !important;
        border-radius: 0.5rem !important;
        transition: background-color 0.2s, box-shadow 0.2s;
      }
      .custom-input:focus,
      .custom-select-button:focus {
        background-color: #d8d8d8;
        outline: none;
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); /* Sutil ring focus */
      }
      .custom-input[datepicker] {
        padding-top: 0.75rem !important; /* Mantiene tu padding original */
        padding-right: 0.75rem !important; /* Mantiene tu padding original */
        padding-bottom: 0.75rem !important; /* Mantiene tu padding original */
        padding-left: 2.5rem !important; /* Expande SOLO la izquierda (equivale a ps-10) */
      }
      .custom-select-options {
        border: 1px solid #d1d5db;
      }

      /* --- ESTILOS CRÍTICOS PARA TARJETAS DE SALDO (Glassmorphism) --- */
      .balance-glass-card {
        position: relative;
        overflow: hidden;
        background-color: #ffffff;
        border-radius: 1.5rem;
        padding: 1.5rem;
        /*box-shadow: 0 2px 4px 0 rgba(31, 38, 135, 0.1);*/
        min-height: 300px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .balance-glass-card::before {
        content: "";
        position: absolute;
        top: -100px;
        left: -100px;
        width: 300px;
        height: 300px;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.4;
        z-index: -1;
      }
      #dashboard-top-block .balance-glass-card {
        min-height: 0; /* Quitamos la altura mínima */
        /*height: 100%;*/ /* Hacemos que ocupen la altura disponible (150px) */
        /* Puede que necesites ajustar el padding interno o el tamaño de fuente
        si el contenido no cabe bien en 150px */
        padding-top: 0.75rem; /* Reducimos padding si es necesario */
        padding-bottom: 0.75rem;
      }

      /* Ajustar tamaño de fuente del monto si es muy grande para 150px */
      #dashboard-top-block .glass-card-amount {
        font-size: 2rem; /* Un poco más pequeño que 3rem */
        margin-top: 0.5rem;
        margin-bottom: 0.25rem;
      }
      .glass-card-amount {
        font-weight: 800;
        color: #111827;
        font-size: 3rem;
        line-height: 1;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        display: block;
      }
      /* --- FIN ESTILOS GLASSMORPHISM --- */

      /* --- ESTILO TARJETA DE PARTICIPANTE (Dark Glass 2.0) --- */
      .participant-summary-card {
        background-color: rgba(17, 24, 39, 0.9);
        color: white;
        border-radius: 1.5rem;
        padding: 1.5rem;
        overflow: hidden;
        position: relative;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .participant-summary-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 50%;
        height: 50%;
        background: radial-gradient(circle at 10% 10%, rgba(79, 70, 229, 0.3), transparent 70%);
        filter: blur(50px);
        z-index: 0;
        pointer-events: none;
      }
      .participant-content {
        position: relative;
        z-index: 1;
      }
      .metric-detail-container {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 1rem;
        border-radius: 1.5rem;
      }
      .main-balance-amount {
        font-size: 2.25rem;
        font-weight: 900;
        line-height: 1.1;
        display: block;
        margin-top: 0.5rem;
      }
      .balance-positive-dark {
        color: #34d399;
      } /* Green-400 */
      .balance-negative-dark {
        color: #f87171;
      } /* Red-400 */
      /* --- FIN ESTILO TARJETA PARTICIPANTE --- */

      /* --- NUEVO: ESTILO PARA TARJETAS DEL HISTORIAL (Glass) --- */
      .history-card {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding: 1rem;
        display: flex;
        align-items: center;
        transition: transform 0.2s;
        border: 1px solid rgba(255, 255, 255, 0.5);
        position: relative;
      }
      .history-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      }
      .history-date-col {
        padding-right: 1rem;
        border-right: 1px solid #e5e7eb;
        text-align: center;
        flex-shrink: 0;
        min-width: 60px;
      }
      /* Oculta el botón "Configuración" original */
      #open-participants-sidebar-btn {
        display: none;
      }
      /* Estilo para el botón de toggle en el sidebar */
      #close-sidebar-btn {
        position: absolute;
        top: 1.5rem; /* 24px */

        /* Se alinea a la DERECHA del sidebar ABIERTO (400px) */
        left: calc(400px - 2rem - 1.5rem); /* (Ancho Abierto) - (Ancho Botón) - (Padding Derecho) */

        z-index: 60; /* Encima del contenido del sidebar */
        background-color: #f3f4f6; /* bg-gray-100 */
        color: #4b5563; /* text-gray-600 */
        width: 2rem; /* w-8 */
        height: 2rem; /* h-8 */
        border-radius: 9999px; /* rounded-full */
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease-out, left 0.3s ease-out;
        border: none;
      }
      #close-sidebar-btn:hover {
        background-color: #e5e7eb; /* bg-gray-200 */
      }
      #close-sidebar-btn i {
        transition: transform 0.3s ease-out;
      }

      /* Cuando el sidebar está COLAPSADO (clase .open NO está) */
      #participant-sidebar:not(.open) #close-sidebar-btn {
        /* Se centra en la barra colapsada de 80px */
        left: calc(80px / 2 - 1rem); /* (Ancho Colapsado / 2) - (Ancho Botón / 2) */
        top: 1.5rem; /* Lo mantenemos arriba */
      }

      /* Cambiar el icono (rotarlo) cuando está colapsado */
      #participant-sidebar:not(.open) #close-sidebar-btn i {
        transform: rotate(180deg); /* La flecha apunta a la derecha */
      }
      .history-day-num {
        font-size: 1.8rem;
        font-weight: 800;
        line-height: 1;
        color: #3b82f6; /* Blue-500 */
      }
      .history-day-name {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        color: #6b7280; /* Gray-500 */
      }
      .history-content-col {
        flex-grow: 1;
        padding-left: 1rem;
      }
      .history-amount-col {
        flex-shrink: 0;
        padding-left: 0.5rem;
        text-align: right;
      }
      /* --- FIN NUEVO ESTILO HISTORIAL --- */

      /* 1. Estilo para el contenedor del gráfico colapsable */
      #chart-collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-out;
      }
      #chart-collapsible-content.open {
        max-height: 1000px; /* Suficientemente grande para el contenido */
        transition: max-height 0.7s ease-in;
      }

      .balance-positive {
        color: #10b981;
      } /* Green */
      .balance-negative {
        color: #ef4444;
      } /* Red */

      /* Estilo para hacer la tarjeta de gasto clickeable */
      .expense-header {
        cursor: pointer;
        user-select: none;
      }
      /* Estilo específico para la tarjeta de participante (más grueso) */
      .participant-card {
        /* --- NUEVO ESTILO MINIMALISTA --- */
        border: 1px solid #e5e7eb; /* Borde gris-200 (más sutil) */
        background-color: #ffffff; /* Fondo blanco */
        padding: 0.75rem 1rem; /* Padding reducido (12px y 16px) */
        border-radius: 0.75rem; /* Mantenemos el redondeo */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Sombra más sutil */
      }

      /* --- ESTILOS CRÍTICOS DEL SIDEBAR --- */
      #participant-sidebar {
        position: absolute; /* <-- CAMBIO CLAVE: Lo saca del flujo */
        top: 0;
        left: 0;
        height: 98vh; /* (Tu altura original está bien) */
        background-color: #fff;
        z-index: 50; /* Lo pone encima de todo */

        /* flex-shrink: 0; */ /* <-- ELIMINADO (ya no es parte de flex) */

        width: 80px;
        transition: width 0.3s ease-out;

        /* (El resto de tus estilos de borde, etc. se mantienen) */
        border-top-right-radius: 1.5rem;
        border-bottom-right-radius: 1.5rem;
        overflow: hidden;
      }
      #participant-sidebar.open {
        width: 400px; /* ANCHO EXPANDIDO (tu max-width anterior) */
      }

      /* --- AÑADE ESTE BLOQUE COMPLETO --- */

      /* 1. Estilos para el nuevo contenedor de iconos */
      #sidebar-collapsed-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        /* Damos espacio para el botón de toggle que está en absolute */
        padding-top: 6rem;
        gap: 1.5rem; /* Espacio entre iconos */
      }

      .icon-link {
        position: relative;
        color: #4b5563; /* text-gray-600 */
        font-size: 1.5rem; /* text-2xl */
        padding: 0.75rem; /* p-3 */
        border-radius: 0.5rem; /* rounded-lg */
        transition: background-color 0.2s, color 0.2s;
      }

      .icon-link:hover {
        background-color: #f3f4f6; /* bg-gray-100 */
        color: #4f46e5; /* text-indigo-600 */
      }
      /* ===== AÑADE ESTE NUEVO BLOQUE DE CSS ===== */
      .icon-badge {
        position: absolute;
        top: 4px; /* Ajusta la posición vertical */
        right: 4px; /* Ajusta la posición horizontal */

        /* El color de fondo (puedes usar el rojo de "gasto" o el índigo de "filtro") */
        background-color: #4f46e5; /* Indigo-600 */
        color: white;

        font-size: 0.7rem; /* 11px */
        font-weight: 700;
        line-height: 1; /* Para centrar el número */

        /* Esto crea el "cuadrado con esquinas redondeadas" */
        padding: 4px 6px;
        border-radius: 0.375rem; /* rounded-md */
        min-width: 1.5rem; /* 20px (para que se vea bien con 1 dígito) */
        text-align: center;

        /* Oculto por defecto */
        display: none;
        transition: transform 0.2s ease;
      }

      /* Clase para mostrarlo (que añadiremos con JS) */
      .icon-badge.show {
        display: inline-block;
        transform: scale(1);
      }
      /* ===== FIN DEL NUEVO BLOQUE DE CSS ===== */

      /* 2. Lógica para mostrar/ocultar los contenedores */

      /* --- AÑADE ESTE NUEVO BLOQUE DE CSS --- */

      /* 1. Estilos para AMBOS contenedores de contenido (Colapsado y Expandido) */
      #sidebar-collapsed-content,
      #sidebar-expanded-content {
        width: 400px;
        box-sizing: border-box;
        //overflow-y: auto;
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        transition: opacity 0.3s ease-out, filter 0.3s ease-out, visibility 0.3s;
        padding-top: 5rem; /* Empuja el contenido hacia abajo (ajusta si es necesario) */
        display: flex; /* Habilita Flexbox */
        flex-direction: column; /* Coloca los elementos en columna */
        //justify-content: space-between; /* Distribuye el espacio entre los elementos */
        /* Puedes añadir padding-bottom aquí si es necesario para el scroll */
        padding-bottom: 2rem;
      }

      /* 2. Estilos específicos para el CONTENIDO EXPANDIDO */
      #sidebar-expanded-content {
        width: 400px; /* Ancho fijo */
        box-sizing: border-box;
        overflow-y: auto; /* El scroll ahora va aquí DENTRO */
        /* La clase .p-6 que ya tiene le da el padding */
      }

      /* 3. Estilos específicos para el CONTENIDO COLAPSADO (Iconos) */
      #sidebar-collapsed-content {
        width: 80px; /* Ancho fijo */
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 6rem;
        gap: 1.5rem;
      }

      #sidebar-expanded-content > div:last-child {
        margin-top: auto; /* <-- ESTO LO EMPUJA AL FINAL */
        flex-shrink: 0; /* Evita que se encoja si el contenido es largo */

        /* Re-aplicamos padding/border porque p-6 ya no aplica directamente */
        padding-top: 1.5rem; /* pt-6 */
        border-top: 1px solid #e5e7eb; /* border-t border-gray-200 */
        padding-bottom: 1.5rem; /* Añade espacio abajo */
        padding-left: 1.5rem; /* Añade padding lateral */
        padding-right: 1.5rem; /* Añade padding lateral */
      }

      /* 4. La LÓGICA DE VISIBILIDAD (¡Aquí ocurre la magia!) */

      /* Por defecto (colapsado): Ocultar expandido, mostrar iconos */
      #participant-sidebar:not(.open) #sidebar-expanded-content {
        opacity: 0;
        filter: blur(5px); /* Inicia borroso */
        visibility: hidden; /* Oculto y no-interactuable */
      }
      #participant-sidebar:not(.open) #sidebar-collapsed-content {
        opacity: 1;
        filter: blur(0px); /* Enfocado */
        visibility: visible;
      }

      /* Cuando está .open: Ocultar iconos, mostrar expandido */
      #participant-sidebar.open #sidebar-expanded-content {
        opacity: 1;
        filter: blur(0px); /* Termina enfocado */
        visibility: visible;
      }
      #participant-sidebar.open #sidebar-collapsed-content {
        opacity: 0;
        filter: blur(5px); /* Se va borroso */
        visibility: hidden;
      }

      /* 3. Darle un ancho fijo al contenido expandido (reemplaza la regla eliminada) */
      #sidebar-expanded-content {
        width: 400px;
        box-sizing: border-box;
        /* Ya no usamos white-space: nowrap, dejamos que el texto fluya */
      }

      /* El backdrop ya no es necesario con este layout */
      .backdrop {
        display: none !important;
      }

      /* Ya no necesitamos bloquear el scroll del body */
      .no-scroll {
        overflow-y: auto !important;
      }
      /* --- FIN ESTILOS SIDEBAR --- */

      .header-btn {
        background-color: #4f46e5; /* Indigo-600 */
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      #open-participants-sidebar-btn:hover {
        background-color: #4338ca; /* Indigo-700 */
      }

      /* Estilo para el indicador de conexión */
      .sync-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 6px;
        transition: background-color 0.3s;
      }
      .sync-green {
        background-color: #10b981;
      } /* Green */
      .sync-red {
        background-color: #ef4444;
      } /* Red */

      /* --- ESTILOS PARA CUSTOM SELECT --- */
      .custom-select-options {
        max-height: 160px; /* Limitar altura */
        overflow-y: auto;
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }
      .custom-select-options::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }
      .custom-select-option {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .custom-select-option:hover {
        background-color: #f3f4f6; /* gray-100 */
      }
      .custom-select-option.selected {
        background-color: #eef2ff; /* indigo-50 */
        font-weight: 600;
        color: #4f46e5; /* indigo-600 */
      }
      /* --- FIN ESTILOS CUSTOM SELECT --- */

      /* --- ESTILOS PARA BARRA DE PROGRESO --- */
      .progress-bar-container {
        background-color: #e5e7eb; /* gray-200 */
        border-radius: 9999px;
        height: 8px;
        width: 100%;
        overflow: hidden;
      }
      .progress-bar-fill {
        height: 100%;
        border-radius: 9999px;
        transition: width 0.5s ease-out, background-color 0.5s ease-out;
      }

      /* --- ESTILOS PARA POPOVER DE FILTROS Y ETIQUETAS --- */
      #filter-popover {
        transition: opacity 0.2s ease-out, visibility 0.2s ease-out, transform 0.2s ease-out;
        max-height: 400px; /* Limitar altura máxima */
        overflow-y: auto; /* Scroll si es necesario */
      }
      #filter-popover.hidden {
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
      }
      #filter-popover-button .active-indicator {
        display: none;
      }
      #filter-popover-button.active .active-indicator {
        display: inline-block;
      }
      /* Estilos para las etiquetas de filtro en el popover */
      .filter-tag {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        margin: 0.25rem;
        border-radius: 9999px; /* fully rounded */
        font-size: 0.75rem; /* text-xs */
        font-weight: 500; /* medium */
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
        border: 1px solid transparent;
      }
      .filter-tag.category-tag {
        background-color: #e0e7ff; /* indigo-100 */
        color: #3730a3; /* indigo-800 */
        border-color: #c7d2fe; /* indigo-200 */
      }
      .filter-tag.participant-tag {
        background-color: #f3e8ff; /* purple-100 */
        color: #5b21b6; /* purple-800 */
        border-color: #e9d5ff; /* purple-200 */
      }
      /* NUEVO: Estilo para etiquetas de método de pago */
      .filter-tag.payment-method-tag {
        background-color: #d1fae5; /* green-100 */
        color: #065f46; /* green-800 */
        border-color: #a7f3d0; /* green-200 */
      }
      .filter-tag:hover {
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3); /* Ring effect on hover */
      }
      .filter-tag.active {
        background-color: #4f46e5; /* indigo-600 */
        color: white;
        border-color: #4f46e5;
        font-weight: 600;
      }
      .filter-tag.participant-tag.active {
        background-color: #7e22ce; /* purple-700 */
        border-color: #7e22ce;
      }
      /* NUEVO: Estilo activo para etiquetas de método de pago */
      .filter-tag.payment-method-tag.active {
        background-color: #047857; /* green-700 */
        border-color: #047857;
      }
      /* Estilos para las etiquetas en las tarjetas de gasto */
      .expense-card-tag {
        display: inline-flex;
        align-items: center;
        padding: 0.1rem 0.5rem;
        border-radius: 0.375rem; /* rounded-md */
        font-size: 0.65rem; /* Smaller than text-xs */
        font-weight: 600; /* semibold */
        margin-right: 0.25rem;
        line-height: 1;
      }
      .expense-card-tag.category {
        background-color: #dbeafe; /* blue-100 */
        color: #1e40af; /* blue-800 */
      }
      .expense-card-tag.participant {
        background-color: #fef3c7; /* amber-100 */
        color: #92400e; /* amber-800 */
      }
      /* NUEVO: Estilo para etiqueta de método de pago en tarjeta */
      .expense-card-tag.payment-method {
        background-color: #e0f2fe; /* cyan-100 */
        color: #0e7490; /* cyan-800 */
      }
      .category-toggle-btn {
        background: none;
        border: none;
        padding-bottom: 0.5rem; /* Ajusta el padding que ya tenía el borde */
        width: 100%;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .category-toggle-btn:focus {
        outline: none; /* Quita el borde azul feo al hacer clic */
      }

      /* Contenedor del contenido colapsable */
      /* Contenedor del contenido colapsable (REEMPLAZO SIMPLIFICADO) */
      .category-collapsible-content {
        max-height: 0;
        overflow: hidden;

        /* ¡LA CORRECCIÓN! Anima SOLAMENTE max-height */
        /* Ajusta el tiempo (0.4s) si lo quieres más rápido o lento */
        transition: max-height 0.4s ease-in-out;
      }

      /* Estado abierto del contenido (REEMPLAZO SIMPLIFICADO) */
      .category-collapsible-content.open {
        max-height: 5000px; /* Altura deseada */
      }
      /* Rotación del icono chevron cuando está abierto */
      .category-toggle-btn.open .category-chevron {
        transform: rotate(180deg);
      }

      #dashboard-container .section-card h3 {
        font-size: 1rem; /* 14px */
      }
      .popover.saldos-popover {
        background-color: #f5f5f5 !important;
        border: 1px solid #e5e7eb !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
        padding: 0 !important; /* El padding irá en la lista interna */
        border-radius: 0.8rem !important;
      }

      /* 2. Estilo para la flecha (para que coincida con el fondo gris) */
      .popover.saldos-popover .popover-arrow::after {
        background-color: #f5f5f5 !important;
        border-color: #e5e7eb !important;
      }

      /* 3. Estilo para la lista DENTRO del popover */
      .saldos-individuales-list {
        background-color: transparent; /* El fondo ya lo tiene el popover */
        min-width: 220px; /* Ancho mínimo del popover */
        /* Tus otros estilos de padding, gap, etc. se mantienen */
      }
      .payment-method-row {
        display: flex;
        align-items: center;
        gap: 0.75rem; /* gap-3 */
        background-color: #ffffff; /* Fondo blanco */
        padding: 0.75rem 1rem; /* p-3 y px-4 */
        border-radius: 0.75rem; /* rounded-xl */
        border: 1px solid #f3f4f6; /* border-gray-100 */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Sombra sutil */
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }
      .payment-method-row:hover {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
      }

      .payment-method-icon {
        flex-shrink: 0;
        width: 2.5rem; /* w-10 */
        height: 2.5rem; /* h-10 */
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px; /* rounded-full */
        font-size: 1rem;
      }
      .payment-method-icon.credit {
        background-color: #e0e7ff; /* indigo-100 */
        color: #4338ca; /* indigo-700 */
      }
      .payment-method-icon.cash {
        background-color: #fef9c3; /* yellow-100 */
        color: #a16207; /* yellow-700 */
      }

      .payment-method-info {
        flex-grow: 1; /* Ocupa el espacio del medio */
        line-height: 1.3;
      }
      .payment-method-info .title {
        font-weight: 700; /* bold */
        color: #1f2937; /* text-gray-800 */
      }
      .payment-method-info .subtitle {
        font-size: 0.75rem; /* text-xs */
        color: #6b7280; /* text-gray-500 */
      }

      .payment-method-amount {
        flex-shrink: 0;
        text-align: right;
        font-weight: 800; /* extrabold */
        font-size: 1.125rem; /* text-lg */
        color: #ef4444; /* text-red-500 */
      }
      .calendar-day {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 2.75rem; /* 44px */
        border-radius: 0.5rem; /* rounded-lg (más pequeño que 1.5rem) */
        transition: all 0.2s ease;

        /* --- NUEVO: Posicionamiento para la barra --- */
        position: relative;
        overflow: hidden;
        background-color: #f9fafb; /* bg-gray-50 (fondo base) */
      }

      /* El número del día */
      .calendar-day-number {
        position: relative; /* Para estar sobre la barra */
        z-index: 10;
        font-size: 0.75rem; /* 12px */
        font-weight: 500;
        color: #374151; /* text-gray-700 */

        /* Estilo base del círculo (para 'today') */
        display: flex;
        align-items: center;
        justify-content: center;
        width: 1.5rem; /* w-6 */
        height: 1.5rem; /* h-6 */
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      /* La barra de gasto */
      .calendar-day-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        /* Usamos un color base sutil, p.ej. azul */
        background-color: #dbeafe; /* bg-blue-100 */
        border-radius: 2px 2px 0 0;
        transition: height 0.3s ease-out;

        /* Mínima altura para que se vea si el gasto es muy bajo */
        min-height: 2px;
      }

      /* --- ESTILOS DE ESTADO (LIMPIOS) --- */

      /* Días que no pertenecen al mes actual */
      .calendar-day.other-month .calendar-day-number {
        color: #9ca3af; /* text-gray-400 */
      }
      .calendar-day.other-month .calendar-day-bar {
        display: none; /* No mostrar barra en otros meses */
      }

      /* Día de hoy (resalta el número, no la celda) */
      .calendar-day.today .calendar-day-number {
        background-color: #4f46e5; /* bg-indigo-600 */
        color: white;
        font-weight: 700;
      }

      /* Al pasar el mouse, resalta la celda */
      .calendar-day:hover {
        background-color: #f3f4f6; /* bg-gray-100 */
      }

      /* Lógica de acordeón para el calendario */
      #calendar-accordion-content.open {
        /* 5. Estado Visible (Expandido) */
        opacity: 1;
        transform: translateY(0);
        visibility: visible;
        max-height: 500px; /* <-- ¡AÑADIDO DE VUELTA! */

        /* 6. Transición al EXPANDIR (Con el retraso de 0.1s) */
        transition: opacity 0.3s ease-in 0.1s, transform 0.3s ease-in 0.1s, max-height 0.5s ease-in-out 0.1s; /* <-- ¡AÑADIDO DE VUELTA! */
      }
      #calendar-accordion.open #calendar-toggle-text {
        content: "Ocultar semanas"; /* Cambia el texto (opcional) */
      }
      #calendar-accordion.open #calendar-toggle-text i {
        transform: rotate(180deg);
      }
      #calendar-accordion-content {
        /* 1. Posicionamiento y Estilo */
        position: absolute;
        top: 100%; /* Justo debajo de la semana actual */
        left: 0;
        right: 0;
        z-index: 20; /* Encima del historial */
        left: -1rem; /* Mantenemos el anclaje izquierdo */
        width: calc(100% + 2rem); /* Forzamos el ancho a ser 100% + el padding (1rem*2) */

        /* 2. Estilo de Tarjeta Flotante */
        background-color: white;
        border-radius: 0 0 0.75rem 0.75rem; /* Redondea solo abajo */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        padding: 0.5rem 1rem 1rem 1rem;

        /* 3. Estado Oculto (Base) */
        opacity: 0;
        transform: translateY(-10px);
        visibility: hidden;
        overflow: hidden;
        max-height: 0; /* <-- ¡AÑADIDO DE VUELTA! */

        /* 4. Transición al COLAPSAR (Rápida, sin retraso) */
        transition: opacity 0.3s ease-out, transform 0.3s ease-out, max-height 0.5s ease-in-out, /* <-- ¡AÑADIDO DE VUELTA! */ visibility 0s 0.3s;
      }
      /* Estilo para los botones de mes en el dropdown */
      .month-picker-btn {
        width: 100%;
        padding: 0.5rem 0.25rem;
        font-size: 0.8rem;
        font-weight: 600;
        color: #4b5563; /* text-gray-600 */
        border-radius: 0.375rem; /* rounded-md */
        transition: all 0.2s;
      }
      .month-picker-btn:hover {
        background-color: #f3f4f6; /* bg-gray-100 */
      }
      .month-picker-btn.active {
        background-color: #4f46e5; /* bg-indigo-600 */
        color: white;
      }

      /* --- INICIO: Reemplazo de animación del botón (SIN RETRASO) --- */

      /* 1. Define el estado base (visible) y SU TRANSICIÓN */
      #calendar-toggle-wrapper {
        text-align: center;
        overflow: hidden;

        /* Estado visible */
        opacity: 1;
        transform: translateY(0);
        max-height: 50px;
        padding-top: 0.5rem; /* Ajusta si usabas pt-1 */

        /* Transición (AMBAS DIRECCIONES) - RÁPIDA Y SIN RETRASO */
        transition: max-height 0.6s ease-in-out, padding-top 0.6s ease-in-out, opacity 0.3s ease-out, transform 0.3s ease-out;
      }

      /* 2. Define el estado 'open' (oculto) */
      #calendar-accordion.open #calendar-toggle-wrapper {
        /* Estado oculto */
        opacity: 0;
        transform: translateY(-10px);
        max-height: 0;
        padding-top: 0;
      }
      /* --- FIN: Reemplazo de animación --- */
      #calendar-accordion {
        position: relative; /* Ancla para el contenido absoluto */
      }
      .filter-popover-width {
        width: 750px; /* O el ancho que desees, por ejemplo 450px */
      }
      .report-column {
        background-color: #ffffff;
        border-radius: 1.5rem; /* 24px (más moderno) */
        padding: 1.5rem; /* 24px (p-6) */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Sombra sutil */
        /* Añadido para que las columnas crezcan si el contenido es poco */
        display: flex;
        flex-direction: column;
      }

      /* 2. Estilo UNIFICADO para todos los títulos de columna */
      .report-column h3 {
        font-size: 1.25rem; /* 20px (text-xl) */
        font-weight: 700; /* bold */
        color: #1f2937; /* text-gray-800 */
        margin-bottom: 1rem; /* mb-4 */
      }

      /* 3. Estilo específico para el título de Gastos Fijos (quitamos el rojo) */
      #fixed-expenses-summary h3 {
        color: #1f2937 !important; /* Resetea el color rojo */
      }
      .cycle-tab-card {
        background-color: #ffffff;
        border-radius: 0.75rem; /* rounded-xl */
        border: 1px solid #f3f4f6; /* border-gray-100 */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 0.75rem 1rem; /* p-3 y px-4 */
      }
      .cycle-tab-header {
        display: flex;
        align-items: center;
        gap: 0.75rem; /* gap-3 */
        margin-bottom: 0.75rem; /* mb-3 */
      }
      .cycle-tab-nav {
        display: flex;
        background-color: #f3f4f6; /* bg-gray-100 */
        border-radius: 0.5rem; /* rounded-lg */
        padding: 0.25rem; /* p-1 */
        margin-top: 0.5rem; /* mt-2 */
      }
      .cycle-tab-btn {
        flex: 1;
        padding: 0.25rem 0.5rem; /* py-1 px-2 */
        font-size: 0.7rem; /* text-xs */
        font-weight: 600; /* semibold */
        color: #4b5563; /* text-gray-600 */
        border-radius: 0.375rem; /* rounded-md */
        transition: all 0.2s;
        border: none;
        background: none;
        cursor: pointer;
      }
      .cycle-tab-btn.active {
        background-color: #ffffff;
        color: #1f2937; /* text-gray-800 */
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .cycle-tab-content {
        display: none; /* Oculto por defecto */
      }
      .cycle-tab-content.active {
        display: block; /* Visible */
      }
      .cycle-tab-pane {
        padding-top: 0.75rem; /* pt-3 */
      }
      .cycle-tab-pane .subtitle {
        font-size: 0.75rem; /* text-xs */
        color: #6b7280; /* text-gray-500 */
        margin-bottom: 0.25rem; /* mb-1 */
      }
      .cycle-tab-pane .amount {
        font-weight: 800; /* extrabold */
        font-size: 1.125rem; /* text-lg */
        color: #ef4444; /* text-red-500 */
        cursor: pointer; /* Para el modal */
        transition: color 0.2s;
      }
      .cycle-tab-pane .amount:hover {
        color: #c81e1e; /* text-red-700 */
      }
    </style>
    <!-- Incluye GSAP para animaciones -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  </head>
  <body class="min-h-screen">
    <!-- Backdrop para el Sidebar -->
    <div id="sidebar-backdrop" class="backdrop"></div>

    <!-- PANTALLA DE CARGA INICIAL (Solo para datos) -->
    <div id="initial-loading-screen" class="max-w-7xl mx-auto px-4 md:px-8 pt-20 flex justify-center items-center h-64">
      <div class="text-center">
        <i class="fas fa-spinner fa-spin text-4xl text-indigo-500"></i>
        <p class="mt-3 text-gray-600 font-semibold">Cargando datos financieros...</p>
      </div>
    </div>

    <!-- Contenido principal de la aplicación (Secciones 1, 2, 3) -->

    <!-- MOBILE MENU (oculto en escritorio) -->
    <div id="mobile-menu" class="lg:hidden bg-white border-t border-gray-200 p-3 shadow-2xl flex justify-around fixed bottom-0 left-0 right-0 z-40">
      <button onclick="document.querySelector('main').scrollIntoView({ behavior: 'smooth' })" class="text-red-500 text-xs text-center"><i class="fas fa-plus-circle text-2xl"></i><br />Gasto</button>
      <button onclick="document.querySelector('#participants-config-section').scrollIntoView({ behavior: 'smooth' })" class="text-purple-500 text-xs text-center"><i class="fas fa-users text-2xl"></i><br />Participantes</button>
      <button onclick="document.querySelector('section:last-of-type').scrollIntoView({ behavior: 'smooth' })" class="text-gray-500 text-xs text-center"><i class="fas fa-list-alt text-2xl"></i><br />Informe</button>
    </div>

    <!-- ========================================================================================= -->
    <!-- SIDEBAR DE CONFIGURACIÓN DE PARTICIPANTES -->
    <!-- ========================================================================================= -->
    <div id="app-layout" class="">
      <div id="participant-sidebar">
        <button id="close-sidebar-btn" class="text-gray-500 hover:text-gray-900 transition">
          <i class="fas fa-chevron-left"></i>
        </button>

        <div id="sidebar-collapsed-content">
          <a href="#" class="icon-link" id="collapsed-btn-participants" data-panel-id="participants" title="Participantes">
            <i class="fas fa-users fa-fw"></i>
            <span id="sidebar-participant-count" class="icon-badge">0</span>
          </a>
          <a href="#" class="icon-link" id="collapsed-btn-wallet" data-panel-id="wallet" title="Monedero">
            <i class="fas fa-wallet fa-fw"></i>
          </a>
          <a href="#" class="icon-link" id="collapsed-btn-data" data-panel-id="data" title="Herramientas de Datos">
            <i class="fas fa-file-export fa-fw"></i>
          </a>
        </div>

        <!-- Auth Status - SIMPLIFICADO -->
        <div id="content-column"></div>

        <div id="sidebar-expanded-content" class="p-6">
          <div class="flex justify-between items-center border-b pb-4 mb-4">
            <h2 class="text-2xl font-bold text-purple-700">Configuración</h2>
          </div>

          <div id="sidebar-panel-content">
            <div class="sidebar-panel" id="panel-content-participants" role="tabpanel">
              <h3 class="text-xl font-bold text-purple-700 mb-4">Participantes Activos</h3>
              <button id="open-add-participant-modal-sidebar" class="w-full py-2 mb-4 bg-purple-500 text-white font-bold rounded-lg hover:bg-purple-600 transition">+ Añadir Nuevo</button>
              <div id="participants-list" class="space-y-3"></div>
            </div>

            <div class="sidebar-panel hidden" id="panel-content-wallet" role="tabpanel">
              <div id="wallet-section-container">
                <h3 class="text-xl font-bold text-indigo-700 mb-4">Gestión del Monedero</h3>

                <div id="pre-wallet-controls" class="space-y-4">
                  <div class="p-4 border rounded-lg bg-indigo-50">
                    <h4 class="font-bold text-gray-700">Crear un Nuevo Monedero</h4>
                    <p class="text-xs text-gray-500 mb-3">Ideal para empezar de cero o si eres el primero del grupo.</p>
                    <button id="create-wallet-btn" class="w-full py-2 bg-indigo-500 text-white font-bold rounded-lg hover:bg-indigo-600 transition">Crear Monedero</button>
                    <p id="migration-notice" class="text-xs text-blue-600 mt-2 hidden"><i class="fas fa-info-circle"></i> Se migrarán tus datos existentes a este nuevo monedero.</p>
                  </div>
                  <div class="my-2 text-center text-sm font-semibold text-gray-400">O</div>
                  <div class="p-4 border rounded-lg bg-gray-50">
                    <h4 class="font-bold text-gray-700">Unirse a un Monedero Existente</h4>
                    <form id="join-wallet-form" class="flex flex-col items-center space-y-2 mt-2">
                      <input type="text" id="join-wallet-id-input" placeholder="Pegar ID del Monedero" required class="w-full text-center p-2 border border-gray-300 rounded-lg" />
                      <button type="submit" class="w-full py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition">Unirse</button>
                    </form>
                  </div>
                </div>

                <div id="post-wallet-controls" class="hidden space-y-3">
                  <div class="p-4 border border-indigo-200 rounded-lg bg-indigo-50 space-y-3">
                    <div>
                      <label class="text-xs font-semibold text-gray-700">ID de este Monedero (para invitar):</label>
                      <div class="flex items-center mt-1">
                        <input type="text" id="share-wallet-id" readonly class="w-full p-2 border bg-white border-gray-300 rounded-l-lg text-xs" />
                        <button id="copy-wallet-id-btn" class="px-3 py-2 bg-indigo-500 text-white rounded-r-lg hover:bg-indigo-600"><i class="fas fa-copy"></i></button>
                      </div>
                    </div>
                    <p id="current-user-id" class="text-xs text-gray-600 break-words">Mi UID: Cargando...</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="sidebar-panel hidden" id="panel-content-data" role="tabpanel">
              <div id="data-management-section" class="space-y-2">
                <h3 class="text-xl font-bold text-gray-700 mb-4">Herramientas de Datos</h3>
                <button id="export-json-btn" class="w-full py-2 text-sm bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition"><i class="fas fa-file-export"></i> Exportar Datos a Texto</button>
                <button id="restore-json-btn" class="w-full py-2 text-sm bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700 transition"><i class="fas fa-file-import"></i> Importar/Restaurar Datos</button>
                <button id="format-data-btn" class="w-full py-2 text-sm bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 transition mt-2"><i class="fas fa-magic"></i> Formatear Datos Antiguos</button>
              </div>
            </div>
          </div>

          <div class="mt-8 pt-6 border-t border-gray-200">
            <button id="logout-btn" class="w-full bg-red-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition flex items-center justify-center gap-2"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
          </div>
        </div>
      </div>
      <div id="main-content-wrapper" class="">
        <!-- ========================================================================================= -->
        <!-- SECCIÓN 1: DASHBOARD PRINCIPAL Y PARTICIPANTES (100% ANCHO) -->
        <!-- ========================================================================================= -->
        <section id="dashboard-container" class="section-card">
          <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-extrabold text-gray-800 flex items-center">Dashboard Principal</h1>
            <!-- Botones de la Cabecera -->
            <div class="flex items-center space-x-2">
              <div id="auth-status-container" class="flex items-center bg-white rounded-lg shadow-sm p-2">
                <p id="auth-status" class="text-xs text-gray-600 flex items-center">
                  <span id="connection-dot" class="sync-indicator sync-red"></span>
                  <span id="auth-status-text" class="ml-1.5">Conectando...</span>
                </p>
              </div>
              <button id="open-participants-sidebar-btn" class="header-btn"><i class="fas fa-users-cog"></i> <span>Configuración</span></button>
            </div>
          </div>

          <!-- Dashboard Layout (Contenido Principal) -->
          <div id="dashboard-blocks-wrapper">
            <div id="dashboard-top-block" class="flex flex-col md:flex-row gap-3">
              <div class="balance-glass-card saldo-glow w-full md:w-[280px]">
                <div>
                  <div class="glass-card-header">
                    <span class="glass-card-title">Saldo Global</span>
                  </div>
                </div>
                <div>
                  <span id="display-remaining-budget" class="glass-card-amount saldo-text">S/ 0.00</span>
                  <span class="glass-card-subtitle">Disponible</span>
                </div>
              </div>

              <div class="balance-glass-card gasto-glow w-full md:w-[280px]">
                <div>
                  <div class="glass-card-header">
                    <span class="glass-card-title">Gasto Total</span>
                  </div>
                </div>
                <div>
                  <span id="display-total-spent" class="glass-card-amount gasto-text">S/ 0.00</span>
                  <span class="glass-card-subtitle">Disponible</span>
                </div>
              </div>
              <div id="metrics-container" class="bg-white rounded-3xl shadow-sm border border-gray-100 p-5 w-full md:w-[250px] flex flex-col gap-2">
                <div id="ahorro-mutuo-card" class="flex flex-col justify-center">
                  <p class="text-sm font-semibold text-gray-500">Ahorro Mutuo</p>
                  <span id="display-shared-savings-goal" class="font-extrabold text-purple-600 block">S/ 0.00</span>
                </div>

                <hr class="border-gray-200" />

                <div id="gastos-fijos-card" class="flex flex-col justify-center">
                  <p class="text-sm font-semibold text-gray-500">Gastos fijos totales</p>
                  <span id="display-fixed-total" class="font-extrabold text-yellow-600 block">S/ 0.00</span>
                </div>
              </div>
              <div id="saldos-individuales-card" class="section-card">
                <h3 class="text-2xl font-extrabold text-gray-700">Saldos Individuales</h3>
                <div id="participant-summary-cards" class="grid grid-cols-1 gap-1"></div>
              </div>
            </div>

            <div id="dashboard-bottom-block" class="flex flex-col lg:flex-row gap-6">
              <div class="lg:w-[35%] dashboard-column-left"></div>

              <div class="lg:w-[65%] dashboard-column-right">
                <div class="section-card flex flex-col bg-red-600 text-white p-6 hidden">
                  <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white">Balance de cuentas</h2>
                  </div>
                  <div id="balance-content" class="mt-4 flex-grow">
                    <div id="shared-balance-summary" class="space-y-2 text-lg"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="informe-container">
            <section class="space-y-6">
              <!-- Encabezado del Informe y Filtro de Mes -->
              <div class="report-column flex flex-col md:flex-row justify-between md:items-center gap-4 mb-5">
                <h2 class="text-xl font-bold text-gray-800">Informe de Gastos por Categoría</h2>

                <div class="inline-flex rounded-md shadow-sm" role="group">
                  <button id="open-categories-modal-btn" type="button" class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-s-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700">Categorías</button>

                  <button id="open-payment-methods-modal-btn" type="button" class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 -ml-px hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700">Métodos Pago</button>

                  <button id="open-expense-modal-btn" type="button" class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 -ml-px hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700">
                    <i class="fas mr-1"></i> Añadir Gasto
                  </button>

                  <button id="open-settlement-modal-btn" type="button" class="px-4 py-2 text-sm font-medium text-red-700 bg-white border border-gray-200 -ml-px rounded-e-lg hover:bg-red-50 hover:text-red-800 focus:z-10 focus:ring-2 focus:ring-red-500">
                    <i class="fas fa-handshake mr-1"></i>
                    Liquidar Cuentas
                  </button>
                </div>
              </div>

              <!-- MODIFICADO: Contenedor para el botón de filtros y el popover -->

              <!-- FIN Contenedor Filtros/Popover -->

              <!-- Rejilla de Informes -->
              <div class="grid grid-cols-1 lg:grid-cols-5 gap-5"
              <!-- Columna 1 y 2: Historial de Transacciones -->
              <div class="lg:col-span-3 report-column">
                <div class="space-y-4">
                  <div id="interactive-calendar-container" class="w-full">
                    <div id="calendar-month-header" class="flex items-center justify-between mb-2">
                      <div class="flex items-center gap-2">
                        <button id="prev-month-btn" class="p-2 w-8 h-8 flex items-center justify-center bg-white rounded-lg hover:bg-gray-100 transition shadow-sm border border-gray-200 text-gray-600">
                          <i class="fas fa-chevron-left fa-xs"></i>
                        </button>
                        <button id="next-month-btn" class="p-2 w-8 h-8 flex items-center justify-center bg-white rounded-lg hover:bg-gray-100 transition shadow-sm border border-gray-200 text-gray-600">
                          <i class="fas fa-chevron-right fa-xs"></i>
                        </button>
                      </div>

                      <button id="month-picker-toggle" data-dropdown-toggle="month-list-dropdown" class="px-3 py-2 bg-gray-50 text-gray-700 text-lg font-extrabold rounded-lg hover:bg-gray-100 flex items-center gap-2">
                        <div class="flex items-center gap-1.5">
                          <span id="current-month-name">Cargando</span>
                          <span id="current-year" class="text-gray-500">...</span>
                        </div>
                        <i class="fas fa-chevron-down fa-xs text-gray-500"></i>
                      </button>
                    </div>

                    <div id="month-list-dropdown" class="hidden z-10 bg-white rounded-lg shadow-xl border w-48 p-2">
                      <div class="flex justify-between items-center pb-2 mb-2 border-b">
                        <button id="month-picker-prev-year" type="button" class="p-1 w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500">
                          <i class="fas fa-chevron-left fa-xs"></i>
                        </button>
                        <span id="month-picker-year" class="text-sm font-semibold text-gray-700">2025</span>
                        <button id="month-picker-next-year" type="button" class="p-1 w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500">
                          <i class="fas fa-chevron-right fa-xs"></i>
                        </button>
                      </div>

                      <div id="month-list-container" class="grid grid-cols-3 gap-1"></div>
                    </div>

                    <div id="calendar-week-view" class="mt-4">
                      <div class="grid grid-cols-7 gap-1 mb-2">
                        <span class="text-center text-xs font-medium text-gray-500">Do</span>
                        <span class="text-center text-xs font-medium text-gray-500">Lu</span>
                        <span class="text-center text-xs font-medium text-gray-500">Ma</span>
                        <span class="text-center text-xs font-medium text-gray-500">Mi</span>
                        <span class="text-center text-xs font-medium text-gray-500">Ju</span>
                        <span class="text-center text-xs font-medium text-gray-500">Vi</span>
                        <span class="text-center text-xs font-medium text-gray-500">Sá</span>
                      </div>

                      <div id="calendar-accordion">
                        <div id="calendar-accordion-trigger" class="cursor-pointer">
                          <div id="calendar-grid-current-week" class="grid grid-cols-7 gap-1"></div>
                        </div>

                        <div id="calendar-accordion-content" class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out">
                          <div id="calendar-grid-other-weeks" class="grid grid-cols-7 gap-1 mt-1"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-700">Historial de Transacciones</h3>
                    <div class="relative">
                      <!-- Botón para abrir/cerrar el popover de filtros -->
                      <button id="filter-popover-button" class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-filter mr-2"></i>
                        Filtros
                        <!-- Indicador visual si hay filtros activos -->
                        <span class="active-indicator ml-2 h-2 w-2 bg-indigo-500 rounded-full"></span>
                      </button>

                      <!-- El Popover de Filtros (inicialmente oculto) -->
                      <div id="filter-popover" class="absolute hidden mt-2 right-0 bg-white rounded-lg shadow-xl border border-gray-200 z-30 p-4 space-y-4 filter-popover-width">
                        <!-- Botón para cerrar el popover -->
                        <button id="close-filter-popover-btn" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
                          <i class="fas fa-times"></i>
                        </button>
                        <h4 class="text-lg font-semibold text-gray-800">Filtrar Transacciones</h4>
                        <!-- Área para mostrar etiquetas seleccionadas -->
                        <div id="selected-filter-tags" class="flex flex-wrap gap-1 border-b pb-2 mb-2 min-h-[2rem]">
                          <!-- Etiquetas seleccionadas se añadirán aquí -->
                          <span id="no-filters-label" class="text-xs text-gray-500 italic">No hay filtros aplicados.</span>
                        </div>
                        <!-- Filtro por descripción -->
                        <div>
                          <label for="filter-description" class="block text-xs font-medium text-gray-600 mb-1">Buscar por Descripción:</label>
                          <input type="text" id="filter-description" placeholder="Ej: Supermercado, Luz..." class="w-full mt-1 custom-input text-sm" />
                        </div>
                        <!-- Filtro por etiquetas de Categoría -->
                        <div>
                          <label class="block text-xs font-medium text-gray-600 mb-1">Filtrar por Categoría:</label>
                          <div id="filter-tag-categories" class="flex flex-wrap -m-1">
                            <!-- Etiquetas de categoría se generarán aquí -->
                            <span class="text-xs text-gray-500 italic m-1">Cargando categorías...</span>
                          </div>
                        </div>
                        <!-- Filtro por etiquetas de Participante -->
                        <div>
                          <label class="block text-xs font-medium text-gray-600 mb-1">Filtrar por Pagador:</label>
                          <div id="filter-tag-participants" class="flex flex-wrap -m-1">
                            <!-- Etiquetas de participante se generarán aquí -->
                            <span class="text-xs text-gray-500 italic m-1">Cargando participantes...</span>
                          </div>
                        </div>
                        <!-- NUEVO: Filtro por etiquetas de Método de Pago -->
                        <div>
                          <label class="block text-xs font-medium text-gray-600 mb-1">Filtrar por Método de Pago:</label>
                          <div id="filter-tag-payment-methods" class="flex flex-wrap -m-1">
                            <!-- Etiquetas de método de pago se generarán aquí -->
                            <span class="text-xs text-gray-500 italic m-1">Cargando métodos...</span>
                          </div>
                        </div>
                        <button id="reset-filters-btn" class="w-full py-2 text-sm bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 mt-4">Limpiar Filtros</button>
                      </div>
                    </div>
                  </div>

                  <span class="text-xs text-purple-600 font-semibold block -mt-2" id="expense-diagnostic"></span>
                  <div id="expense-report-by-category" class="space-y-3">
                    <p class="text-gray-500 text-center py-4 italic">No hay gastos en este ciclo.</p>
                  </div>
                </div>
              </div>

              <!-- Columna 3 (1/3): Próximos Gastos Fijos -->
              <aside class="lg:col-span-1 report-column">
                <div class="h-full">
                  <h3><i class="fas fa-calendar-alt mr-2"></i> Próximos Gastos Fijos</h3>
                  <div id="fixed-expenses-summary" class="space-y-2 text-sm">
                    <p class="text-gray-500 italic">No hay gastos fijos registrados.</p>
                  </div>
                </div>
              </aside>
              <div class="lg:col-span-1 report-column">
                <div id="credit-card-summary-section" class="space-y-4">
                  <h3>Resumen métodos de pago</h3>
                  <div id="credit-card-summary-cards" class="flex flex-col gap-3"></div>
                </div>
              </div>
            </section>
          </div>
          <!-- GRÁFICO DE DISTRIBUCIÓN DE GASTOS (Full Width) -->
          <div class="section-card hidden">
            <button id="toggle-chart-btn" class="w-full text-left flex justify-between items-center text-xl font-bold text-gray-700 mb-4 focus:outline-none">
              Distribución de Gastos
              <i id="chart-toggle-icon" class="fas fa-chevron-down transition-transform duration-300"></i>
            </button>
            <div id="chart-collapsible-content">
              <div class="relative h-64 md:h-80 pt-2 border-t border-gray-200">
                <canvas id="category-chart"></canvas>
                <p id="chart-no-data" class="absolute inset-0 flex items-center justify-center text-gray-500 italic hidden">No hay datos para mostrar.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- ========================================================================================= -->
        <!-- SECCIÓN 2: REGISTRO DE GASTO Y BOTONES DE CONFIGURACIÓN (100% ANCHO) -->
        <!-- ========================================================================================= -->
        <div class="max-w-7xl mx-auto px-4 md:px-8 pt-6 hidden">
          <main class="space-y-6">
            <section class="section-card">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-red-700">Registrar Nuevo Gasto</h2>

                <!-- Botones de Configuración Rápida (Movidos aquí) -->
                <div class="flex space-x-2">
                  <button id="open-categories-modal-btn" class="py-1 px-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition duration-300 text-xs">Categorías</button>
                  <button id="open-payment-methods-modal-btn" class="py-1 px-3 bg-yellow-500 text-white font-bold rounded-xl hover:bg-yellow-600 transition duration-300 text-xs">Métodos Pago</button>
                </div>
              </div>
              <form id="expense-form" class="space-y-4">
                <!-- Fila 1: Descripción, Monto -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div class="md:col-span-2">
                    <label for="edit-expense-description" class="block text-sm font-medium text-gray-700">Descripción</label>
                    <input type="text" id="edit-expense-description" required class="w-full mt-1 custom-input" />
                  </div>
                  <div>
                    <label for="edit-expense-amount" class="block text-sm font-medium text-gray-700">Monto (S/)</label>
                    <input type="number" id="edit-expense-amount" min="0.01" step="0.01" required class="w-full mt-1 custom-input" />
                  </div>
                  <div>
                    <label for="edit-expense-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <div class="relative mt-1">
                      <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                        <i class="fas fa-calendar-alt text-gray-500"></i>
                      </div>
                      <input type="text" id="edit-expense-date" class="w-full custom-input ps-10" placeholder="YYYY-MM-DD" required datepicker datepicker-autohide datepicker-format="yyyy-mm-dd" />
                    </div>
                  </div>
                </div>

                <!-- Fila 2: Pagador, Tipo de Gasto, Método de Pago -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <!-- Pagado Por (Custom Select) -->
                  <div>
                    <label for="expense-paid-by-button" class="block text-sm font-medium text-gray-700">Pagado Por</label>
                    <div class="relative custom-select-container mt-1">
                      <button type="button" id="expense-paid-by-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span class="custom-select-display text-gray-500">Selecciona quién pagó</span>
                        <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200"></i>
                      </button>
                      <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20 border border-gray-200">
                        <!-- Opciones populadas por JS -->
                      </div>
                      <input type="hidden" id="expense-paid-by" required />
                    </div>
                  </div>
                  <!-- Tipo de Gasto (Custom Select) -->
                  <div>
                    <label for="expense-type-button" class="block text-sm font-medium text-gray-700">Tipo de Gasto</label>
                    <div class="relative custom-select-container mt-1">
                      <button type="button" id="expense-type-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span class="custom-select-display">Personal</span>
                        <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200"></i>
                      </button>
                      <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20 border border-gray-200">
                        <div class="custom-select-option selected" data-value="personal">Personal</div>
                        <div class="custom-select-option" data-value="shared">Compartido</div>
                      </div>
                      <input type="hidden" id="expense-type" value="personal" required />
                    </div>
                  </div>
                  <!-- Método de Pago (Custom Select) -->
                  <div>
                    <label for="expense-payment-method-id-button" class="block text-sm font-medium text-gray-700">Método de Pago</label>
                    <div class="relative custom-select-container mt-1">
                      <button type="button" id="expense-payment-method-id-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span class="custom-select-display text-gray-500">Selecciona método</span>
                        <i class="fas fa-chevron-down text-gray-400 transition-transform duration-200"></i>
                      </button>
                      <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20 border border-gray-200">
                        <!-- Opciones populadas por JS -->
                      </div>
                      <input type="hidden" id="expense-payment-method-id" required />
                    </div>
                  </div>
                </div>

                <!-- Fila 3: Categoría y Subcategoría -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <!-- Categoría (Custom Select) -->
                  <div>
                    <label for="expense-category-button" class="block text-sm font-medium text-gray-700">Categoría</label>
                    <div class="relative custom-select-container mt-1">
                      <button type="button" id="expense-category-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center">
                        <span class="custom-select-display text-gray-500">Selecciona categoría</span>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                      </button>
                      <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20"></div>
                      <input type="hidden" id="expense-category" required />
                    </div>
                  </div>
                  <!-- Subcategoría (Custom Select) -->
                  <div>
                    <label for="expense-subcategory-button" class="block text-sm font-medium text-gray-700">Subcategoría</label>
                    <div class="relative custom-select-container mt-1">
                      <button type="button" id="expense-subcategory-button" disabled class="custom-select-button w-full text-left custom-input bg-gray-100 flex justify-between items-center">
                        <span class="custom-select-display text-gray-500">Selecciona subcategoría</span>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                      </button>
                      <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20"></div>
                      <input type="hidden" id="expense-subcategory" />
                    </div>
                  </div>
                </div>

                <!-- Fila 4: Opciones y Botón de Añadir -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4 items-end">
                  <!-- Columna 1 y 2: Gasto Fijo y Recurrencia -->
                  <div class="flex items-end space-x-4 md:col-span-2">
                    <div class="flex items-center h-12">
                      <input id="expense-is-fixed" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" />
                      <label for="expense-is-fixed" class="ml-2 block text-sm font-medium text-gray-900">Gasto Fijo</label>
                    </div>
                    <div id="fixed-recurrence-container" class="hidden">
                      <label for="fixed-recurrence-months" class="block text-sm font-medium text-red-700">Meses</label>
                      <input type="number" id="fixed-recurrence-months" min="1" max="60" value="12" class="w-24 mt-1 custom-input" />
                    </div>
                  </div>

                  <!-- Columna 3: Botón de Añadir Gasto -->
                  <div class="md:col-span-1">
                    <button type="submit" class="w-full py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition duration-300">Añadir Gasto</button>
                  </div>
                </div>

                <!-- Información de Ciclo de Tarjeta de Crédito (Condicional) -->
                <div id="credit-card-details" class="space-y-2 p-3 border border-yellow-300 rounded-lg bg-yellow-50 hidden">
                  <p class="font-bold text-xs text-yellow-800">Detalles de Facturación:</p>
                  <div class="flex justify-between text-xs">
                    <span class="text-gray-700">Inicio de Ciclo: <strong id="cc-cycle-start-display" class="font-semibold"></strong></span>
                    <span class="text-gray-700">Límite de Pago: <strong id="cc-payment-date-display" class="font-semibold"></strong></span>
                  </div>
                </div>
              </form>
            </section>
          </main>
        </div>

        <!-- ========================================================================================= -->
        <!-- SECCIÓN 3: INFORMES (GASTOS FIJOS, CALENDARIO, HISTORIAL) -->
        <!-- ========================================================================================= -->
      </div>
    </div>

    <!-- ========================================================================================= -->
    <!-- MODALES -->
    <!-- ========================================================================================= -->

    <!-- NUEVO: Modal de Importación de Datos -->
    <div id="import-json-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-[60]">
      <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
        <h3 class="text-2xl font-bold mb-4 text-gray-800">Importar/Restaurar Datos</h3>
        <p class="text-sm text-gray-600 mb-4">Pega el texto de respaldo (JSON) en el siguiente campo para restaurar tus datos. Esto sobrescribirá todos los datos del monedero actual.</p>
        <form id="import-json-form">
          <textarea id="json-input-area" class="w-full h-48 p-3 border rounded bg-gray-50 text-xs font-mono focus:ring-2 focus:ring-indigo-500" placeholder="Pega el texto JSON aquí..."></textarea>
          <div class="grid grid-cols-2 gap-3 mt-6">
            <button type="submit" id="confirm-import-btn" class="py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">Confirmar Importación</button>
            <button type="button" id="cancel-import-btn" class="py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de Mensajes -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-[70]">
      <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
        <h3 class="text-xl font-bold mb-4 text-gray-800" id="modal-title">Atención</h3>
        <p id="modal-text" class="mb-4 text-gray-600"></p>

        <!-- NUEVA ÁREA DE DETALLE DE ERROR -->
        <div id="modal-error-detail" class="bg-red-50 p-3 rounded-lg border border-red-200 mt-4 hidden">
          <p class="text-xs font-semibold text-red-700 mb-1">Detalle Técnico:</p>
          <code id="modal-error-code" class="text-xs text-red-600 break-words block"></code>
        </div>
        <!-- FIN NUEVA ÁREA DE DETALLE DE ERROR -->

        <button id="close-modal-btn" class="w-full py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition duration-300">Cerrar</button>
      </div>
    </div>

    <!-- Modal de Categorías -->
    <div id="categories-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-50">
      <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
        <h3 class="text-2xl font-bold mb-4 text-green-700">Configuración de Categorías y Presupuestos</h3>
        <form id="category-form" class="space-y-3 mb-6 p-4 border border-green-200 rounded-lg bg-green-50">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <input type="text" id="category-name" placeholder="Nueva Categoría (Ej: Hogar)" required class="w-full custom-input" />
            <input type="number" id="category-budget" placeholder="Presupuesto Mensual (S/)" min="0" class="w-full custom-input" />
          </div>
          <input type="text" id="subcategory-list" placeholder="Subcategorías (Separadas por coma: Servicios, Comida, ...)" class="w-full custom-input" />
          <button type="submit" class="w-full py-2 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition duration-300">Guardar Categoría</button>
        </form>

        <h4 class="font-bold text-gray-700 mb-3">Categorías Existentes:</h4>
        <div id="categories-display" class="space-y-2 max-h-64 overflow-y-auto">
          <p class="text-sm text-gray-500 italic" id="no-categories">No hay categorías definidas.</p>
          <!-- Categorías se cargan aquí -->
        </div>

        <button id="close-categories-modal-btn" class="w-full mt-6 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition duration-300">Cerrar</button>
      </div>
    </div>

    <!-- Modal de Métodos de Pago -->
    <div id="payment-methods-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-50">
      <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
        <h3 class="text-2xl font-bold mb-4 text-yellow-700">Configuración de Métodos de Pago</h3>

        <h4 class="font-bold text-gray-700 mb-3">Métodos Existentes:</h4>
        <div id="payment-methods-display" class="space-y-2 mb-6 max-h-48 overflow-y-auto">
          <p class="text-sm text-gray-500 italic">No hay métodos definidos.</p>
          <!-- Métodos se cargan aquí con botón de edición -->
        </div>

        <h4 class="font-bold text-gray-700 mb-3" id="payment-form-title">Añadir Nuevo Método:</h4>
        <form id="payment-method-form" class="space-y-3 p-4 border border-yellow-200 rounded-lg bg-yellow-50">
          <input type="hidden" id="method-id-to-edit" />
          <input type="text" id="method-name" placeholder="Nombre del Método (Ej: Visa Banco X)" required class="w-full custom-input" />
          <select type="select" id="method-type" class="w-full p-2 border border-gray-300 rounded-lg bg-white" required>
            <option value="cash">Efectivo/Débito</option>
            <option value="credit">Tarjeta de Crédito</option>
          </select>

          <div id="cc-config-fields" class="space-y-3 hidden">
            <h4 class="font-bold text-yellow-800">Configuración de Ciclo (Crédito)</h4>
            <label for="cc-config-payment-day" class="block text-sm font-medium text-gray-700">Día Límite de Pago (1-31)</label>
            <input type="number" id="cc-config-payment-day" min="1" max="31" placeholder="Ej: 5 (pagas el 5 de cada mes)" class="w-full custom-input" />
          </div>

          <button type="submit" id="save-method-btn" class="w-full py-2 bg-yellow-500 text-white font-bold rounded-xl shadow-lg hover:bg-yellow-600 transition duration-300">Añadir Método</button>
          <button type="button" id="cancel-edit-method-btn" class="w-full py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition duration-300 hidden">Cancelar Edición</button>
        </form>

        <button id="close-payment-methods-modal-btn" class="w-full mt-6 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition duration-300">Cerrar</button>
      </div>
    </div>

    <!-- Modal de Añadir/Editar Participante -->
    <div id="add-participant-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-50">
      <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
        <h3 class="text-2xl font-bold mb-4 text-purple-700" id="participant-modal-title">Añadir Participante</h3>
        <form id="participant-form" class="space-y-4">
          <input type="hidden" id="participant-id-to-edit" />

          <label for="p-name" class="block text-sm font-medium text-gray-700">Nombre</label>
          <input type="text" id="p-name" required class="w-full custom-input" />

          <label for="p-budget" class="block text-sm font-medium text-gray-700">Monto Total del Mes (S/)</label>
          <input type="number" id="p-budget" min="0" required class="w-full custom-input" />

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="p-shared-savings" class="block text-sm font-medium text-purple-700">Ahorro Mutuo (%):</label>
              <input type="number" id="p-shared-savings" min="0" max="100" required class="w-full mt-1 custom-input" />
            </div>
            <div>
              <label for="p-independent-savings" class="block text-sm font-medium text-purple-700">Ahorro Indep. (%):</label>
              <input type="number" id="p-independent-savings" min="0" max="100" required class="w-full mt-1 custom-input" />
            </div>
          </div>

          <button type="submit" id="save-participant-btn" class="w-full py-3 bg-purple-500 text-white font-bold rounded-xl hover:bg-purple-600 transition duration-300">Guardar Participante</button>
        </form>
        <button id="close-participant-modal-btn" class="w-full mt-4 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition duration-300">Cerrar</button>
      </div>
    </div>

    <!-- Modal de Edición de Gasto -->
    <div id="edit-expense-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-50">
      <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
        <h3 class="text-2xl font-bold mb-4 text-red-700">Editar Gasto</h3>
        <form id="edit-expense-form" class="space-y-4">
          <input type="hidden" id="edit-expense-id" />

          <!-- Fila 1: Descripción y Monto -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <label for="edit-expense-description" class="block text-sm font-medium text-gray-700">Descripción</label>
              <input type="text" id="edit-expense-description" required class="w-full mt-1 custom-input" />
            </div>
            <div>
              <label for="edit-expense-amount" class="block text-sm font-medium text-gray-700">Monto (S/)</label>
              <input type="number" id="edit-expense-amount" min="0.01" step="0.01" required class="w-full mt-1 custom-input" />
            </div>
          </div>

          <!-- Fila 2: Pagador, Tipo, Método de Pago -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label for="edit-expense-payer-button" class="block text-sm font-medium text-gray-700">Pagado Por</label>
              <div class="relative custom-select-container mt-1">
                <button type="button" id="edit-expense-payer-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center">
                  <span class="custom-select-display text-gray-500">Selecciona pagador</span>
                  <i class="fas fa-chevron-down text-gray-400"></i>
                </button>
                <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-30"></div>
                <input type="hidden" id="edit-expense-payer" />
              </div>
              <button type="button" id="add-guest-payer-btn" class="mt-2 w-full text-xs py-1 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">+ Añadir Invitado</button>
            </div>
            <div>
              <label for="edit-expense-type-button" class="block text-sm font-medium text-gray-700">Tipo de Gasto</label>
              <div class="relative custom-select-container mt-1">
                <button type="button" id="edit-expense-type-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center">
                  <span class="custom-select-display"></span>
                  <i class="fas fa-chevron-down text-gray-400"></i>
                </button>
                <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-30">
                  <div class="custom-select-option" data-value="personal">Personal</div>
                  <div class="custom-select-option" data-value="shared">Compartido</div>
                </div>
                <input type="hidden" id="edit-expense-type" />
              </div>
            </div>
            <div>
              <label for="edit-expense-payment-method-id-button" class="block text-sm font-medium text-gray-700">Método de Pago</label>
              <div class="relative custom-select-container mt-1">
                <button type="button" id="edit-expense-payment-method-id-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center">
                  <span class="custom-select-display text-gray-500">Selecciona método</span>
                  <i class="fas fa-chevron-down text-gray-400"></i>
                </button>
                <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-30"></div>
                <input type="hidden" id="edit-expense-payment-method-id" />
              </div>
            </div>
          </div>
          <div id="guest-payer-input-container" class="hidden">
            <label for="guest-payer-name" class="block text-sm font-medium text-gray-700">Nombre del Invitado</label>
            <input type="text" id="guest-payer-name" class="w-full mt-1 custom-input" />
          </div>

          <!-- Fila 3: Categoría y Subcategoría -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="edit-expense-category-button" class="block text-sm font-medium text-gray-700">Categoría</label>
              <div class="relative custom-select-container mt-1">
                <button type="button" id="edit-expense-category-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center">
                  <span class="custom-select-display text-gray-500">Selecciona categoría</span>
                  <i class="fas fa-chevron-down text-gray-400"></i>
                </button>
                <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20"></div>
                <input type="hidden" id="edit-expense-category" required />
              </div>
            </div>
            <div>
              <label for="edit-expense-subcategory-button" class="block text-sm font-medium text-gray-700">Subcategoría</label>
              <div class="relative custom-select-container mt-1">
                <button type="button" id="edit-expense-subcategory-button" class="custom-select-button w-full text-left custom-input flex justify-between items-center">
                  <span class="custom-select-display text-gray-500">Selecciona subcategoría</span>
                  <i class="fas fa-chevron-down text-gray-400"></i>
                </button>
                <div class="custom-select-options absolute hidden mt-1 w-full bg-white rounded-lg shadow-lg z-20"></div>
                <input type="hidden" id="edit-expense-subcategory" />
              </div>
            </div>
          </div>

          <!-- Checkbox Gasto Fijo -->
          <div class="flex items-center">
            <input id="edit-expense-is-fixed" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" />
            <label for="edit-expense-is-fixed" class="ml-2 block text-sm text-gray-900">Marcar como Gasto Fijo</label>
          </div>

          <button type="submit" class="w-full py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition duration-300 mt-4">Guardar Cambios</button>
        </form>
        <button id="close-edit-expense-modal-btn" class="w-full mt-4 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition duration-300">Cerrar</button>
      </div>
    </div>

    <!-- Modal de Confirmación de Cierre de Sesión -->
    <div id="logout-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-50">
      <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
        <h3 class="text-xl font-bold mb-4 text-red-700">Confirmar Cierre de Sesión</h3>
        <p class="mb-6 text-gray-600">¿Estás seguro de que quieres cerrar la sesión? Serás redirigido al portal de inicio de sesión.</p>
        <div class="grid grid-cols-2 gap-3">
          <button id="confirm-logout-btn" class="py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition">Sí, Cerrar Sesión</button>
          <button id="cancel-logout-btn" class="py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition">Cancelar</button>
        </div>
      </div>
    </div>
    <div id="payment-method-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-[60]">
      <div class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4 border-b pb-3">
          <h3 class="text-2xl font-bold text-gray-800 modal-title">Gastos de: ...</h3>
          <button id="close-payment-detail-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>

        <div id="modal-expense-list" class="overflow-y-auto space-y-3 pr-2 flex-grow">
          <p class="text-gray-500 italic">Cargando gastos...</p>
        </div>
      </div>
    </div>
    <div id="add-expense-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-50">
      <div class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-bold text-red-700" id="expense-modal-title">Registrar Gasto</h3>
          <button id="close-expense-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>

        <form id="new-expense-form" class="space-y-4 overflow-y-auto pr-2 flex-grow">
          <input type="hidden" id="expense-id-to-edit" />
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-2">
              <label for="new-expense-description" class="block text-sm font-medium text-gray-700">Descripción</label>
              <input type="text" id="new-expense-description" required class="w-full mt-1 custom-input" />
            </div>
            <div>
              <label for="new-expense-amount" class="block text-sm font-medium text-gray-700">Monto (S/)</label>
              <input type="number" id="new-expense-amount" min="0.01" step="0.01" required class="w-full mt-1 custom-input" />
            </div>
            <div>
              <label for="new-expense-date" class="block text-sm font-medium text-gray-700">Fecha</label>
              <div class="relative mt-1">
                <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                  <i class="fas fa-calendar-alt text-gray-500"></i>
                </div>
                <input type="text" id="new-expense-date" class="w-full custom-input ps-10" placeholder="YYYY-MM-DD" required datepicker datepicker-autohide datepicker-format="yyyy-mm-dd" />
              </div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Pagado Por</label>
            <div id="modal-payer-tags" class="flex flex-wrap gap-2 border p-2 rounded-lg bg-gray-50 min-h-[40px]">
              <span class="text-xs text-gray-500 italic">Cargando...</span>
            </div>
            <input type="hidden" id="new-expense-payer" required />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Gasto</label>
            <div id="modal-type-tags" class="flex flex-wrap gap-2 border p-2 rounded-lg bg-gray-50">
              <button type="button" data-value="personal" class="filter-tag">Personal</button>
              <button type="button" data-value="shared" class="filter-tag">Compartido</button>
            </div>
            <input type="hidden" id="new-expense-type" value="personal" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Método de Pago</label>
            <div id="modal-payment-method-tags" class="flex flex-wrap gap-2 border p-2 rounded-lg bg-gray-50 min-h-[40px]">
              <span class="text-xs text-gray-500 italic">Cargando...</span>
            </div>
            <input type="hidden" id="new-expense-payment-method" required />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
            <div id="modal-category-tags" class="flex flex-wrap gap-2 border p-2 rounded-lg bg-gray-50 min-h-[40px]">
              <span class="text-xs text-gray-500 italic">Cargando...</span>
            </div>
            <input type="hidden" id="new-expense-category" required />
          </div>

          <div id="modal-subcategory-section" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">Subcategoría</label>
            <div id="modal-subcategory-tags" class="flex flex-wrap gap-2 border p-2 rounded-lg bg-gray-50 min-h-[40px]"></div>
            <input type="hidden" id="new-expense-subcategory" />
          </div>

          <div class="flex items-center pt-2">
            <input id="new-expense-is-fixed" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" />
            <label for="new-expense-is-fixed" class="ml-2 block text-sm font-medium text-gray-900">Gasto Fijo</label>
          </div>
          <div id="new-fixed-recurrence-container" class="hidden ml-6">
            <label for="new-fixed-recurrence-months" class="block text-sm font-medium text-red-700">Meses</label>
            <input type="number" id="new-fixed-recurrence-months" min="1" max="60" value="12" class="w-24 mt-1 custom-input" />
          </div>
        </form>

        <div class="mt-6 pt-4 border-t flex gap-3">
          <button type="submit" form="new-expense-form" class="flex-1 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition">Guardar Gasto</button>
          <button type="button" id="cancel-expense-modal-btn" class="flex-1 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition">Cancelar</button>
        </div>
      </div>
    </div>

    <div id="settlement-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-[60]">
      <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4 border-b pb-3">
          <h3 class="text-2xl font-bold text-red-700"><i class="fas fa-handshake mr-2"></i>Resumen de Liquidación</h3>
          <button id="close-settlement-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>

        <div id="settlement-summary-content" class="overflow-y-auto space-y-3 pr-2 flex-grow">
          <p class="text-gray-500 italic">Calculando liquidación...</p>
        </div>

        <button id="close-settlement-modal-btn-bottom" class="w-full mt-6 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition duration-300">Cerrar</button>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>

    <!-- Scripts de Firebase -->
    <script type="module">
      // Importaciones de Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc, writeBatch, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      setLogLevel("Debug");

      // ====================================================================================
      // --- CONFIGURACIÓN Y ESTADO GLOBAL ---
      // ====================================================================================

      const myFirebaseConfig = {
        apiKey: "AIzaSyA63OZWFM30Tu17DGxAmbtVsNFWeQU3k4s",
        authDomain: "qipu-d1dcd.firebaseapp.com",
        projectId: "qipu-d1dcd",
        storageBucket: "qipu-d1dcd.firebasestorage.app",
        messagingSenderId: "398775085739",
        appId: "1:398775085739:web:be8643b5d9fea9ef8da5ee",
      };

      const REDIRECT_URL_LOGOUT = "index.html";

      const IS_CANVAS_ENV = typeof __initial_auth_token !== "undefined";

      let firebaseConfig = IS_CANVAS_ENV ? (typeof __firebase_config !== "undefined" ? JSON.parse(__firebase_config) : myFirebaseConfig) : myFirebaseConfig;

      const appId = typeof __app_id !== "undefined" ? __app_id : firebaseConfig.projectId || "default-app-id";
      const initialAuthToken = typeof __initial_auth_token !== "undefined" ? __initial_auth_token : null;

      let app, db, auth;
      let userId = "loading";
      let currentWalletId = null;
      let isFirebaseActive = Object.keys(firebaseConfig).length > 0 && !Object.keys(firebaseConfig).some((k) => firebaseConfig[k].startsWith("TU_"));

      // --- NUEVAS RUTAS DE FIRESTORE ---
      const getUserProfileRef = (db, uid) => doc(db, "artifacts", appId, "users", uid);
      const getOldUserFinanceDocRef = (db, uid) => doc(db, "artifacts", appId, "users", uid, "finance_tracker", "main_finance_state");
      const getWalletDocRef = (db, walletId) => doc(db, "artifacts", appId, "public/data/wallets", walletId);
      const getWalletsCollectionRef = (db) => collection(db, "artifacts", appId, "public/data/wallets");

      const LOCAL_STORAGE_KEY = "finance_tracker_local_data";

      const MONTH_NAMES = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      const DAY_NAMES = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];

      let appState = {
        participants: [],
        categories: [],
        paymentMethods: [],
        expenses: [],
      };

      let currentFilterDate = new Date();
      currentFilterDate.setDate(1);

      let monthPickerYear = new Date().getFullYear();
      let myParticipantId = null;
      let unsubscribeListener = null;
      let currentSidebarPanel = "participants";
      // Función para gestionar los paneles
      function showSidebarPanel(panelId) {
        // 1. Ocultar todos los paneles
        document.querySelectorAll(".sidebar-panel").forEach((panel) => {
          panel.classList.add("hidden");
        });

        // 2. Mostrar el panel objetivo
        const targetPanel = document.getElementById(`panel-content-${panelId}`);
        if (targetPanel) {
          targetPanel.classList.remove("hidden");
        }

        // 3. Guardar el estado
        currentSidebarPanel = panelId;
      }
      const toggleSidebar = (open) => {
        const sidebar = document.getElementById("participant-sidebar");
        const appLayout = document.getElementById("app-layout");

        if (open) {
          // Si se pide abrir, muestra el panel que estaba activo
          showSidebarPanel(currentSidebarPanel);
        }

        sidebar.classList.toggle("open", open);
        appLayout.classList.toggle("sidebar-is-open", open);
      };
      let categoryChart = null;
      let addExpenseDatepicker = null; // <-- AÑADE ESTA
      let editExpenseDatepicker = null;
      let activePopovers = []; // <-- AÑADE ESTA
      let paymentMethodPopovers = [];

      // NUEVO: Estado para los filtros activos
      let activeFilters = {
        description: "",
        category: null, // Almacenará el nombre de la categoría
        participant: null, // Almacenará el ID del participante
        paymentMethod: null,
        guestOnly: false, // NUEVO: Almacenará el ID del método de pago
      };

      // --- NUEVAS FUNCIONES PARA EL MODAL DE GASTOS ---

      // Abre el modal de gastos
      function openExpenseModal() {
        // Resetea el formulario antes de mostrarlo
        resetExpenseModalForm();
        // Popula las etiquetas dinámicamente
        populateModalTags();
        // Muestra el modal
        document.getElementById("new-expense-date").value = new Date().toISOString().split("T")[0];
        document.getElementById("add-expense-modal").classList.remove("hidden");
        document.getElementById("add-expense-modal").classList.add("flex");
        document.body.classList.add("no-scroll"); // Evita scroll de fondo
        const datepickerEl = document.getElementById("new-expense-date");

        // Usamos window.Datepicker para acceder desde el módulo
        if (datepickerEl && typeof window.Datepicker !== "undefined") {
          // Destruye cualquier instancia vieja para evitar conflictos
          if (addExpenseDatepicker) {
            addExpenseDatepicker.destroy();
          }

          // Crea la nueva instancia
          addExpenseDatepicker = new window.Datepicker(datepickerEl, {
            format: "yyyy-mm-dd",
            autohide: true,
          });

          // Pone la fecha de hoy
          addExpenseDatepicker.setDate(new Date());
        }
        // --- FIN DEL CÓDIGO NUEVO ---
      }
      // --- NUEVA FUNCIÓN PARA MANEJAR CLICS EN TABS DE CICLO ---
      function setupCycleTabs() {
        const container = document.getElementById("credit-card-summary-cards");
        container.addEventListener("click", (e) => {
          const tabButton = e.target.closest(".cycle-tab-btn");
          if (!tabButton) return;

          e.preventDefault();
          const tabGroup = tabButton.closest(".cycle-tab-nav");
          const tabCard = tabButton.closest(".cycle-tab-card");
          const targetPaneId = tabButton.dataset.target; // e.g., "pane-current-m123"

          // 1. Actualizar botones
          tabGroup.querySelectorAll(".cycle-tab-btn").forEach((btn) => btn.classList.remove("active"));
          tabButton.classList.add("active");

          // 2. Actualizar paneles de contenido
          tabCard.querySelectorAll(".cycle-tab-content").forEach((pane) => {
            pane.classList.toggle("active", pane.id === targetPaneId);
          });
        });
      }

      // Cierra el modal de gastos
      function closeExpenseModal() {
        document.getElementById("add-expense-modal").classList.add("hidden");
        document.getElementById("add-expense-modal").classList.remove("flex");
        document.body.classList.remove("no-scroll");
        if (addExpenseDatepicker) {
          addExpenseDatepicker.destroy();
          addExpenseDatepicker = null;
        }
      }
      // --- NUEVA FUNCIÓN PARA RENDERIZAR FILAS SIMPLES DE GASTOS ---
      // ================================================================
      // ===== REEMPLAZA ESTA FUNCIÓN COMPLETA =====
      // ================================================================

      // --- NUEVA VERSIÓN QUE MUESTRA EL DESGLOSE DE "A QUIÉN LE TOCA PAGAR" ---
      function createSimpleExpenseRowHTML(expense, participantsMap) {
        const dateObj = new Date(expense.date + "T00:00:00Z");

        // Formato de fecha "05 Nov"
        const formattedDate = dateObj
          .toLocaleDateString("es-ES", {
            day: "2-digit",
            month: "short",
            timeZone: "UTC",
          })
          .replace(".", "");

        const payerName = participantsMap.get(expense.payerId) || expense.payerNameGuest || "Desconocido";
        const subcategoryLabel = expense.subcategory ? ` (${expense.subcategory})` : "";
        const isProjected = expense.isProjected;

        let breakdownHtml = ""; // Aquí irá el desglose

        if (expense.type === "shared") {
          // Si el gasto es compartido, calculamos la parte de cada uno
          const allParticipants = Array.from(participantsMap.values()); // ["U1", "U2"]
          const numPayees = expense.payerId.startsWith("guest_") ? allParticipants.length + 1 : allParticipants.length;
          const splitAmount = expense.amount / numPayees;

          // Creamos una etiqueta (tag) para cada participante
          breakdownHtml = allParticipants
            .map((name) => {
              return `<span class="expense-card-tag participant">${name}: ${formatCurrency(splitAmount)}</span>`;
            })
            .join("");

          // Añadimos la parte del invitado si aplica
          if (expense.payerId.startsWith("guest_")) {
            breakdownHtml += `<span class="expense-card-tag participant">Invitado: ${formatCurrency(splitAmount)}</span>`;
          }

          // Ponemos todo dentro de un contenedor
          breakdownHtml = `
      <div class="mt-2 pt-2 border-t border-gray-200">
        <p class="text-xs font-semibold text-gray-600 mb-1">Desglose (Compartido):</p>
        <div class="flex flex-wrap gap-1">
          ${breakdownHtml}
        </div>
      </div>
    `;
        } else {
          // Si es personal, el desglose es simple
          breakdownHtml = `
      <div class="mt-2 pt-2 border-t border-gray-200">
        <p class="text-xs font-semibold text-gray-600 mb-1">Desglose (Personal):</p>
        <div class="flex flex-wrap gap-1">
          <span class="expense-card-tag category">100% de ${payerName}</span>
        </div>
      </div>
    `;
        }

        // Este es el HTML final de la fila
        return `
    <div class="flex items-center justify-between p-3 bg-white hover:bg-gray-50 rounded-lg border border-gray-200 ${isProjected ? "opacity-70 border-dashed" : ""}">
      
      <div class="text-center w-12 flex-shrink-0 mr-3">
        <span class="block font-bold text-sm text-gray-800">${formattedDate.split(" ")[0]}</span>
        <span class="block text-xs text-gray-500 uppercase">${formattedDate.split(" ")[1]}</span>
      </div>

      <div class="flex-grow">
        <div>
          <p class="font-semibold text-gray-900">${expense.description}${subcategoryLabel}</p>
          <p class="text-xs text-gray-600">Pagado por: ${payerName}</p>
        </div>
        ${breakdownHtml}
      </div>
      
      <div class="text-right ml-2 flex-shrink-0">
        <span class="font-bold text-lg text-red-600">${formatCurrency(expense.amount)}</span>
      </div>
    </div>
  `;
      }
      // ================================================================
      // ===== FIN DEL REEMPLAZO =====
      // ================================================================
      // Resetea el formulario del modal a su estado inicial
      function resetExpenseModalForm() {
        document.getElementById("new-expense-form").reset();
        document.getElementById("expense-id-to-edit").value = ""; // Limpia ID de edición
        document.getElementById("expense-modal-title").textContent = "Registrar Gasto"; // Título por defecto
        // Limpia las selecciones de etiquetas (remueve clase 'active')
        document.querySelectorAll("#add-expense-modal .filter-tag.active").forEach((tag) => tag.classList.remove("active"));
        // Limpia los inputs ocultos
        document.getElementById("new-expense-payer").value = "";
        document.getElementById("new-expense-payment-method").value = "";
        document.getElementById("new-expense-category").value = "";
        document.getElementById("new-expense-subcategory").value = "";
        // Oculta subcategorías y recurrencia
        document.getElementById("modal-subcategory-section").classList.add("hidden");
        document.getElementById("new-fixed-recurrence-container").classList.add("hidden");

        // **AÑADIDO/CORREGIDO: Pre-selecciona 'Personal' por defecto**
        const personalTag = document.querySelector('#modal-type-tags button[data-value="personal"]');
        if (personalTag) {
          personalTag.classList.add("active");
          document.getElementById("new-expense-type").value = "personal";
        }
      }
      // --- NUEVAS FUNCIONES PARA EL MODAL DE DETALLE DE GASTOS ---

      // --- NUEVAS FUNCIONES PARA EL MODAL DE DETALLE DE GASTOS ---

      function openPaymentMethodDetailModal(methodId) {
        const method = appState.paymentMethods.find((m) => m.id === methodId);
        if (!method) return;

        const modal = document.getElementById("payment-method-detail-modal");
        const titleEl = modal.querySelector(".modal-title");
        const contentEl = modal.querySelector("#modal-expense-list");

        titleEl.textContent = `Gastos de: ${method.name}`;

        // --- 1. INICIO DE LA LÓGICA MODIFICADA ---
        const allExpenses = appState.expenses || []; // Obtiene TODOS los gastos
        let expensesForMethod = []; // Array para los gastos filtrados

        if (method.type === "credit") {
          // LÓGICA DE CICLO (USA 'allExpenses' y 'today')
          const today = new Date();
          const { startDate, closingDate } = getCycleDates(method, today);

          if (startDate && closingDate) {
            const cycleStart = new Date(startDate + "T00:00:00Z").getTime();
            const cycleEnd = new Date(closingDate + "T00:00:00Z").getTime();

            expensesForMethod = allExpenses.filter((exp) => {
              const expenseDate = new Date(exp.date + "T00:00:00Z").getTime();
              return exp.paymentMethodId === method.id && !isNaN(expenseDate) && expenseDate >= cycleStart && expenseDate <= cycleEnd;
            });
          }
        } else {
          // LÓGICA DE MES (Efectivo/Débito) - (Usa 'expensesForMonth' como antes)
          const expensesForMonth = getExpensesForCurrentView();
          expensesForMethod = expensesForMonth.filter((e) => e.paymentMethodId === methodId);
        }
        // --- FIN DE LA LÓGICA MODIFICADA ---

        if (expensesForMethod.length === 0) {
          contentEl.innerHTML = `<p class="text-gray-500 italic text-center py-4">No hay gastos registrados con este método en este ciclo.</p>`;
        } else {
          // ¡ASEGÚRATE DE QUE ESTA LÍNEA ESTÉ ASÍ!
          const participantsMap = new Map(appState.participants.map((p) => [p.id, p.name]));

          contentEl.innerHTML = expensesForMethod
            .sort((a, b) => new Date(b.dateCreated || b.date + "T00:00:00Z") - new Date(a.dateCreated || a.date + "T00:00:00Z"))
            // Esta llamada ahora usará la nueva función y le pasará el 'participantsMap'
            .map((exp) => createSimpleExpenseRowHTML(exp, participantsMap))
            .join("");
        }

        modal.classList.remove("hidden");
        modal.classList.add("flex");
        document.body.classList.add("no-scroll");
      }

      function closePaymentMethodDetailModal() {
        const modal = document.getElementById("payment-method-detail-modal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        document.body.classList.remove("no-scroll");
      }

      function setupPaymentMethodModalListeners() {
        // Listener para cerrar el modal
        document.getElementById("close-payment-detail-modal-btn").addEventListener("click", closePaymentMethodDetailModal);

        // Listener de delegación para abrir el modal
        const container = document.getElementById("credit-card-summary-cards");
        container.addEventListener("click", (e) => {
          // Busca la tarjeta clickeada (excluyendo el popover)
          const card = e.target.closest(".payment-method-summary-card");

          // Asegurarnos de no estar clickeando dentro de un popover
          const inPopover = e.target.closest("[data-popover]");

          if (card && card.dataset.methodId && !inPopover) {
            openPaymentMethodDetailModal(card.dataset.methodId);
          }
        });
      }

      // Popula los contenedores de etiquetas en el modal
      function populateModalTags() {
        const payerContainer = document.getElementById("modal-payer-tags");
        const methodContainer = document.getElementById("modal-payment-method-tags");
        const categoryContainer = document.getElementById("modal-category-tags");

        payerContainer.innerHTML = appState.participants.length > 0 ? appState.participants.map((p) => `<button type="button" data-value="${p.id}" class="filter-tag participant-tag">${p.name}</button>`).join("") : '<span class="text-xs text-gray-500 italic">Añade participantes primero.</span>';

        methodContainer.innerHTML =
          appState.paymentMethods.length > 0 ? appState.paymentMethods.map((m) => `<button type="button" data-value="${m.id}" class="filter-tag payment-method-tag">${m.name}</button>`).join("") : '<span class="text-xs text-gray-500 italic">Añade métodos de pago primero.</span>';

        categoryContainer.innerHTML = appState.categories.length > 0 ? appState.categories.map((c) => `<button type="button" data-value="${c.name}" class="filter-tag category-tag">${c.name}</button>`).join("") : '<span class="text-xs text-gray-500 italic">Añade categorías primero.</span>';

        // Limpia subcategorías inicialmente
        document.getElementById("modal-subcategory-tags").innerHTML = "";
        document.getElementById("modal-subcategory-section").classList.add("hidden");
      }

      // Maneja la selección de etiquetas dentro del modal
      function handleModalTagSelection(event) {
        const clickedTag = event.target.closest(".filter-tag");
        if (!clickedTag) return; // No se hizo clic en una etiqueta

        const container = clickedTag.parentElement;
        // Ejemplo: container.id = 'modal-payment-method-tags'
        const baseId = container.id.replace("-tags", "").replace("modal-", ""); // Obtiene 'payment-method'
        const hiddenInput = document.getElementById(`new-expense-${baseId}`); // Construye 'new-expense-payment-method'

        if (!hiddenInput) {
          console.error(`Hidden input not found for ID: new-expense-${baseId}`); // Log de error si no encuentra el input
          return;
        }

        const value = clickedTag.dataset.value;
        const isActive = clickedTag.classList.contains("active");

        // Deseleccionar todas las etiquetas en el mismo contenedor
        container.querySelectorAll(".filter-tag").forEach((tag) => tag.classList.remove("active"));

        // Si se hizo clic en una etiqueta que no estaba activa, activarla
        if (!isActive) {
          clickedTag.classList.add("active");
          hiddenInput.value = value;
        } else {
          // Si se hizo clic en una etiqueta activa, desactivarla (limpiar selección)
          hiddenInput.value = "";
        }
        // Disparar evento change manualmente para lógica dependiente (subcategorías)
        hiddenInput.dispatchEvent(new Event("change", { bubbles: true }));
      }

      // Actualiza las etiquetas de subcategoría basadas en la categoría seleccionada
      function updateModalSubcategoryTags() {
        const selectedCategoryName = document.getElementById("new-expense-category").value;
        const subcategorySection = document.getElementById("modal-subcategory-section");
        const subcategoryContainer = document.getElementById("modal-subcategory-tags");
        const subcategoryInput = document.getElementById("new-expense-subcategory");

        subcategoryInput.value = ""; // Limpiar subcategoría al cambiar categoría
        subcategoryContainer.innerHTML = ""; // Limpiar etiquetas existentes

        const category = appState.categories.find((c) => c.name === selectedCategoryName);

        if (category && category.subcategories && category.subcategories.length > 0) {
          subcategoryContainer.innerHTML = category.subcategories.map((sub) => `<button type="button" data-value="${sub}" class="filter-tag">${sub}</button>`).join("");
          subcategorySection.classList.remove("hidden");
        } else {
          subcategorySection.classList.add("hidden");
        }
      }

      // Guarda el gasto desde el modal
      function handleSaveExpenseFromModal(event) {
        event.preventDefault();
        try {
          const description = formatTitleCase(document.getElementById("new-expense-description").value);
          const amount = parseFloat(document.getElementById("new-expense-amount").value);
          const date = document.getElementById("new-expense-date").value; // <-- AÑADIDA
          const payerId = document.getElementById("new-expense-payer").value;
          const type = document.getElementById("new-expense-type").value;
          const category = document.getElementById("new-expense-category").value;
          const subcategory = formatTitleCase(document.getElementById("new-expense-subcategory").value);
          const paymentMethodId = document.getElementById("new-expense-payment-method").value;
          const isFixed = document.getElementById("new-expense-is-fixed").checked;

          // **AÑADIDO: Validación de campos por ID de input oculto**
          if (!description || !amount || amount <= 0 || !payerId || !category || !paymentMethodId || !type || !date) {
            // <-- AÑADIDO '!date'
            let missingFields = [];
            if (!description) missingFields.push("Descripción");
            if (!amount || amount <= 0) missingFields.push("Monto (mayor a 0)");
            if (!date) missingFields.push("Fecha"); // <-- AÑADIDO
            if (!payerId) missingFields.push("Pagado Por");
            if (!category) missingFields.push("Categoría");
            if (!paymentMethodId) missingFields.push("Método de Pago");

            return showModal(`Completa los siguientes campos: ${missingFields.join(", ")}.`);
          }

          const paymentMethod = appState.paymentMethods.find((m) => m.id === paymentMethodId);
          const { startDate, paymentDate } = paymentMethod && paymentMethod.type === "credit" ? getCycleDates(paymentMethod, new Date()) : {};
          const fixedRecurrenceMonths = isFixed ? parseInt(document.getElementById("new-fixed-recurrence-months").value) || 1 : 0;

          const newExpense = {
            id: generateUUID(),
            description,
            amount,
            payerId,
            type,
            category,
            subcategory: subcategory || null, // Asegurar null si está vacío
            paymentMethodId,
            isFixed,
            //date: new Date().toISOString().split('T')[0],
            date: date,
            dateCreated: new Date().toISOString(),
            ccCycleStart: startDate || null,
            ccPaymentDate: paymentDate || null,
            fixedRecurrenceMonths,
          };

          saveState({ expenses: [...appState.expenses, newExpense] });
          closeExpenseModal(); // Cierra el modal después de guardar
          showModal("Gasto añadido exitosamente.", null, "Éxito"); // Feedback
        } catch (error) {
          showModal("Error al guardar el gasto.", error.message);
        }
      }

      // --- CONFIGURACIÓN DE EVENT LISTENERS (Añadir dentro o al final de setupUILogic) ---
      function setupExpenseModalListeners_New() {
        // Botones para abrir/cerrar modal
        document.getElementById("open-expense-modal-btn").addEventListener("click", openExpenseModal);
        document.getElementById("close-expense-modal-btn").addEventListener("click", closeExpenseModal);
        document.getElementById("cancel-expense-modal-btn").addEventListener("click", closeExpenseModal);

        // Formulario
        document.getElementById("new-expense-form").addEventListener("submit", handleSaveExpenseFromModal);

        // Checkbox Gasto Fijo
        document.getElementById("new-expense-is-fixed").addEventListener("change", (e) => {
          document.getElementById("new-fixed-recurrence-container").classList.toggle("hidden", !e.target.checked);
        });

        // Delegación de eventos para selección de etiquetas
        document.getElementById("modal-payer-tags").addEventListener("click", handleModalTagSelection);
        document.getElementById("modal-type-tags").addEventListener("click", handleModalTagSelection);
        document.getElementById("modal-payment-method-tags").addEventListener("click", handleModalTagSelection);
        document.getElementById("modal-category-tags").addEventListener("click", handleModalTagSelection);
        document.getElementById("modal-subcategory-tags").addEventListener("click", handleModalTagSelection);

        // Listener para actualizar subcategorías cuando cambia la categoría
        document.getElementById("new-expense-category").addEventListener("change", updateModalSubcategoryTags);
      }

      // --- Utilidades ---
      const generateUUID = () => crypto.randomUUID();

      const showModal = (message, errorCode = null, title = "Atención") => {
        document.getElementById("modal-title").textContent = title;
        document.getElementById("modal-text").innerHTML = message; // Use innerHTML to allow textarea

        const errorDetailEl = document.getElementById("modal-error-detail");
        const errorCodeEl = document.getElementById("modal-error-code");

        if (errorCode) {
          errorCodeEl.textContent = errorCode;
          errorDetailEl.classList.remove("hidden");
        } else {
          errorDetailEl.classList.add("hidden");
        }

        document.getElementById("message-modal").classList.remove("hidden");
        document.getElementById("message-modal").classList.add("flex");
        document.body.classList.add("no-scroll");
      };

      document.getElementById("close-modal-btn").addEventListener("click", () => {
        document.getElementById("message-modal").classList.add("hidden");
        document.getElementById("message-modal").classList.remove("flex");
        document.body.classList.remove("no-scroll");
      });

      const formatCurrency = (value) => new Intl.NumberFormat("es-PE", { style: "currency", currency: "PEN", minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
      const formatDate = (isoString) => {
        if (!isoString) return "";
        const date = new Date(isoString + "T00:00:00Z"); // Use Z for UTC to avoid timezone issues with date-only strings
        return date.toLocaleDateString("es-ES", { day: "2-digit", timeZone: "UTC" }); // Specify UTC timezone
      };
      const formatShortDate = (isoString) => {
        if (!isoString) return "";
        const date = new Date(isoString + "T00:00:00Z");
        // Devuelve formato DD/MM
        return date.toLocaleDateString("es-ES", {
          day: "2-digit",
          month: "2-digit",
          timeZone: "UTC",
        });
      };
      const getFilterMonthString = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        return `${year}-${month}`;
      };
      function formatTitleCase(str) {
        if (!str) return "";
        return str
          .toLowerCase()
          .split(" ")
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      // CORREGIDO: Lógica de cálculo de ciclo de tarjeta de crédito mejorada
      function getCycleDates(method, referenceDate) {
        if (method.type !== "credit" || !method.paymentDay) {
          return { startDate: null, closingDate: null, paymentDate: null };
        }

        const paymentDay = method.paymentDay;
        const gracePeriodDays = 25; // Días entre cierre y pago

        const refYear = referenceDate.getUTCFullYear();
        const refMonth = referenceDate.getUTCMonth(); // 0 = Enero
        const refDay = referenceDate.getUTCDate();

        // 1. Calcula la fecha de cierre que ocurriría ANTES del pago del MES SIGUIENTE al de referencia.
        //    Ej: Si refDate es Octubre, calcula el cierre asociado al pago de Noviembre (~10 u 11 de Octubre).
        let potentialClosingDate = new Date(Date.UTC(refYear, refMonth + 1, paymentDay));
        potentialClosingDate.setUTCDate(potentialClosingDate.getUTCDate() - gracePeriodDays);

        let activeClosingDate;
        let cyclePaymentDate;

        // 2. Compara la fecha de referencia con esta fecha de cierre potencial.
        if (Date.UTC(refYear, refMonth, refDay) > potentialClosingDate.getTime()) {
          // Si la fecha de referencia (hoy) es POSTERIOR a esa fecha de cierre,
          // significa que el ciclo activo es el que cierra EL MES SIGUIENTE a 'potentialClosingDate'.
          // Avanzamos un mes la fecha de cierre y la de pago.
          activeClosingDate = new Date(potentialClosingDate.getTime());
          activeClosingDate.setUTCMonth(activeClosingDate.getUTCMonth() + 1);
          cyclePaymentDate = new Date(Date.UTC(activeClosingDate.getUTCFullYear(), activeClosingDate.getUTCMonth() + 1, paymentDay)); // Pago es un mes después del cierre activo
        } else {
          // Si la fecha de referencia (hoy) es ANTERIOR O IGUAL a esa fecha de cierre,
          // significa que el ciclo activo es precisamente el que termina en 'potentialClosingDate'.
          activeClosingDate = potentialClosingDate;
          cyclePaymentDate = new Date(Date.UTC(refYear, refMonth + 1, paymentDay)); // El pago es el mes siguiente a refMonth
        }

        // 3. Calcula la fecha de inicio del ciclo activo (un mes antes del cierre + 1 día).
        let activeStartDate = new Date(activeClosingDate.getTime());
        activeStartDate.setUTCMonth(activeStartDate.getUTCMonth() - 1);
        activeStartDate.setUTCDate(activeStartDate.getUTCDate() + 1);

        const toISODateString = (date) => date.toISOString().split("T")[0];

        // 4. Devuelve las fechas calculadas para el ciclo activo.
        return {
          startDate: toISODateString(activeStartDate),
          closingDate: toISODateString(activeClosingDate),
          paymentDate: toISODateString(cyclePaymentDate),
        };
      }

      // --- Funciones de Autenticación (REDUCIDAS) ---

      function openLogoutConfirmModal() {
        document.getElementById("logout-confirm-modal").classList.add("flex");
        document.getElementById("logout-confirm-modal").classList.remove("hidden");
      }

      function closeLogoutConfirmModal() {
        document.getElementById("logout-confirm-modal").classList.add("hidden");
        document.getElementById("logout-confirm-modal").classList.remove("flex");
      }

      document.getElementById("confirm-logout-btn").addEventListener("click", async () => {
        closeLogoutConfirmModal();
        try {
          if (unsubscribeListener) {
            unsubscribeListener();
            unsubscribeListener = null;
          }
          await signOut(auth);
          // La redirección la manejará onAuthStateChanged
        } catch (e) {
          showModal(`No se pudo cerrar la sesión: ${e.message}`, e.message, "Fallo al Cerrar Sesión");
        }
      });

      document.getElementById("cancel-logout-btn").addEventListener("click", closeLogoutConfirmModal);

      // --- Lógica de INICIALIZACIÓN y GESTIÓN DE MONEDERO ---
      async function initializeFirebase() {
        if (!isFirebaseActive) {
          loadLocalState();
          document.getElementById("auth-status").textContent = "⚠️ MODO LOCAL DE EMERGENCIA.";
          document.getElementById("initial-loading-screen").classList.add("hidden");
          document.getElementById("main-content-wrapper").classList.remove("hidden");
          setupUILogic(false);
          return;
        }

        try {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          onAuthStateChanged(auth, async (user) => {
            try {
              // <-- ADDED TRY BLOCK FOR ROBUSTNESS
              // Si estamos en Canvas y no hay usuario, intentar logueo con token
              if (IS_CANVAS_ENV && !user && initialAuthToken) {
                try {
                  await signInWithCustomToken(auth, initialAuthToken);
                  // El listener se volverá a ejecutar con el nuevo estado, así que salimos.
                  return;
                } catch (e) {
                  console.error("Fallo el inicio de sesión en Canvas:", e);
                  // Si falla, operar en modo local.
                  loadLocalState();
                  setupUILogic(false);
                  return;
                }
              }

              // Si hay un usuario (de cualquier método), proceder.
              if (user) {
                userId = user.uid;
                document.getElementById("current-user-id").innerHTML = `Mi UID: <strong>${userId}</strong>`;

                // Revisar si el usuario ya está en un monedero
                const userProfileRef = getUserProfileRef(db, userId);
                const userProfileSnap = await getDoc(userProfileRef);

                if (userProfileSnap.exists() && userProfileSnap.data().walletId) {
                  // El usuario ya tiene un monedero, cargar datos
                  currentWalletId = userProfileSnap.data().walletId;
                  document.getElementById("initial-loading-screen").classList.add("hidden");
                  document.getElementById("main-content-wrapper").classList.remove("hidden");
                  setupUILogic(true);
                  setupRealTimeDataListener();
                } else {
                  // Es un usuario nuevo o sin monedero, guiarlo a la configuración
                  document.getElementById("initial-loading-screen").classList.add("hidden");
                  document.getElementById("main-content-wrapper").classList.remove("hidden");
                  setupUILogic(true);
                  updateWalletSidebarView(false);

                  const sidebar = document.getElementById("participant-sidebar");
                  if (!sidebar.classList.contains("open")) {
                    const backdrop = document.getElementById("sidebar-backdrop");
                    sidebar.classList.add("open");
                    backdrop.classList.add("open");
                    document.body.classList.add("no-scroll");
                  }
                  showModal("Bienvenido. Para empezar, crea un nuevo monedero o únete a uno existente.", null, "Primeros Pasos");
                }
              } else {
                // Si NO hay usuario y NO estamos en Canvas, redirigir al login.
                if (!IS_CANVAS_ENV) {
                  window.location.href = REDIRECT_URL_LOGOUT;
                  console.log("MODO LOCAL: Redirección a logout deshabilitada para Live Server.");
                } else {
                  // Estado sin autenticación dentro de Canvas (modo local)
                  userId = "anonymous_canvas";
                  loadLocalState();
                  document.getElementById("initial-loading-screen").classList.add("hidden");
                  document.getElementById("main-content-wrapper").classList.remove("hidden");
                  document.getElementById("connection-dot").classList.remove("sync-red");
                  document.getElementById("connection-dot").classList.add("sync-green");
                  document.getElementById("auth-status-text").textContent = "🌐 Sesión de Canvas Activa.";
                  setupUILogic(false);
                }
              }
            } catch (error) {
              // <-- ADDED CATCH BLOCK
              console.error("Error durante el cambio de estado de autenticación:", error);
              showModal("Ocurrió un error al verificar tu sesión. Por favor, intenta recargar la página.", error.message, "Error de Autenticación");
              document.getElementById("initial-loading-screen").classList.add("hidden");
              document.getElementById("main-content-wrapper").classList.remove("hidden");
              document.getElementById("connection-dot").classList.add("sync-red");
              document.getElementById("connection-dot").classList.remove("sync-green");
              document.getElementById("auth-status-text").textContent = "Error de conexión.";
            }
          });
        } catch (error) {
          console.error("Error al inicializar Firebase:", error);
          showModal("Error crítico al inicializar Firebase.", error.message, "Fallo de Conexión");
          loadLocalState();
          setupUILogic(false);
        }
      }

      function updateWalletSidebarView(hasWallet) {
        const preControls = document.getElementById("pre-wallet-controls");
        const postControls = document.getElementById("post-wallet-controls");
        if (hasWallet) {
          preControls.classList.add("hidden");
          postControls.classList.remove("hidden");
        } else {
          preControls.classList.remove("hidden");
          postControls.classList.add("hidden");
          // Chequear si hay datos viejos para migrar
          const migrationNotice = document.getElementById("migration-notice");
          const oldDataRef = getOldUserFinanceDocRef(db, userId);
          getDoc(oldDataRef).then((docSnap) => {
            if (docSnap.exists()) {
              migrationNotice.classList.remove("hidden");
            }
          });
        }
      }

      async function handleCreateWallet() {
        try {
          const newWalletRef = await addDoc(getWalletsCollectionRef(db), { createdAt: new Date().toISOString(), owner: userId });
          currentWalletId = newWalletRef.id;

          const defaultWalletState = {
            participants: [],
            categories: [],
            paymentMethods: [
              { id: "m1", name: "Efectivo", type: "cash" },
              { id: "m2", name: "Débito", type: "cash" },
            ],
            expenses: [],
          };

          let walletData;

          const oldDataRef = getOldUserFinanceDocRef(db, userId);
          const oldDataSnap = await getDoc(oldDataRef);

          if (oldDataSnap.exists()) {
            // Migrar datos viejos, asegurando que todas las propiedades existan
            walletData = { ...defaultWalletState, ...oldDataSnap.data() };

            // Asegurarse de que al menos un participante esté vinculado al usuario actual
            const currentUserIsParticipant = walletData.participants.some((p) => p.firebaseUid === userId);
            if (!currentUserIsParticipant && walletData.participants.length > 0) {
              walletData.participants[0].firebaseUid = userId;
            } else if (walletData.participants.length === 0) {
              // Si los datos migrados no tenían participantes, añadir al usuario actual.
              walletData.participants.push({ id: generateUUID(), name: "Yo", budget: 1000, sharedSavingsPercent: 10, independentSavingsPercent: 5, firebaseUid: userId });
            }
          } else {
            // Crear un monedero nuevo desde cero
            walletData = { ...defaultWalletState };
            walletData.participants.push({ id: generateUUID(), name: "Yo", budget: 1000, sharedSavingsPercent: 10, independentSavingsPercent: 5, firebaseUid: userId });
          }

          const batch = writeBatch(db);
          batch.set(getWalletDocRef(db, currentWalletId), walletData); // Establecer datos en el nuevo monedero
          batch.set(getUserProfileRef(db, userId), { walletId: currentWalletId }); // Vincular usuario al monedero

          await batch.commit();

          // Cerrar sidebar y cargar la UI principal
          const sidebar = document.getElementById("participant-sidebar");
          const backdrop = document.getElementById("sidebar-backdrop");
          sidebar.classList.remove("open");
          backdrop.classList.remove("open");
          document.body.classList.remove("no-scroll");

          setupRealTimeDataListener();
        } catch (error) {
          console.error("Error al crear el monedero:", error);
          showModal("No se pudo crear el monedero. Revisa tu conexión y los permisos de la base de datos.", error.message, "Error Crítico");
        }
      }

      async function handleJoinWallet(e) {
        e.preventDefault();
        const walletIdToJoin = document.getElementById("join-wallet-id-input").value.trim();
        if (!walletIdToJoin) return;

        const walletRef = getWalletDocRef(db, walletIdToJoin);
        const walletSnap = await getDoc(walletRef);

        if (!walletSnap.exists()) {
          return showModal("El ID del monedero no es válido.", null, "Error al Unirse");
        }

        currentWalletId = walletIdToJoin;
        await setDoc(getUserProfileRef(db, userId), { walletId: currentWalletId });

        // Cerrar sidebar y cargar la UI principal
        const sidebar = document.getElementById("participant-sidebar");
        const backdrop = document.getElementById("sidebar-backdrop");
        sidebar.classList.remove("open");
        backdrop.classList.remove("open");
        document.body.classList.remove("no-scroll");

        setupRealTimeDataListener();
      }

      function setupDataManagementListeners() {
        // --- Export Logic (no changes) ---
        document.getElementById("export-json-btn").addEventListener("click", () => {
          const jsonString = JSON.stringify(appState);
          const modalTextEl = document.getElementById("modal-text");

          showModal("Copia este texto. Es el respaldo completo de tus datos.", null, "Exportar Datos");

          modalTextEl.innerHTML = "Copia este texto. Es el respaldo completo de tus datos." + `<textarea readonly class="w-full h-32 mt-2 p-2 border rounded bg-gray-100 text-xs font-mono">${jsonString}</textarea>`;

          modalTextEl.querySelector("textarea").select();
        });

        // --- Import Logic (New Modal System) ---
        const importModal = document.getElementById("import-json-modal");
        const importForm = document.getElementById("import-json-form");
        const jsonInputArea = document.getElementById("json-input-area");
        const cancelImportBtn = document.getElementById("cancel-import-btn");
        document.getElementById("format-data-btn").addEventListener("click", runDataMigration);

        // Open the modal
        document.getElementById("restore-json-btn").addEventListener("click", () => {
          importModal.classList.remove("hidden");
          importModal.classList.add("flex");
        });

        // Close the modal
        cancelImportBtn.addEventListener("click", () => {
          importModal.classList.add("hidden");
          importModal.classList.remove("flex");
          jsonInputArea.value = ""; // Clear textarea
        });

        // Handle the import submission
        importForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const jsonString = jsonInputArea.value.trim();

          if (!jsonString) {
            showModal("El campo de texto está vacío. Por favor, pega tus datos de respaldo.", null, "Error");
            return;
          }

          try {
            const importedState = JSON.parse(jsonString);
            if (importedState && typeof importedState.participants !== "undefined" && typeof importedState.expenses !== "undefined") {
              if (isFirebaseActive && db && currentWalletId) {
                await setDoc(getWalletDocRef(db, currentWalletId), importedState);

                // Close import modal before showing success message
                importModal.classList.add("hidden");
                importModal.classList.remove("flex");
                jsonInputArea.value = "";

                showModal("Datos restaurados y sincronizados. La página se recargará.", null, "Restauración Completa");
                setTimeout(() => window.location.reload(), 2000);
              } else {
                // Fallback for local mode
                appState = importedState;
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appState));
                renderUI();
                showModal("Datos restaurados localmente.", null, "Restauración Completa");
              }
            } else {
              throw new Error("El formato del JSON no es válido. Faltan propiedades esenciales (participants/expenses).");
            }
          } catch (error) {
            showModal(`Error al procesar el JSON: ${error.message}`, error.stack, "Error de Importación");
          }
        });
      }

      async function runDataMigration() {
        // 1. CONFIRMACIÓN DE SEGURIDAD
        const confirmation = window.prompt("Esto formateará todos los nombres y descripciones en la base de datos (Ej. 'SUPERMERCADO' -> 'Supermercado'). Esta acción es irreversible.\n\nEscribe 'FORMATEAR' para confirmar.");

        if (confirmation !== "FORMATEAR") {
          return showModal("Formateo cancelado.");
        }

        try {
          showModal("Iniciando formateo... Esto puede tardar un momento.", null, "Procesando");

          // 2. CREAR COPIAS LIMPIAS DE LOS DATOS
          const newParticipants = appState.participants.map((p) => ({
            ...p,
            name: formatTitleCase(p.name), // Limpia el nombre del participante
          }));

          const newCategories = appState.categories.map((c) => ({
            ...c,
            name: formatTitleCase(c.name), // Limpia el nombre de la categoría
            subcategories: c.subcategories.map((sub) => formatTitleCase(sub)), // Limpia cada subcategoría
          }));

          const newPaymentMethods = appState.paymentMethods.map((m) => ({
            ...m,
            name: formatTitleCase(m.name), // Limpia el nombre del método de pago
          }));

          const newExpenses = appState.expenses.map((e) => ({
            ...e,
            description: formatTitleCase(e.description), // Limpia la descripción
            subcategory: e.subcategory ? formatTitleCase(e.subcategory) : null, // Limpia la subcategoría
            payerNameGuest: e.payerNameGuest ? formatTitleCase(e.payerNameGuest) : null, // Limpia el nombre del invitado
          }));

          // 3. CREAR EL NUEVO OBJETO DE ESTADO COMPLETO
          const newState = {
            participants: newParticipants,
            categories: newCategories,
            paymentMethods: newPaymentMethods,
            expenses: newExpenses,
          };

          // 4. GUARDAR TODO EL OBJETO LIMPIO EN FIREBASE
          await saveState(newState);

          // 5. MOSTRAR ÉXITO
          showModal("¡Éxito! Todos los datos han sido formateados. Los cambios se reflejarán ahora.", null, "Formateo Completo");
        } catch (error) {
          console.error("Error durante la migración:", error);
          showModal("Ocurrió un error durante el formateo. Revisa la consola.", error.message, "Error Crítico");
        }
      }

      function setupRealTimeDataListener() {
        if (!db || !currentWalletId) return;
        if (unsubscribeListener) unsubscribeListener();

        const docRef = getWalletDocRef(db, currentWalletId);

        unsubscribeListener = onSnapshot(
          docRef,
          (docSnap) => {
            if (docSnap.exists()) {
              const loadedData = docSnap.data();

              const defaultState = { participants: [], categories: [], paymentMethods: [], expenses: [] };
              appState = { ...defaultState, ...loadedData };

              const linkedParticipant = appState.participants.find((p) => p.firebaseUid === userId);
              myParticipantId = linkedParticipant ? linkedParticipant.id : null;

              document.getElementById("share-wallet-id").value = currentWalletId;
              document.getElementById("connection-dot").classList.remove("sync-red");
              document.getElementById("connection-dot").classList.add("sync-green");
              document.getElementById("auth-status-text").textContent = "✅ Conectado al monedero.";
              updateWalletSidebarView(true); // Mostrar info del monedero actual
              renderUI();
            } else {
              // El monedero fue eliminado, forzar al usuario a crear/unirse de nuevo.
              showModal("Este monedero ya no existe. Por favor, crea uno nuevo o únete a otro.", null, "Monedero no encontrado");
              updateWalletSidebarView(false);
            }
          },
          (error) => {
            console.error("Error en Firestore:", error);
            showModal("Error al cargar datos.", error.message, "Error de Datos");
          }
        );
      }

      // --- Funciones de Soporte ---
      function loadLocalState() {
        const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (savedData) {
          try {
            const loadedData = JSON.parse(savedData);
            appState = { ...appState, ...loadedData };
          } catch (e) {
            console.error("Error al cargar estado local:", e);
          }
        }
      }

      async function saveState(updates) {
        if (isFirebaseActive && db && currentWalletId) {
          try {
            await updateDoc(getWalletDocRef(db, currentWalletId), updates);
          } catch (error) {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ ...appState, ...updates }));
            showModal("Error al guardar en la nube. Se guardó localmente.", error.message, "Fallo de Guardado");
          }
        } else {
          appState = { ...appState, ...updates };
          localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appState));
          renderUI();
        }
      }

      function linkParticipantToUser(participantId) {
        if (!userId || userId === "anonymous_canvas" || userId === "loading") {
          return showModal("Debes estar autenticado para vincular una cuenta.", null, "Acceso Denegado");
        }

        const newParticipants = appState.participants.map((p) => {
          // Desvincular si este usuario ya estaba vinculado a otro participante
          if (p.firebaseUid === userId) p.firebaseUid = null;
          // Vincular al nuevo participante
          if (p.id === participantId) p.firebaseUid = userId;
          return p;
        });

        saveState({ participants: newParticipants });
        showModal("¡Cuenta vinculada exitosamente!", null, "Vinculación Exitosa");
      }

      // NUEVO: Función para configurar los listeners de los filtros dinámicos y el popover
      // ================================================================
      // ===== 2. REEMPLAZA ESTA FUNCIÓN COMPLETA =====
      // ================================================================
      function setupDynamicFilterListeners() {
        const popoverButton = document.getElementById("filter-popover-button");
        const popover = document.getElementById("filter-popover");
        const closePopoverButton = document.getElementById("close-filter-popover-btn");
        const resetFiltersButton = document.getElementById("reset-filters-btn");
        const descriptionInput = document.getElementById("filter-description");
        const categoryTagsContainer = document.getElementById("filter-tag-categories");
        const participantTagsContainer = document.getElementById("filter-tag-participants");
        const paymentMethodTagsContainer = document.getElementById("filter-tag-payment-methods");
        const selectedTagsContainer = document.getElementById("selected-filter-tags");

        // Abrir/Cerrar Popover (Sin cambios)
        popoverButton.addEventListener("click", (e) => {
          e.stopPropagation();
          popover.classList.toggle("hidden");
        });
        closePopoverButton.addEventListener("click", () => {
          popover.classList.add("hidden");
        });

        // Cerrar popover si se hace click fuera (Sin cambios)
        document.addEventListener("click", (e) => {
          if (!popover.classList.contains("hidden") && !popover.contains(e.target) && e.target !== popoverButton && !popoverButton.contains(e.target)) {
            popover.classList.add("hidden");
          }
        });

        // Aplicar filtro de descripción al escribir (Sin cambios)
        descriptionInput.addEventListener("input", (e) => {
          activeFilters.description = e.target.value.toLowerCase();
          renderUI();
        });

        // Manejar clicks en las etiquetas de categoría (Sin cambios)
        categoryTagsContainer.addEventListener("click", (e) => {
          const target = e.target.closest(".filter-tag.category-tag");
          if (target) {
            const categoryName = target.dataset.value;
            activeFilters.category = activeFilters.category === categoryName ? null : categoryName;
            renderUI();
          }
        });

        // --- INICIO DE MODIFICACIÓN ---
        // Manejar clicks en las etiquetas de participante (¡Y AHORA INVITADO!)
        participantTagsContainer.addEventListener("click", (e) => {
          const target = e.target.closest(".filter-tag.participant-tag");
          if (target) {
            const value = target.dataset.value;

            if (value === "guest") {
              // Es la etiqueta de invitado
              activeFilters.guestOnly = !activeFilters.guestOnly;
              activeFilters.participant = null; // Desactiva filtro de participante
            } else {
              // Es una etiqueta de participante normal
              const participantId = value;
              activeFilters.participant = activeFilters.participant === participantId ? null : participantId;
              activeFilters.guestOnly = false; // Desactiva filtro de invitado
            }
            renderUI();
          }
        });
        // --- FIN DE MODIFICACIÓN ---

        // Manejar clicks en las etiquetas de método de pago (Sin cambios)
        paymentMethodTagsContainer.addEventListener("click", (e) => {
          const target = e.target.closest(".filter-tag.payment-method-tag");
          if (target) {
            const methodId = target.dataset.value;
            activeFilters.paymentMethod = activeFilters.paymentMethod === methodId ? null : methodId;
            renderUI();
          }
        });

        // --- INICIO DE MODIFICACIÓN ---
        // Botón para limpiar filtros
        resetFiltersButton.addEventListener("click", () => {
          descriptionInput.value = "";
          activeFilters.description = "";
          activeFilters.category = null;
          activeFilters.participant = null;
          activeFilters.paymentMethod = null;
          activeFilters.guestOnly = false; // <-- AÑADIDO
          renderUI();
        });

        // Delegación para remover etiquetas seleccionadas
        selectedTagsContainer.addEventListener("click", (e) => {
          const target = e.target.closest(".selected-tag-remove");
          if (target) {
            const filterType = target.dataset.type;
            if (filterType === "category") {
              activeFilters.category = null;
            } else if (filterType === "participant") {
              activeFilters.participant = null;
            } else if (filterType === "paymentMethod") {
              activeFilters.paymentMethod = null;
            } else if (filterType === "guest") {
              // <-- AÑADIDO
              activeFilters.guestOnly = false;
            }
            renderUI();
          }
        });
        // --- FIN DE MODIFICACIÓN ---
      }
      /**
       * TOMA LOS BALANCES DE TODOS LOS PARTICIPANTES Y CALCULA EL NÚMERO
       * MÍNIMO DE TRANSACCIONES PARA SALDAR TODAS LAS DEUDAS.
       *
       * @param {Array} participantData - El array de participantes de calculateSummary()
       * @returns {Array} Un array de objetos { from, to, amount }
       */
      // ================================================================
      // ===== 2. AÑADE/REEMPLAZA ESTA FUNCIÓN =====
      // ================================================================
      /**
       * TOMA LOS BALANCES NETOS y calcula el NÚMERO MÍNIMO de pagos.
       * Esto resuelve el problema de "A paga a B" y "B paga a A".
       */
      function calculateSettlements(participantData) {
        const transactions = [];

        // 1. Usamos copia profunda para no modificar los datos originales
        const balances = JSON.parse(
          JSON.stringify(
            participantData.filter((p) => Math.abs(p.balance) > 0.01) // Ignora los que están en 0
          )
        );

        // 2. Separa en deudores (deben) y acreedores (les deben)
        const debtors = balances.filter((p) => p.balance < 0).sort((a, b) => a.balance - b.balance);
        const creditors = balances.filter((p) => p.balance > 0).sort((a, b) => b.balance - a.balance);

        let i = 0; // Puntero deudores
        let j = 0; // Puntero acreedores

        // 3. Algoritmo de liquidación
        while (i < debtors.length && j < creditors.length) {
          const debtor = debtors[i];
          const creditor = creditors[j];

          // Cantidad a transferir = el mínimo de lo que uno debe vs lo que al otro le deben
          const amount = Math.min(Math.abs(debtor.balance), creditor.balance);

          if (amount > 0.01) {
            // 4. Registra la acción simple
            transactions.push({
              from: debtor.name, // Quién paga
              to: creditor.name, // Quién recibe
              amount: amount,
            });

            // 5. Actualiza balances virtuales para seguir calculando
            debtor.balance += amount;
            creditor.balance -= amount;
          }

          // 6. Mover punteros si alguien llega a cero
          if (Math.abs(debtor.balance) < 0.01) i++;
          if (Math.abs(creditor.balance) < 0.01) j++;
        }

        return transactions;
      }
      // ================================================================
      // ===== FIN DE LA FUNCIÓN 2 =====
      // ================================================================
      // MODIFICADO: Función para actualizar el estado visual del botón de filtros y las etiquetas seleccionadas
      // ================================================================
      // ===== 4. REEMPLAZA ESTA FUNCIÓN COMPLETA =====
      // ================================================================
      function updateFilterUIState() {
        const popoverButton = document.getElementById("filter-popover-button");
        const selectedTagsContainer = document.getElementById("selected-filter-tags");
        const noFiltersLabel = document.getElementById("no-filters-label");

        const descActive = !!activeFilters.description;
        const catActive = !!activeFilters.category;
        const partActive = !!activeFilters.participant;
        const pmActive = !!activeFilters.paymentMethod;
        const guestActive = !!activeFilters.guestOnly; // <-- AÑADIDO
        const isActive = descActive || catActive || partActive || pmActive || guestActive; // <-- MODIFICADO

        // Actualizar botón principal
        popoverButton.classList.toggle("active", isActive);
        popoverButton.classList.toggle("bg-indigo-100", isActive);
        popoverButton.classList.toggle("text-indigo-700", isActive);

        // Actualizar etiquetas seleccionadas en el popover
        selectedTagsContainer.innerHTML = "";
        let hasSelectedTags = false;

        if (catActive) {
          selectedTagsContainer.insertAdjacentHTML(
            "beforeend",
            `<span class="filter-tag category-tag active">
               ${activeFilters.category}
               <button data-type="category" class="selected-tag-remove ml-1.5 text-indigo-100 hover:text-white">&times;</button>
            </span>`
          );
          hasSelectedTags = true;
        }
        if (partActive) {
          const participant = appState.participants.find((p) => p.id === activeFilters.participant);
          if (participant) {
            selectedTagsContainer.insertAdjacentHTML(
              "beforeend",
              `<span class="filter-tag participant-tag active">
                 ${participant.name}
                 <button data-type="participant" class="selected-tag-remove ml-1.5 text-purple-100 hover:text-white">&times;</button>
              </span>`
            );
            hasSelectedTags = true;
          }
        }

        // --- INICIO DE MODIFICACIÓN ---
        // NUEVO: Añadir etiqueta seleccionada para Invitado
        if (guestActive) {
          selectedTagsContainer.insertAdjacentHTML(
            "beforeend",
            `<span class="filter-tag participant-tag active">
                 <i class="fas fa-user-tag fa-fw mr-1"></i>Invitado
                 <button data-type="guest" class="selected-tag-remove ml-1.5 text-purple-100 hover:text-white">&times;</button>
              </span>`
          );
          hasSelectedTags = true;
        }

        if (pmActive) {
          const paymentMethod = appState.paymentMethods.find((m) => m.id === activeFilters.paymentMethod);
          if (paymentMethod) {
            selectedTagsContainer.insertAdjacentHTML(
              "beforeend",
              `<span class="filter-tag payment-method-tag active">
                 ${paymentMethod.name}
                 <button data-type="paymentMethod" class="selected-tag-remove ml-1.5 text-green-100 hover:text-white">&times;</button>
              </span>`
            );
            hasSelectedTags = true;
          }
        }

        // Mostrar/ocultar el label "No hay filtros"
        if (noFiltersLabel) noFiltersLabel.classList.toggle("hidden", catActive || partActive || pmActive || guestActive); // <-- MODIFICADO

        // Actualizar estado 'active' de las etiquetas clickeables en las listas
        document.querySelectorAll("#filter-tag-categories .filter-tag").forEach((tag) => {
          tag.classList.toggle("active", tag.dataset.value === activeFilters.category);
        });

        // Actualizar estado activo de etiquetas de participante e invitado
        document.querySelectorAll("#filter-tag-participants .filter-tag").forEach((tag) => {
          const value = tag.dataset.value;
          if (value === "guest") {
            tag.classList.toggle("active", activeFilters.guestOnly);
          } else {
            tag.classList.toggle("active", tag.dataset.value === activeFilters.participant);
          }
        });

        document.querySelectorAll("#filter-tag-payment-methods .filter-tag").forEach((tag) => {
          tag.classList.toggle("active", tag.dataset.value === activeFilters.paymentMethod);
        });
        // --- FIN DE MODIFICACIÓN ---

        // Sincronizar el input de descripción con el estado (Sin cambios)
        const descriptionInput = document.getElementById("filter-description");
        if (descriptionInput && descriptionInput.value !== activeFilters.description) {
          descriptionInput.value = activeFilters.description;
        }
      }

      function setupUILogic(isFirebaseMode) {
        document.getElementById("sidebar-collapsed-content").addEventListener("click", (e) => {
          const iconLink = e.target.closest(".icon-link");
          if (!iconLink || !iconLink.dataset.panelId) return;

          e.preventDefault(); // Evita que el <a> navegue
          const panelId = iconLink.dataset.panelId;
          setupCycleTabs();

          // 1. Muestra el panel correcto
          showSidebarPanel(panelId);

          // 2. Expande el sidebar
          // (Llamamos a la función que ya existe para abrirlo)
          const sidebar = document.getElementById("participant-sidebar");
          if (!sidebar.classList.contains("open")) {
            // Usamos la función toggleSidebar(true) que definiremos/modificaremos
            toggleSidebar(true);
          }
        });
        const tabButtons = document.querySelectorAll(".sidebar-tab-btn");
        const tabPanels = document.querySelectorAll(".sidebar-tab-panel");

        const backdrop = document.getElementById("sidebar-backdrop");
        const participantSidebar = document.getElementById("participant-sidebar");
        const chartContent = document.getElementById("chart-collapsible-content");
        const chartToggleBtn = document.getElementById("toggle-chart-btn");
        const chartToggleIcon = document.getElementById("chart-toggle-icon");

        // 1. Lógica de Colapsado de Gráfico (Distribución de Gastos)
        chartContent.classList.remove("open"); // Cerrado por defecto (CSS lo maneja)
        chartToggleIcon.classList.remove("rotate-180");

        chartToggleBtn.addEventListener("click", () => {
          const isOpen = chartContent.classList.toggle("open");
          chartToggleIcon.classList.toggle("rotate-180", isOpen);
        });

        // Resto de Listeners de la UI principal
        setupCustomSelects();
        //setupMonthSelectorListeners();

        setupCategoryModalListeners();
        // --- INICIO: NUEVOS LISTENERS PARA CALENDARIO INTERACTIVO ---
        document.getElementById("prev-month-btn").addEventListener("click", () => {
          currentFilterDate.setDate(1); // Asegura que esté en el día 1
          currentFilterDate.setMonth(currentFilterDate.getMonth() - 1);

          renderUI();
        });

        document.getElementById("next-month-btn").addEventListener("click", () => {
          currentFilterDate.setDate(1); // Asegura que esté en el día 1
          currentFilterDate.setMonth(currentFilterDate.getMonth() + 1);

          renderUI();
        });
        const calendarAccordionHeader = document.getElementById("calendar-accordion-header");
        if (calendarAccordionHeader) {
          calendarAccordionHeader.addEventListener("click", toggleCalendarAccordion);
        }

        // Listener para el Acordeón de Semanas
        const trigger = document.getElementById("calendar-accordion-trigger");
        if (trigger) {
          trigger.addEventListener("click", () => {
            const accordion = document.getElementById("calendar-accordion");
            const content = document.getElementById("calendar-accordion-content");

            if (!accordion || !content) {
              console.error("Elementos del acordeón del calendario no encontrados.");
              return;
            }

            // Simplemente alterna (toggle) el estado de apertura.
            accordion.classList.toggle("open");
            content.classList.toggle("open");
          });
        }

        // Listener para el Dropdown de Meses
        // ==================================
        // ===== INICIO: CÓDIGO REEMPLAZADO =====
        // ==================================
        // --- REEMPLAZO: Listeners para el Dropdown de Meses Y Años ---
        const monthDropdown = document.getElementById("month-list-dropdown");

        // 1. Clic en los botones de AÑO (Prev/Next)
        document.getElementById("month-picker-prev-year").addEventListener("click", () => {
          monthPickerYear--;
          renderMonthPickerDropdown(); // Solo actualiza el dropdown, no toda la UI
        });

        document.getElementById("month-picker-next-year").addEventListener("click", () => {
          monthPickerYear++;
          renderMonthPickerDropdown(); // Solo actualiza el dropdown
        });

        // 2. Clic en un MES
        document.getElementById("month-list-container").addEventListener("click", (e) => {
          const target = e.target.closest(".month-picker-btn");
          if (target && target.dataset.month) {
            const newMonth = parseInt(target.dataset.month);

            // Establece la fecha del filtro al año y mes seleccionados en el picker
            currentFilterDate.setFullYear(monthPickerYear, newMonth, 1);

            renderUI(); // Re-renderiza toda la UI con la nueva fecha

            // Oculta el dropdown
            const dropdownToggle = document.getElementById("month-picker-toggle");
            // Usamos 'window.FlowbiteInstances' porque estamos en un módulo
            if (window.FlowbiteInstances) {
              const dropdownInstance = window.FlowbiteInstances.getInstance("Dropdown", "month-list-dropdown", dropdownToggle);
              if (dropdownInstance) {
                dropdownInstance.hide();
              }
            }
          }
        });
        // ==================================
        // ===== FIN: CÓDIGO REEMPLAZADO =====
        // ==================================
        setupPaymentMethodListeners();
        setupParticipantModalListeners(backdrop, participantSidebar);
        setupPaymentMethodModalListeners();
        setupExpenseFormListeners();
        setupExpenseModalListeners();
        setupSettlementModalListeners();
        setupLiquidateListeners();
        setupDynamicFilterListeners(); // Configura listeners del popover y filtros internos
        setupDataManagementListeners();
        setupExpenseModalListeners_New();

        // CORREGIDO: Añadir listener para el botón de logout principal
        document.getElementById("logout-btn").addEventListener("click", openLogoutConfirmModal);

        // Listeners de la nueva lógica de monederos
        document.getElementById("copy-wallet-id-btn").addEventListener("click", () => {
          const walletIdInput = document.getElementById("share-wallet-id");
          walletIdInput.select();
          document.execCommand("copy");
          showModal("ID del monedero copiado al portapapeles.", null, "Copiado");
        });
        document.getElementById("create-wallet-btn").addEventListener("click", handleCreateWallet);
        document.getElementById("join-wallet-form").addEventListener("submit", handleJoinWallet);

        if (!isFirebaseMode) renderUI();
      }

      // --- El resto de las funciones (render, cálculo, etc.) se mantienen mayormente sin cambios ---

      // CORREGIDO: Añadir más chequeos en setupCustomSelects
      function setupCustomSelects() {
        window.addEventListener("click", (e) => {
          document.querySelectorAll(".custom-select-container").forEach((container) => {
            if (!container.contains(e.target)) {
              const optionsDiv = container.querySelector(".custom-select-options");
              if (optionsDiv) optionsDiv.classList.add("hidden");
              const chevronIcon = container.querySelector(".fa-chevron-down");
              if (chevronIcon) chevronIcon.classList.remove("rotate-180");
            }
          });
        });

        document.querySelectorAll(".custom-select-container").forEach((container) => {
          const button = container.querySelector(".custom-select-button");
          const optionsContainer = container.querySelector(".custom-select-options");
          const chevron = button ? button.querySelector(".fa-chevron-down") : null; // Get chevron here

          if (!button || !optionsContainer) {
            // console.warn('Custom select missing button or options container:', container);
            return;
          }

          button.addEventListener("click", (e) => {
            e.stopPropagation();
            // Close other open selects
            document.querySelectorAll(".custom-select-options").forEach((otherOptions) => {
              if (otherOptions !== optionsContainer) {
                otherOptions.classList.add("hidden");
                const parentContainer = otherOptions.closest(".custom-select-container");
                if (parentContainer) {
                  const otherChevron = parentContainer.querySelector(".fa-chevron-down");
                  if (otherChevron) otherChevron.classList.remove("rotate-180");
                }
              }
            });

            // Toggle current select
            optionsContainer.classList.toggle("hidden");
            if (chevron) chevron.classList.toggle("rotate-180"); // Use chevron variable
          });

          optionsContainer.addEventListener("click", (e) => {
            const option = e.target.closest(".custom-select-option");
            if (option) {
              const hiddenInput = container.querySelector('input[type="hidden"]');
              const display = button.querySelector(".custom-select-display");

              if (!hiddenInput || !display) return; // Chequeo adicional

              display.textContent = option.textContent.trim();
              display.classList.remove("text-gray-500");
              hiddenInput.value = option.dataset.value;

              optionsContainer.querySelectorAll(".custom-select-option").forEach((opt) => opt.classList.remove("selected"));
              option.classList.add("selected");

              optionsContainer.classList.add("hidden");
              if (chevron) chevron.classList.remove("rotate-180"); // Use chevron variable
              hiddenInput.dispatchEvent(new Event("change", { bubbles: true }));
            }
          });
        });
      }

      function setupLiquidateListeners() {
        //document.getElementById('liquidate-month-btn').addEventListener('click', liquidateMonth);
      }

      function getExpensesForCurrentView() {
        const filterMonthString = getFilterMonthString(currentFilterDate);
        const allExpenses = appState.expenses || [];
        const projectedFixedExpenses = [];
        const filterViewDate = new Date(currentFilterDate.getTime());

        const baseFixedExpenses = allExpenses.filter((e) => e.isFixed);

        baseFixedExpenses.forEach((baseExpense) => {
          const baseDate = new Date(baseExpense.date + "T00:00:00Z");
          const recurrenceMonths = baseExpense.fixedRecurrenceMonths || 12;

          const baseYear = baseDate.getUTCFullYear();
          const baseMonth = baseDate.getUTCMonth();
          const viewYear = filterViewDate.getUTCFullYear();
          const viewMonth = filterViewDate.getUTCMonth();

          const monthDifference = (viewYear - baseYear) * 12 + (viewMonth - baseMonth);

          if (monthDifference > 0 && monthDifference < recurrenceMonths) {
            let projectedDate = new Date(Date.UTC(viewYear, viewMonth, baseDate.getUTCDate()));

            if (projectedDate.getUTCMonth() !== viewMonth) {
              projectedDate = new Date(Date.UTC(viewYear, viewMonth + 1, 0));
            }

            const projectedDateString = projectedDate.toISOString().split("T")[0];
            const alreadyExists = allExpenses.some((e) => e.date.startsWith(filterMonthString) && e.description.toLowerCase() === baseExpense.description.toLowerCase());

            if (!alreadyExists) {
              projectedFixedExpenses.push({
                ...baseExpense,
                id: `proj_${baseExpense.id}_${monthDifference}`,
                date: projectedDateString,
                isProjected: true,
              });
            }
          }
        });

        let expensesForMonth = allExpenses.filter((e) => e.date && e.date.startsWith(filterMonthString));
        expensesForMonth = [...expensesForMonth, ...projectedFixedExpenses];
        return expensesForMonth;
      }
      async function liquidateMonth() {
        if (!db || userId === "loading") return showModal("La base de datos no está lista.");

        const { participantData, guestDebtTotal } = calculateSummary(
          appState,
          appState.expenses.filter((e) => e.date.startsWith(getFilterMonthString(currentFilterDate)))
        );
        const balances = participantData.filter((p) => Math.abs(p.balance) > 0.01);
        if (balances.length === 0 && guestDebtTotal === 0) return showModal("Las cuentas ya están claras.", null, "Liquidación Completa");

        if (window.prompt(`Se crearán transacciones de ajuste. Escribe 'LIQUIDAR' para confirmar.`) !== "LIQUIDAR") return showModal("Liquidación cancelada.");

        const newExpenses = [...appState.expenses];
        const now = new Date().toISOString().split("T")[0];
        let numSettlements = 0;

        const debtors = balances.filter((p) => p.balance < 0).sort((a, b) => a.balance - b.balance);
        const creditors = balances.filter((p) => p.balance > 0).sort((a, b) => b.balance - a.balance);

        let i = 0,
          j = 0;
        while (i < debtors.length && j < creditors.length) {
          let debtor = debtors[i],
            creditor = creditors[j];
          const amount = Math.min(Math.abs(debtor.balance), creditor.balance);

          if (amount > 0.01) {
            newExpenses.push({ id: generateUUID(), type: "personal", description: `REEMBOLSO: ${debtor.name} a ${creditor.name}`, amount, payerId: debtor.id, category: "Liquidación", subcategory: "Reembolso", paymentMethodId: "m1", date: now, dateCreated: new Date().toISOString() });
            numSettlements++;
            debtor.balance += amount;
            creditor.balance -= amount;
          }
          if (Math.abs(debtor.balance) < 0.01) i++;
          if (creditor.balance < 0.01) j++;
        }
        await saveState({ expenses: newExpenses });
        showModal(`¡Liquidación completada! Se crearon ${numSettlements} ajustes.`, null, "Liquidación Exitosa");
      }

      // ================================================================
      // ===== REEMPLAZA ESTA FUNCIÓN COMPLETA =====
      // ================================================================
      function setupParticipantModalListeners(backdrop, sidebar) {
        const modal = document.getElementById("add-participant-modal");
        const form = document.getElementById("participant-form");
        // --- Lógica del botón de FLECHA (Chevron) ---
        document.getElementById("close-sidebar-btn").addEventListener("click", () => {
          const sidebar = document.getElementById("participant-sidebar");
          const isOpen = sidebar.classList.contains("open");

          // Simplemente cierra si está abierto, o abre al último panel si está cerrado
          toggleSidebar(!isOpen);
        });

        // (El resto de esta función es tu lógica de modal, que no cambia)
        // ... (tu lógica para backdrop.addEventListener... si la tenías) ...

        document.getElementById("open-add-participant-modal-sidebar").addEventListener("click", () => {
          document.getElementById("participant-id-to-edit").value = "";
          document.getElementById("participant-modal-title").textContent = "Añadir Participante";
          form.reset();
          modal.classList.add("flex");
          modal.classList.remove("hidden");
        });

        document.getElementById("close-participant-modal-btn").addEventListener("click", () => {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        });

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          // ... (tu lógica de guardar participante) ...
        });
      }
      // ================================================================
      // ===== FIN DEL REEMPLAZO =====
      // ================================================================

      function openParticipantEditModal(id) {
        const p = appState.participants.find((p) => p.id === id);
        if (!p) return;
        document.getElementById("participant-id-to-edit").value = id;
        document.getElementById("participant-modal-title").textContent = `Editar Participante: ${p.name}`;
        document.getElementById("p-name").value = p.name;
        document.getElementById("p-budget").value = p.budget;
        document.getElementById("p-shared-savings").value = p.sharedSavingsPercent;
        document.getElementById("p-independent-savings").value = p.independentSavingsPercent;
        const modal = document.getElementById("add-participant-modal");
        modal.classList.add("flex");
        modal.classList.remove("hidden");
        document.body.classList.add("no-scroll");
      }

      function removeParticipant(id) {
        if (appState.participants.length <= 1) {
          return showModal("Debe haber al menos un participante.");
        }
        // NUEVO: Desactivar filtro si se elimina el participante activo
        if (activeFilters.participant === id) {
          activeFilters.participant = null;
        }
        const newParticipants = appState.participants.filter((p) => p.id !== id);
        const newExpenses = appState.expenses.filter((e) => e.payerId !== id);
        saveState({ participants: newParticipants, expenses: newExpenses });
        showModal(`Participante y sus gastos asociados eliminados.`);
      }

      function renderMonthSelector() {
        const monthNameEl = document.getElementById("current-month-name");
        const yearEl = document.getElementById("current-year");
        if (monthNameEl && yearEl) {
          monthNameEl.textContent = MONTH_NAMES[currentFilterDate.getMonth()];
          yearEl.textContent = currentFilterDate.getFullYear();
        }
      }

      function setupMonthSelectorListeners() {
        document.getElementById("prev-month-btn").addEventListener("click", () => {
          currentFilterDate.setMonth(currentFilterDate.getMonth() - 1);
          currentFilterDate.setDate(1); // <-- ¡ESTA ES LA CORRECCIÓN!
          renderUI();
        });
        document.getElementById("next-month-btn").addEventListener("click", () => {
          currentFilterDate.setMonth(currentFilterDate.getMonth() + 1);
          currentFilterDate.setDate(1); // <-- ¡ESTA ES LA CORRECCIÓN!
          renderUI();
        });
      }

      function removeExpense(id) {
        const newExpenses = appState.expenses.filter((e) => e.id !== id);
        saveState({ expenses: newExpenses });
        showModal("Gasto eliminado.");
      }

      function setupCategoryModalListeners() {
        const modal = document.getElementById("categories-modal");
        document.getElementById("open-categories-modal-btn").addEventListener("click", () => {
          modal.classList.remove("hidden");
          modal.classList.add("flex");
        });
        document.getElementById("close-categories-modal-btn").addEventListener("click", () => {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        });

        document.getElementById("category-form").addEventListener("submit", (e) => {
          e.preventDefault();
          const name = formatTitleCase(document.getElementById("category-name").value);
          const budget = parseFloat(document.getElementById("category-budget").value) || 0;
          const subcategoriesString = document.getElementById("subcategory-list").value.trim();
          if (!name) return;

          const subcategories = subcategoriesString
            ? subcategoriesString
                .split(",")
                .map((s) => s.trim())
                .filter((s) => s)
            : [];
          const newCategories = [...appState.categories];
          const existingIndex = newCategories.findIndex((c) => c.name.toLowerCase() === name.toLowerCase());

          if (existingIndex !== -1) {
            newCategories[existingIndex].budget = budget;
            newCategories[existingIndex].subcategories = Array.from(new Set([...newCategories[existingIndex].subcategories, ...subcategories]));
          } else {
            newCategories.push({ name, subcategories, budget });
          }

          saveState({ categories: newCategories });
          showModal(`Categoría '${name}' guardada.`);
          e.target.reset();
        });
      }

      function setupPaymentMethodListeners() {
        const modal = document.getElementById("payment-methods-modal");
        document.getElementById("open-payment-methods-modal-btn").addEventListener("click", () => {
          modal.classList.remove("hidden");
          modal.classList.add("flex");
        });
        document.getElementById("close-payment-methods-modal-btn").addEventListener("click", () => {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          resetPaymentForm();
        });
        document.getElementById("method-type").addEventListener("change", (e) => {
          document.getElementById("cc-config-fields").classList.toggle("hidden", e.target.value !== "credit");
        });
        document.getElementById("cancel-edit-method-btn").addEventListener("click", resetPaymentForm);

        document.getElementById("payment-method-form").addEventListener("submit", (e) => {
          e.preventDefault();
          const id = document.getElementById("method-id-to-edit").value;
          const name = formatTitleCase(document.getElementById("method-name").value);
          const type = document.getElementById("method-type").value;
          const method = { name, type };

          if (type === "credit") {
            const paymentDay = parseInt(document.getElementById("cc-config-payment-day").value);
            if (isNaN(paymentDay) || paymentDay < 1 || paymentDay > 31) {
              return showModal("El día de pago para tarjetas de crédito debe ser válido (1-31).");
            }
            method.paymentDay = paymentDay;
          }

          let newMethods;
          if (id) {
            newMethods = appState.paymentMethods.map((m) => (m.id === id ? { ...m, ...method } : m));
          } else {
            method.id = `m${generateUUID()}`;
            newMethods = [...appState.paymentMethods, method];
          }
          saveState({ paymentMethods: newMethods });
          modal.classList.add("hidden");
          resetPaymentForm();
        });
      }

      function setupExpenseFormListeners() {
        document.getElementById("expense-is-fixed").addEventListener("change", (e) => {
          document.getElementById("fixed-recurrence-container").classList.toggle("hidden", !e.target.checked);
        });

        document.getElementById("expense-category").addEventListener("change", (e) => {
          const categoryName = e.target.value;
          const subCatContainer = document.querySelector("#expense-subcategory-button").closest(".custom-select-container");
          const subCatOptions = subCatContainer.querySelector(".custom-select-options");
          const subCatDisplay = subCatContainer.querySelector(".custom-select-display");
          const subCatInput = subCatContainer.querySelector('input[type="hidden"]');
          const subCatButton = subCatContainer.querySelector("button");

          subCatOptions.innerHTML = "";
          subCatDisplay.textContent = "Selecciona subcategoría";
          subCatInput.value = "";

          const selectedCategory = appState.categories.find((c) => c.name === categoryName);
          if (selectedCategory && selectedCategory.subcategories.length > 0) {
            selectedCategory.subcategories.forEach((sub) => {
              subCatOptions.insertAdjacentHTML("beforeend", `<div class="custom-select-option" data-value="${sub}">${sub}</div>`);
            });
            subCatButton.disabled = false;
            subCatButton.classList.remove("bg-gray-100");
          } else {
            subCatButton.disabled = true;
            subCatButton.classList.add("bg-gray-100");
          }
        });

        document.getElementById("expense-payment-method-id").addEventListener("change", (e) => {
          const selectedMethodId = e.target.value;
          const method = appState.paymentMethods.find((m) => m.id === selectedMethodId);
          const ccDetails = document.getElementById("credit-card-details");
          if (method && method.type === "credit") {
            ccDetails.classList.remove("hidden");
            const { startDate, paymentDate } = getCycleDates(method, new Date()); // Usa la fecha actual para el formulario
            document.getElementById("cc-cycle-start-display").textContent = formatDate(startDate);
            document.getElementById("cc-payment-date-display").textContent = formatDate(paymentDate);
          } else {
            ccDetails.classList.add("hidden");
          }
        });

        document.getElementById("expense-form").addEventListener("submit", (e) => {
          e.preventDefault();
          try {
            const description = document.getElementById("expense-description").value.trim();
            const amount = parseFloat(document.getElementById("expense-amount").value);
            const payerId = document.getElementById("expense-paid-by").value;
            const type = document.getElementById("expense-type").value;
            const category = document.getElementById("expense-category").value;
            const subcategory = document.getElementById("expense-subcategory").value;
            const paymentMethodId = document.getElementById("expense-payment-method-id").value;
            const isFixed = document.getElementById("expense-is-fixed").checked;

            if (!description || !amount || !payerId || !category || !paymentMethodId) {
              return showModal("Por favor, completa todos los campos requeridos.");
            }

            const paymentMethod = appState.paymentMethods.find((m) => m.id === paymentMethodId);
            const { startDate, paymentDate } = paymentMethod && paymentMethod.type === "credit" ? getCycleDates(paymentMethod, new Date()) : {}; // Usa la fecha actual para el formulario
            const fixedRecurrenceMonths = isFixed ? parseInt(document.getElementById("fixed-recurrence-months").value) || 1 : 0;

            const newExpense = {
              id: generateUUID(),
              description,
              amount,
              payerId,
              type,
              category,
              subcategory,
              paymentMethodId,
              isFixed,
              date: new Date().toISOString().split("T")[0],
              dateCreated: new Date().toISOString(),
              ccCycleStart: startDate || null,
              ccPaymentDate: paymentDate || null,
              fixedRecurrenceMonths,
            };
            saveState({ expenses: [...appState.expenses, newExpense] });
            e.target.reset();
            // Reiniciar la apariencia de los selects a su estado inicial
            document.querySelectorAll(".custom-select-display").forEach((d) => {
              d.textContent = "Selecciona una opción";
              d.classList.add("text-gray-500");
            });
            document.querySelector("#expense-type-button .custom-select-display").textContent = "Personal";
          } catch (error) {
            showModal("Error al añadir el gasto.", error.message);
          }
        });
      }

      function setupExpenseModalListeners() {
        const modal = document.getElementById("edit-expense-modal");
        const guestContainer = document.getElementById("guest-payer-input-container");
        const guestInput = document.getElementById("guest-payer-name");

        document.getElementById("close-edit-expense-modal-btn").addEventListener("click", () => {
          modal.classList.add("hidden");
          if (editExpenseDatepicker) {
            editExpenseDatepicker.destroy();
            editExpenseDatepicker = null;
          }
        });

        document.getElementById("add-guest-payer-btn").addEventListener("click", () => {
          guestContainer.classList.toggle("hidden");

          const payerButton = document.getElementById("edit-expense-payer-button");
          const payerDisplay = payerButton.querySelector(".custom-select-display");
          const payerInput = document.getElementById("edit-expense-payer");

          payerInput.value = "";
          payerDisplay.textContent = "Selecciona pagador";
          payerDisplay.classList.add("text-gray-500");

          if (!guestContainer.classList.contains("hidden")) {
            guestInput.focus();
          }
        });

        document.getElementById("edit-expense-category").addEventListener("change", (e) => {
          const categoryName = e.target.value;
          const subCatContainer = document.querySelector("#edit-expense-subcategory-button").closest(".custom-select-container");
          const subCatOptions = subCatContainer.querySelector(".custom-select-options");
          const subCatDisplay = subCatContainer.querySelector(".custom-select-display");
          const subCatInput = subCatContainer.querySelector('input[type="hidden"]');
          const subCatButton = subCatContainer.querySelector("button");

          subCatOptions.innerHTML = "";
          subCatDisplay.textContent = "Selecciona subcategoría";
          subCatInput.value = "";

          const selectedCategory = appState.categories.find((c) => c.name === categoryName);
          if (selectedCategory && selectedCategory.subcategories.length > 0) {
            selectedCategory.subcategories.forEach((sub) => {
              subCatOptions.insertAdjacentHTML("beforeend", `<div class="custom-select-option" data-value="${sub}">${sub}</div>`);
            });
            subCatButton.disabled = false;
            subCatButton.classList.remove("bg-gray-100");
          } else {
            subCatButton.disabled = true;
            subCatButton.classList.add("bg-gray-100");
          }
        });

        document.getElementById("edit-expense-form").addEventListener("submit", (e) => {
          e.preventDefault();
          const id = document.getElementById("edit-expense-id").value;
          const newDescription = formatTitleCase(document.getElementById("edit-expense-description").value);
          const newAmount = parseFloat(document.getElementById("edit-expense-amount").value);
          const newDate = document.getElementById("edit-expense-date").value; // <-- AÑADIDA
          const newCategory = document.getElementById("edit-expense-category").value;
          const newSubcategory = formatTitleCase(document.getElementById("edit-expense-subcategory").value);
          const newType = document.getElementById("edit-expense-type").value;
          const newPaymentMethodId = document.getElementById("edit-expense-payment-method-id").value;
          const newIsFixed = document.getElementById("edit-expense-is-fixed").checked;
          let newPayerId = document.getElementById("edit-expense-payer").value;
          let newPayerName = "";

          if (!guestContainer.classList.contains("hidden") && guestInput.value.trim()) {
            newPayerId = `guest_${generateUUID()}`;
            newPayerName = formatTitleCase(guestInput.value);
          } else if (!newPayerId) {
            return showModal("Selecciona un pagador o añade un invitado.");
          }

          if (newAmount <= 0 || !newDescription || !newCategory) {
            return showModal("Completa todos los campos: descripción, monto, y categoría.");
          }

          const updatedExpenses = appState.expenses.map((exp) => {
            if (exp.id === id) {
              return {
                ...exp,
                description: newDescription,
                amount: newAmount,
                date: newDate, // <-- AÑADIDA
                category: newCategory,
                subcategory: newSubcategory,
                type: newType,
                isFixed: newIsFixed,
                paymentMethodId: newPaymentMethodId,
                payerId: newPayerId,
                payerNameGuest: newPayerName,
              };
            }
            return exp;
          });

          saveState({ expenses: updatedExpenses });
          modal.classList.add("hidden");
        });
      }

      function calculateSummary(state, filteredExpenses) {
        const participants = state.participants;
        const participantData = participants.map((p) => ({
          ...p,
          spent: 0,
          contributionPaid: 0,
          contributionByMethod: {},
          expectedContribution: 0,
          sharedSavingsGoal: (p.budget * p.sharedSavingsPercent) / 100,
          independentSavingsGoal: (p.budget * p.independentSavingsPercent) / 100,
          availableForSpending: p.budget * (1 - (p.sharedSavingsPercent + p.independentSavingsPercent) / 100),
        }));

        const participantMap = new Map(participantData.map((p) => [p.id, p]));
        let totalSpent = 0;

        // ¡CLAVE! Crear un 'participante' virtual para los invitados
        const guestSummary = {
          spent: 0,
          contributionPaid: 0,
          balance: 0,
        };

        filteredExpenses.forEach((expense) => {
          const amount = expense.amount || 0;
          const payer = participantMap.get(expense.payerId);

          // A. Registrar quién pagó
          if (payer) {
            payer.contributionPaid += amount;
            const methodId = expense.paymentMethodId || "unknown";
            payer.contributionByMethod[methodId] = (payer.contributionByMethod[methodId] || 0) + amount;
          } else if (expense.payerId.startsWith("guest_")) {
            // ¡CLAVE! Registrar la contribución total del invitado
            guestSummary.contributionPaid += amount;
          }

          // B. Calcular la "parte" de cada uno
          if (expense.type === "shared") {
            totalSpent += amount;
            const isGuestPayer = expense.payerId.startsWith("guest_");
            // La división se hace entre N (participantes) o N+1 (participantes + invitado)
            const numPayees = isGuestPayer ? participants.length + 1 : participants.length;
            const splitAmount = amount / numPayees;

            // Asignar parte a cada participante real
            participantData.forEach((p) => {
              p.spent += splitAmount;
            });

            // ¡CLAVE CORREGIDA! Si un invitado pagó, él también tiene una "parte" de ese gasto
            if (isGuestPayer) {
              guestSummary.spent += splitAmount;
            }
            expense.splitAmount = splitAmount;
          } else {
            // Gasto Personal
            if (payer) {
              totalSpent += amount;
              payer.spent += amount; // Su parte es el 100%
            } else if (expense.payerId.startsWith("guest_")) {
              // ¡CLAVE! Si un invitado paga un gasto personal, es 100% su 'parte'
              totalSpent += amount;
              guestSummary.spent += amount;
            }
          }
        });

        // 3. Calcular balances finales
        let globalTotalRemainingBudget = 0;
        let globalSharedSavingsGoal = 0;

        participantData.forEach((p) => {
          p.balance = p.contributionPaid - p.spent;
          p.remainingBudget = p.availableForSpending - p.spent;
          globalTotalRemainingBudget += p.remainingBudget;
          globalSharedSavingsGoal += p.sharedSavingsGoal;
        });

        // ¡CLAVE! Calcular el balance neto del invitado
        guestSummary.balance = guestSummary.contributionPaid - guestSummary.spent;

        return {
          globalTotalRemainingBudget,
          globalSharedSavingsGoal,
          totalSpent,
          guestBalanceNet: Math.round(guestSummary.balance * 100) / 100, // Devolver el balance neto
          participantData,
        };
      }
      // ================================================================
      // ===== FIN DEL REEMPLAZO 1 =====
      // ================================================================
      function calculateSettlementsByMethod(participantData, paymentMethods) {
        const settlementsByMethod = {};

        // Usamos copia profunda para no modificar los datos originales
        const participants = JSON.parse(JSON.stringify(participantData));
        const methodsMap = new Map(paymentMethods.map((m) => [m.id, m.name]));

        // 1. Iterar por CADA método de pago
        paymentMethods.forEach((method) => {
          const methodId = method.id;
          const methodName = method.name;
          const transactions = [];

          // 2. Encontrar deudores y acreedores SOLO para ESE método
          const debtors = participants.filter((p) => p.balanceByMethod[methodId] && p.balanceByMethod[methodId] < -0.01).sort((a, b) => a.balanceByMethod[methodId] - b.balanceByMethod[methodId]);

          const creditors = participants.filter((p) => p.balanceByMethod[methodId] && p.balanceByMethod[methodId] > 0.01).sort((a, b) => b.balanceByMethod[methodId] - a.balanceByMethod[methodId]);

          let i = 0; // Puntero deudores
          let j = 0; // Puntero acreedores

          // 3. Algoritmo de liquidación (greedy)
          while (i < debtors.length && j < creditors.length) {
            const debtor = debtors[i];
            const creditor = creditors[j];

            // Cuánto debe el deudor y cuánto se le debe al acreedor *en este método*
            const debt = Math.abs(debtor.balanceByMethod[methodId]);
            const credit = creditor.balanceByMethod[methodId];

            const amount = Math.min(debt, credit);

            if (amount > 0.01) {
              // 4. Registrar la transacción
              transactions.push({
                from: debtor.name,
                to: creditor.name,
                amount: amount,
              });

              // 5. Actualizar balances virtuales para seguir calculando
              debtor.balanceByMethod[methodId] += amount;
              creditor.balanceByMethod[methodId] -= amount;
            }

            // 6. Mover punteros si alguien llega a cero
            if (Math.abs(debtor.balanceByMethod[methodId]) < 0.01) i++;
            if (Math.abs(creditor.balanceByMethod[methodId]) < 0.01) j++;
          }

          // 7. Si hubo transacciones, guardarlas bajo el nombre del método
          if (transactions.length > 0) {
            settlementsByMethod[methodName] = transactions;
          }
        });

        return settlementsByMethod;
      }

      function toggleCalendarAccordion() {
        const accordion = document.getElementById("calendar-accordion");
        const content = document.getElementById("calendar-accordion-content");
        const toggleWrapper = document.getElementById("calendar-toggle-wrapper");

        if (!accordion || !content || !toggleWrapper) {
          console.error("Elementos del acordeón del calendario no encontrados.");
          return;
        }

        accordion.classList.toggle("open");
        content.classList.toggle("open");
        toggleWrapper.classList.toggle("hidden"); // Oculta/muestra el icono
      }
      function calculateDailySpending(allExpenses, filterMonthString) {
        const dailySpendingMap = new Map();
        let maxSpending = 0;

        // 1. Filtra los gastos del mes y los agrupa por día
        allExpenses
          .filter((e) => e.date && e.date.startsWith(filterMonthString))
          .forEach((expense) => {
            const day = expense.date; // e.g., "2025-11-05"
            const currentSpending = (dailySpendingMap.get(day) || 0) + expense.amount;
            dailySpendingMap.set(day, currentSpending);
          });

        // 2. Encuentra el gasto máximo de ese mes
        if (dailySpendingMap.size > 0) {
          maxSpending = Math.max(...dailySpendingMap.values());
        }

        return { dailySpendingMap, maxSpending };
      }

      function animateNumber(elementId, finalValue) {
        const element = document.getElementById(elementId);
        if (!element) return;
        const currentValueText = element.textContent
          .replace(/[S/$,]/g, "")
          .trim()
          .replace(",", ".");
        const currentValue = parseFloat(currentValueText) || 0;
        const data = { value: currentValue };
        gsap.to(data, {
          value: finalValue,
          duration: 1.0,
          ease: "power2.out",
          onUpdate: () => {
            element.textContent = formatCurrency(data.value);
            element.classList.toggle("metric-spent", data.value < 0);
            element.classList.toggle("metric-remaining", data.value >= 0);
          },
        });
      }

      function renderDashboard(summary) {
        animateNumber("display-remaining-budget", summary.globalTotalRemainingBudget);
        document.getElementById("display-total-spent").textContent = formatCurrency(summary.totalSpent);

        // --- RENDERIZADO DE LAS MÉTRICAS PRINCIPALES (Ahorro Mutuo / Gastos Fijos) ---
        document.getElementById("display-shared-savings-goal").textContent = formatCurrency(summary.globalSharedSavingsGoal);

        const totalFixed = appState.expenses.filter((e) => e.isFixed).reduce((sum, exp) => sum + exp.amount, 0);
        document.getElementById("display-fixed-total").textContent = formatCurrency(totalFixed);

        // --- RENDERIZADO DE SALDOS INDIVIDUALES ---
        const participantCardsEl = document.getElementById("participant-summary-cards");

        // Cambiamos el H3 de la sección principal al título "Saldos Individuales"
        const saldosTitleEl = document.querySelector("#saldos-individuales-card h3");
        if (saldosTitleEl) {
          saldosTitleEl.textContent = "Saldos Individuales";
        }

        participantCardsEl.innerHTML = summary.participantData
          .map((p) => {
            const summaryData = summary.participantData.find((pd) => pd.id === p.id) || {};
            const personalFixedExpenses = appState.expenses.filter((e) => e.isFixed && e.type === "personal" && e.payerId === p.id).reduce((sum, exp) => sum + exp.amount, 0);
            const popoverId = `saldo-popover-${p.id}`;

            // Estructura final para cada participante
            return `
            <div class="section-card-gray-bg cursor-pointer" id="participant-card-${p.id}">
                <h2>${p.name}</h2>
                <div class="balance-remaining-card" data-popover-target="${popoverId}" data-popover-trigger="hover" data-popover-placement="bottom" data-popover-offset="4">
                    <p>SALDO RESTANTE</p>
                    <span>${formatCurrency(summaryData.remainingBudget)}</span>
                </div>
            </div>

            <div data-popover id="${popoverId}" role="tooltip" class="popover invisible opacity-0 z-10 saldos-popover">
                <div class="saldos-individuales-list">
                    <div class="flex justify-between items-center">
                        <span>Ahorro Personal</span>
                        <span>${formatCurrency(p.independentSavingsGoal)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Aporte Mutuo</span>
                        <span>${formatCurrency(p.sharedSavingsGoal)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Gastos fijos</span>
                        <span>${formatCurrency(personalFixedExpenses)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Gasto total</span>
                        <span>${formatCurrency(p.spent)}</span>
                    </div>
                </div>
                <div data-popper-arrow class="popover-arrow"></div>
            </div>
        `;
          })
          .join("");
        activePopovers.forEach((popover) => popover.destroy());
        activePopovers = []; // Resetea el array

        // 2. Busca e inicializa los nuevos popovers
        participantCardsEl.querySelectorAll("[data-popover-target]").forEach((triggerEl) => {
          const popoverId = triggerEl.getAttribute("data-popover-target");
          const popoverEl = document.getElementById(popoverId);

          if (popoverEl && window.Popover) {
            const options = {
              placement: triggerEl.getAttribute("data-popover-placement") || "bottom", // Asegurarse de que esté en 'bottom'
              triggerType: triggerEl.getAttribute("data-popover-trigger") || "hover",
              offset: parseInt(triggerEl.getAttribute("data-popover-offset")) || 4, // Asegurarse de que el offset se lea
            };

            const popoverInstance = new window.Popover(popoverEl, triggerEl, options);
            activePopovers.push(popoverInstance);
          }
        });
      }

      function renderParticipantsConfig(participants, summary) {
        const countBadge = document.getElementById("sidebar-participant-count");
        if (countBadge) {
          const count = participants.length;
          countBadge.textContent = count;
          // Muestra la insignia solo si hay más de 0 participantes
          countBadge.classList.toggle("show", count > 0);
        }

        const listEl = document.getElementById("participants-list");
        listEl.innerHTML = participants
          .map((p) => {
            const summaryData = summary.participantData.find((pd) => pd.id === p.id) || {};
            const balanceColor = summaryData.remainingBudget < 0 ? "text-red-600" : "text-green-600";

            let linkButtonHtml = "";
            const isLinkedToMe = p.firebaseUid === userId;
            const isLinkedToSomeoneElse = p.firebaseUid && p.firebaseUid !== userId;

            if (isLinkedToMe) {
              linkButtonHtml = `<span class="text-xs text-green-700 font-bold flex items-center justify-center py-1 mt-2 bg-green-100 rounded-lg"><i class="fas fa-link mr-1"></i> Vinculado a ti</span>`;
            } else if (isLinkedToSomeoneElse) {
              linkButtonHtml = `<span class="text-xs text-gray-700 font-bold flex items-center justify-center py-1 mt-2 bg-gray-100 rounded-lg"><i class="fas fa-user-lock mr-1"></i> Vinculado (otro)</span>`;
            } else if (userId && userId !== "anonymous_canvas" && !myParticipantId) {
              linkButtonHtml = `<button data-id="${p.id}" class="link-participant-btn w-full py-1 mt-2 bg-indigo-500 text-white text-xs font-bold rounded-lg hover:bg-indigo-600">Vincular mi Cuenta</button>`;
            }

            return `
                <div class="participant-card space-y-1 relative">
                                        <div class="absolute top-2 right-2 flex gap-1">
                        <button data-id="${p.id}" class="edit-participant-btn text-gray-400 hover:text-blue-600 w-6 h-6 rounded-md hover:bg-gray-100 flex items-center justify-center" title="Editar">
                        <i class="fas fa-pencil-alt fa-xs"></i>
                      </button>
                        <button data-id="${p.id}" class="remove-participant-btn text-gray-400 hover:text-red-600 w-6 h-6 rounded-md hover:bg-gray-100 flex items-center justify-center" title="Eliminar">
                        <i class="fas fa-times fa-sm"></i>
                      </button>
                    </div>

                                        <h4 class="font-bold text-lg text-gray-800 pr-12">${p.name}</h4>

                                        <div class="border-t pt-1.5 mt-1.5"> 
                        <p class="text-sm text-gray-600">Presupuesto: <span class="font-semibold">${formatCurrency(p.budget)}</span></p>
                        <p class="text-md font-semibold mt-1">Saldo: <span class="${balanceColor}">${formatCurrency(summaryData.remainingBudget)}</span></p>
                    </div>
                    
                    ${linkButtonHtml} 
                                    </div>`;
          })
          .join("");

        listEl.querySelectorAll(".edit-participant-btn").forEach((btn) => btn.addEventListener("click", (e) => openParticipantEditModal(e.currentTarget.dataset.id)));
        listEl.querySelectorAll(".remove-participant-btn").forEach((btn) => btn.addEventListener("click", (e) => removeParticipant(e.currentTarget.dataset.id)));
        listEl.querySelectorAll(".link-participant-btn").forEach((btn) => btn.addEventListener("click", (e) => linkParticipantToUser(e.currentTarget.dataset.id)));
        updateExpenseFormParticipants(participants);
        // MODIFICADO: Actualizar etiquetas de filtro de participantes
        updateDynamicFilterTagOptions();
      }

      // MODIFICADO: Poblar contenedores de etiquetas en el popover
      // ================================================================
      // ===== 3. REEMPLAZA ESTA FUNCIÓN COMPLETA =====
      // ================================================================
      function updateDynamicFilterTagOptions() {
        const categoryTagsContainer = document.getElementById("filter-tag-categories");
        const participantTagsContainer = document.getElementById("filter-tag-participants");
        const paymentMethodTagsContainer = document.getElementById("filter-tag-payment-methods");

        categoryTagsContainer.innerHTML = "";
        participantTagsContainer.innerHTML = "";
        paymentMethodTagsContainer.innerHTML = "";

        // Añadir etiquetas de categoría (Sin cambios)
        if (appState.categories.length > 0) {
          appState.categories.forEach((cat) => {
            const isActive = activeFilters.category === cat.name;
            categoryTagsContainer.insertAdjacentHTML("beforeend", `<button data-value="${cat.name}" class="filter-tag category-tag ${isActive ? "active" : ""}">${cat.name}</button>`);
          });
        } else {
          categoryTagsContainer.innerHTML = '<span class="text-xs text-gray-500 italic m-1">No hay categorías.</span>';
        }

        // --- INICIO DE MODIFICACIÓN ---
        // Añadir etiquetas de participante
        if (appState.participants.length > 0) {
          appState.participants.forEach((p) => {
            const isActive = activeFilters.participant === p.id;
            participantTagsContainer.insertAdjacentHTML("beforeend", `<button data-value="${p.id}" class="filter-tag participant-tag ${isActive ? "active" : ""}">${p.name}</button>`);
          });
        } else {
          participantTagsContainer.innerHTML = '<span class="text-xs text-gray-500 italic m-1">No hay participantes.</span>';
        }

        // ¡NUEVO! Añadir etiqueta estática de Invitado
        const isGuestActive = activeFilters.guestOnly;
        participantTagsContainer.insertAdjacentHTML(
          "beforeend",
          `
            <button data-value="guest" class="filter-tag participant-tag ${isGuestActive ? "active" : ""}">
                <i class="fas fa-user-tag fa-fw mr-1"></i>Invitado
            </button>
        `
        );
        // --- FIN DE MODIFICACIÓN ---

        // Añadir etiquetas de método de pago (Sin cambios)
        if (appState.paymentMethods.length > 0) {
          appState.paymentMethods.forEach((m) => {
            const isActive = activeFilters.paymentMethod === m.id;
            paymentMethodTagsContainer.insertAdjacentHTML("beforeend", `<button data-value="${m.id}" class="filter-tag payment-method-tag ${isActive ? "active" : ""}">${m.name}</button>`);
          });
        } else {
          paymentMethodTagsContainer.innerHTML = '<span class="text-xs text-gray-500 italic m-1">No hay métodos de pago.</span>';
        }
      }

      function renderCategoriesModal(categories) {
        const displayEl = document.getElementById("categories-display");
        const optionsContainer = document.querySelector("#expense-category-button").nextElementSibling;
        const editCategoryOptions = document.querySelector("#edit-expense-category-button")?.nextElementSibling;

        displayEl.innerHTML = "";
        optionsContainer.innerHTML = "";
        if (editCategoryOptions) editCategoryOptions.innerHTML = "";

        if (categories.length === 0) {
          displayEl.innerHTML = '<p class="text-sm italic">No hay categorías definidas.</p>';
        } else {
          categories.forEach((cat) => {
            const budgetInfo = cat.budget > 0 ? `Presupuesto: ${formatCurrency(cat.budget)}` : "Sin presupuesto";
            displayEl.insertAdjacentHTML(
              "beforeend",
              `
                    <div class="p-3 bg-white rounded-lg border flex justify-between items-start">
                        <div>
                            <span class="font-bold">${cat.name}</span>
                            <p class="text-xs text-gray-600">${budgetInfo}</p>
                            <p class="text-xs text-gray-500 mt-1">Subcategorías: ${cat.subcategories.join(", ") || "Ninguna"}</p>
                        </div>
                        <button data-name="${cat.name}" class="remove-category-btn text-gray-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </div>`
            );
            const optionHTML = `<div class="custom-select-option" data-value="${cat.name}">${cat.name}</div>`;
            optionsContainer.insertAdjacentHTML("beforeend", optionHTML);
            if (editCategoryOptions) editCategoryOptions.insertAdjacentHTML("beforeend", optionHTML);
          });
          displayEl.querySelectorAll(".remove-category-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => removeCategory(e.currentTarget.dataset.name));
          });
        }
        // MODIFICADO: Actualizar etiquetas de filtro de categorías
        updateDynamicFilterTagOptions();
      }

      function removeCategory(nameToRemove) {
        // NUEVO: Desactivar filtro si se elimina la categoría activa
        if (activeFilters.category === nameToRemove) {
          activeFilters.category = null;
        }
        saveState({ categories: appState.categories.filter((c) => c.name !== nameToRemove) });
      }

      function openExpenseEditModal(expenseId) {
        const expense = appState.expenses.find((e) => e.id === expenseId);
        if (!expense) return;
        const modal = document.getElementById("edit-expense-modal");

        document.getElementById("edit-expense-id").value = expense.id;
        document.getElementById("edit-expense-description").value = expense.description;
        document.getElementById("edit-expense-amount").value = expense.amount;
        // La fecha 'value' la pondremos con el datepicker
        document.getElementById("edit-expense-is-fixed").checked = expense.isFixed;

        // (Aquí va todo tu código 'setCustomSelect'...)
        const setCustomSelect = (type, value) => {
          const button = document.getElementById(`edit-expense-${type}-button`);
          if (!button) return;
          const display = button.querySelector(".custom-select-display");
          const input = document.getElementById(`edit-expense-${type}`);
          if (!input) return;
          const optionsContainer = button.nextElementSibling;
          if (!optionsContainer) return;
          const option = Array.from(optionsContainer.querySelectorAll(".custom-select-option")).find((opt) => opt.dataset.value === value);
          display.textContent = option ? option.textContent.trim() : `Seleccionar`;
          display.classList.toggle("text-gray-500", !option);
          input.value = value;
          optionsContainer.querySelectorAll(".custom-select-option").forEach((opt) => {
            opt.classList.toggle("selected", opt.dataset.value === value);
          });
        };

        setCustomSelect("payer", expense.payerId);
        setCustomSelect("type", expense.type);
        setCustomSelect("payment-method-id", expense.paymentMethodId);
        const categoryInput = document.getElementById("edit-expense-category");
        setCustomSelect("category", expense.category);
        if (categoryInput) categoryInput.dispatchEvent(new Event("change", { bubbles: true }));
        setTimeout(() => {
          setCustomSelect("subcategory", expense.subcategory);
        }, 0);
        // (...Fin del código 'setCustomSelect')

        modal.classList.remove("hidden");
        modal.classList.add("flex");

        // --- ¡INICIO DEL CÓDIGO NUEVO! ---
        const datepickerEl = document.getElementById("edit-expense-date");

        // Usamos window.Datepicker para acceder desde el módulo
        if (datepickerEl && typeof window.Datepicker !== "undefined") {
          // Destruye cualquier instancia vieja
          if (editExpenseDatepicker) {
            editExpenseDatepicker.destroy();
          }

          // Crea la nueva instancia
          editExpenseDatepicker = new window.Datepicker(datepickerEl, {
            format: "yyyy-mm-dd",
            autohide: true,
          });

          // Pone la fecha guardada del gasto
          editExpenseDatepicker.setDate(expense.date);
        }
        // --- FIN DEL CÓDIGO NUEVO ---
      }

      // NUEVA FUNCIÓN CLAVE PARA INICIALIZAR SELECTS
      function initializeCustomSelect(containerId) {
        const container = document.getElementById(containerId).closest(".custom-select-container");
        if (!container) return;

        const button = container.querySelector(".custom-select-button");
        const optionsContainer = container.querySelector(".custom-select-options");
        const hiddenInput = container.querySelector('input[type="hidden"]');
        const display = button?.querySelector(".custom-select-display");

        if (!button || !optionsContainer || !hiddenInput || !display) return;

        // 1. Encontrar todas las opciones disponibles
        const options = Array.from(optionsContainer.querySelectorAll(".custom-select-option"));

        // 2. Si hay opciones y el input está vacío, auto-seleccionar la primera opción
        if (options.length > 0 && !hiddenInput.value) {
          const firstOption = options[0];
          hiddenInput.value = firstOption.dataset.value;
          display.textContent = firstOption.textContent.trim();
          display.classList.remove("text-gray-500");

          options.forEach((opt) => opt.classList.remove("selected"));
          firstOption.classList.add("selected");
        } else if (options.length > 0 && hiddenInput.value) {
          // 3. Si hay un valor, asegurar que la UI lo refleje y esté seleccionado
          const selectedOption = options.find((opt) => opt.dataset.value === hiddenInput.value);
          if (selectedOption) {
            display.textContent = selectedOption.textContent.trim();
            display.classList.remove("text-gray-500");
            options.forEach((opt) => opt.classList.remove("selected"));
            selectedOption.classList.add("selected");
          }
        } else if (options.length === 0) {
          // 4. Si no hay opciones, resetear el display
          hiddenInput.value = "";
          display.textContent = "Selecciona una opción";
          display.classList.add("text-gray-500");
        }

        // 5. Disparar evento change si hay un valor, por si necesita actualizar otro select (ej. Categoría -> Subcategoría)
        if (hiddenInput.value) {
          hiddenInput.dispatchEvent(new Event("change", { bubbles: true }));
        }
      }
      // FIN NUEVA FUNCIÓN CLAVE

      function updateExpenseFormParticipants(participants) {
        const payerOptions = document.querySelector("#expense-paid-by-button").nextElementSibling;
        const editPayerOptions = document.querySelector("#edit-expense-payer-button").nextElementSibling;
        // CORRECCION: Verificar si los elementos existen
        if (!payerOptions || !editPayerOptions) return;
        payerOptions.innerHTML = "";
        editPayerOptions.innerHTML = "";
        participants.forEach((p) => {
          const optionHtml = `<div class="custom-select-option" data-value="${p.id}">${p.name}</div>`;
          payerOptions.insertAdjacentHTML("beforeend", optionHtml);
          editPayerOptions.insertAdjacentHTML("beforeend", optionHtml);
        });
        // NOTA: La inicialización se movió a renderUI para manejar el estado completo.
      }

      function resetPaymentForm() {
        document.getElementById("payment-method-form").reset();
        document.getElementById("method-id-to-edit").value = "";
        document.getElementById("cc-config-fields").classList.add("hidden");
        document.getElementById("payment-form-title").textContent = "Añadir Nuevo Método:";
        document.getElementById("save-method-btn").textContent = "Añadir Método";
        document.getElementById("cancel-edit-method-btn").classList.add("hidden");
      }

      function openPaymentMethodEditModal(id) {
        const method = appState.paymentMethods.find((m) => m.id === id);
        if (!method) return;
        resetPaymentForm();
        document.getElementById("method-id-to-edit").value = id;
        document.getElementById("method-name").value = method.name;
        document.getElementById("method-type").value = method.type;
        document.getElementById("payment-form-title").textContent = `Editar: ${method.name}`;
        document.getElementById("save-method-btn").textContent = "Guardar Cambios";
        document.getElementById("cancel-edit-method-btn").classList.remove("hidden");
        if (method.type === "credit") {
          document.getElementById("cc-config-fields").classList.remove("hidden");
          document.getElementById("cc-config-payment-day").value = method.paymentDay;
        }
      }

      function removePaymentMethod(idToRemove) {
        if (["m1", "m2"].includes(idToRemove)) return showModal("No puedes eliminar los métodos de pago predeterminados.");
        // NUEVO: Desactivar filtro si se elimina el método activo
        if (activeFilters.paymentMethod === idToRemove) {
          activeFilters.paymentMethod = null;
        }
        saveState({ paymentMethods: appState.paymentMethods.filter((m) => m.id !== idToRemove) });
      }

      function renderPaymentMethodsModal(methods) {
        const displayEl = document.getElementById("payment-methods-display");
        const optionsContainer = document.querySelector("#expense-payment-method-id-button").nextElementSibling;
        const editOptionsContainer = document.querySelector("#edit-expense-payment-method-id-button").nextElementSibling;

        displayEl.innerHTML = "";
        // CORRECCION: Verificar si los elementos existen
        if (optionsContainer) optionsContainer.innerHTML = "";
        if (editOptionsContainer) editOptionsContainer.innerHTML = "";

        methods.forEach((m) => {
          const details = m.type === "credit" ? `Pago: Día ${m.paymentDay}` : "Transacción inmediata.";
          displayEl.insertAdjacentHTML(
            "beforeend",
            `
                <div class="p-3 bg-white border flex justify-between items-center">
                    <div><span class="font-bold">${m.name}</span><p class="text-xs text-gray-600">${details}</p></div>
                    <div class="flex space-x-2">
                        <button data-id="${m.id}" class="edit-method-btn text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button>
                        ${!["m1", "m2"].includes(m.id) ? `<button data-id="${m.id}" class="remove-method-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>` : ""}
                    </div>
                </div>`
          );
          const optionHTML = `<div class="custom-select-option" data-value="${m.id}">${m.name}</div>`;
          if (optionsContainer) optionsContainer.insertAdjacentHTML("beforeend", optionHTML);
          if (editOptionsContainer) editOptionsContainer.insertAdjacentHTML("beforeend", optionHTML);
        });

        displayEl.querySelectorAll(".remove-method-btn").forEach((btn) => btn.addEventListener("click", (e) => removePaymentMethod(e.currentTarget.dataset.id)));
        displayEl.querySelectorAll(".edit-method-btn").forEach((btn) => btn.addEventListener("click", (e) => openPaymentMethodEditModal(e.currentTarget.dataset.id)));
        // NUEVO: Actualizar etiquetas de filtro de método de pago
        updateDynamicFilterTagOptions();
        // NOTA: La inicialización se movió a renderUI
      }

      // MODIFICADO: Adaptar a la nueva estructura de tarjeta de historial (más limpio y visual)
      // ===== PEGA ESTE CÓDIGO COMPLETO PARA REEMPLAZAR LA FUNCIÓN ANTIGUA =====
      function createExpenseCardHTML(expense, participantsMap, paymentMethodsMap, showAmount = true) {
        let payerName = participantsMap.get(expense.payerId) || expense.payerNameGuest || "Desconocido";
        const paymentMethod = paymentMethodsMap.get(expense.paymentMethodId);
        const isShared = expense.type === "shared";
        const isFixed = expense.isFixed;
        const isGuestPayer = expense.payerId && expense.payerId.startsWith("guest_"); // <-- NUEVA LÍNEA
        let amountColorClass = isShared ? "text-red-600" : "text-blue-600";

        const dateObj = new Date(expense.date + "T00:00:00Z");
        const dayNum = dateObj.getUTCDate();
        const dayName = DAY_NAMES[dateObj.getUTCDay()];

        const subcategoryLabel = expense.subcategory ? ` (${expense.subcategory})` : "";
        const typeLabel = isFixed ? "Gasto Fijo" : isShared ? "Compartido" : "Personal";

        let typeIcon = isFixed
          ? "fas fa-thumbtack text-purple-500"
          : isGuestPayer
          ? "fas fa-user-tag text-gray-500" // <-- NUEVO ICONO
          : isShared
          ? "fas fa-users text-red-500"
          : "fas fa-user text-blue-500";

        const categoryTag = expense.category ? `<span class="expense-card-tag category">${expense.category}</span>` : "";
        const paymentMethodTag = paymentMethod ? `<span class="expense-card-tag payment-method">${paymentMethod.name}</span>` : "";
        const tagsHTML = `<div class="mt-1">${categoryTag}${paymentMethodTag}</div>`;

        let detailContent = "";
        if (isShared) {
          const splitAmount = expense.splitAmount || (appState.participants.length > 0 ? expense.amount / appState.participants.length : expense.amount);
          let balanceTags = appState.participants
            .map((p) => {
              if (p.id !== expense.payerId) {
                return `<span class='inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 mr-1'>${p.name}: Debe ${formatCurrency(splitAmount)}</span>`;
              }
              return "";
            })
            .join("");
          detailContent = `<p class="text-xs font-semibold text-gray-700 mb-2 border-t pt-2 mt-2">Repartición (${appState.participants.length} personas):</p><div class='flex flex-wrap gap-1 mb-1'>${balanceTags}</div>`;
        }

        const detailSectionHTML = `
                    <div id='detail-${expense.id}' class='expense-detail ${isShared ? "hidden" : ""}'>
                        <div class='mt-1'>
                            ${detailContent}
                        </div>
                    </div>`;

        const actionButtonsHTML = `
                    <div class='flex gap-4 mt-2 pt-2 border-t border-dashed border-gray-200 justify-end'>
                        <button data-id='${expense.id}' class='edit-expense-btn text-gray-500 hover:text-blue-500 text-xs font-bold flex items-center gap-1'><i class='fas fa-edit'></i> Editar</button>
                        <button data-id='${expense.id}' class='delete-btn text-gray-500 hover:text-red-500 text-xs font-bold flex items-center gap-1'><i class='fas fa-trash'></i> Eliminar</button>
                    </div>`;

        // Estructura final de la tarjeta SIN comentarios internos
        return `
                <div class='history-card ${expense.isProjected ? "border-dashed border-gray-400 opacity-80" : ""}' data-expense-id='${expense.id}'>
                    <div class='history-date-col'>
                        <span class='history-day-name'>${dayName}</span>
                        <span class='history-day-num'>${dayNum}</span>
                    </div>

                    <div class='history-content-col'>
                        <div class='flex items-center space-x-2 ${isShared ? "expense-header cursor-pointer" : ""}' ${isShared ? `data-toggle='${expense.id}'` : ""}>
                            <i class="${typeIcon} text-lg flex-shrink-0"></i>
                            <p class='font-bold text-gray-800 flex-1 min-w-0 truncate'>${expense.description}${subcategoryLabel}</p>
                            ${isShared ? '<i class="fas fa-chevron-down text-gray-400 text-xs ml-auto transition-transform duration-200"></i>' : ""}
                        </div>

                        ${tagsHTML}
                        ${isGuestPayer ? "" : `<p class='text-xs text-gray-500 mt-1'>Pagado por: <strong class="font-semibold text-gray-700">${payerName}</strong></p>`}

                        ${isShared ? detailSectionHTML : ""}

                        ${actionButtonsHTML}
                    </div>

                    <div class='history-amount-col'>
                        <p class='text-xl font-extrabold ${amountColorClass}'>${formatCurrency(expense.amount)}</p>
                        <p class='text-xs text-gray-500 mt-1'>${typeLabel}</p>
                    </div>
                </div>`;
      }
      // ===== FIN DEL CÓDIGO A PEGAR =====

      // MODIFICADO: Aplicar filtros antes de renderizar el reporte y añadir la barra de progreso de presupuesto.
      // ================================================================
      // ===== 1. REEMPLAZA ESTA FUNCIÓN COMPLETA =====
      // ================================================================
      function renderExpenseReportByCategory(allExpensesInMonth, summary) {
        const reportEl = document.getElementById("expense-report-by-category");
        const paymentMethodsMap = new Map(appState.paymentMethods.map((m) => [m.id, m]));
        reportEl.innerHTML = "";
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const expensesToDisplay = allExpensesInMonth.filter((exp) => {
          const method = paymentMethodsMap.get(exp.paymentMethodId);

          if (!method || method.type !== "credit") {
            return true;
          }
          if (!exp.ccPaymentDate) {
            return true;
          }
          const paymentDate = new Date(exp.ccPaymentDate + "T00:00:00Z");
          if (paymentDate < today) {
            return false;
          }
          return true;
        });

        // Obtener valores de los filtros desde el estado global `activeFilters`
        const descriptionFilter = activeFilters.description;
        const categoryFilter = activeFilters.category;
        const participantFilter = activeFilters.participant;
        const paymentMethodFilter = activeFilters.paymentMethod;
        const guestOnlyFilter = activeFilters.guestOnly; // <-- ¡ESTA ES LA LÍNEA QUE FALTABA!

        // Filtrar los gastos
        let filteredExpenses = allExpensesInMonth;

        if (descriptionFilter) {
          filteredExpenses = filteredExpenses.filter((e) => e.description.toLowerCase().includes(descriptionFilter) || (e.subcategory && e.subcategory.toLowerCase().includes(descriptionFilter)));
        }
        if (categoryFilter) {
          filteredExpenses = filteredExpenses.filter((e) => e.category === categoryFilter);
        }
        if (participantFilter) {
          filteredExpenses = filteredExpenses.filter((e) => e.payerId === participantFilter);
        }
        if (paymentMethodFilter) {
          filteredExpenses = filteredExpenses.filter((e) => e.paymentMethodId === paymentMethodFilter);
        }
        if (guestOnlyFilter) {
          filteredExpenses = filteredExpenses.filter((e) => e.payerId.startsWith("guest_"));
        }

        // (El resto de la función es idéntico y no necesita cambios)
        document.getElementById("expense-diagnostic").textContent = `Mostrando ${filteredExpenses.length} de ${allExpensesInMonth.length} gastos en este ciclo.`;

        if (filteredExpenses.length === 0) {
          reportEl.innerHTML = `<p class='text-gray-500 text-center py-8 italic'>No hay gastos que coincidan con los filtros aplicados.</p>`;
          return;
        }

        const participantsMap = new Map(appState.participants.map((p) => [p.id, p.name]));
        const groupedExpenses = filteredExpenses.reduce((acc, expense) => {
          const category = expense.category || "Sin Categoría";
          if (!acc[category]) acc[category] = [];
          acc[category].push(expense);
          return acc;
        }, {});

        Object.keys(groupedExpenses)
          .sort()
          .forEach((categoryName) => {
            const expenses = groupedExpenses[categoryName];
            const categoryTotal = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const categoryConfig = appState.categories.find((c) => c.name === categoryName);
            const budget = categoryConfig?.budget || 0;
            const contentId = `category-content-${categoryName.replace(/[^a-zA-Z0-9]/g, "-")}-${Date.now()}`;
            const remaining = budget - categoryTotal;
            const percentUsed = budget > 0 ? (categoryTotal / budget) * 100 : 0;
            const barWidth = Math.min(100, percentUsed);
            let barColor = "bg-indigo-500";
            let statusText = budget > 0 ? `Presupuesto: ${formatCurrency(budget)}` : "Gasto total en esta categoría.";
            let statusTextColor = "text-gray-600";

            if (budget > 0) {
              if (percentUsed > 100) {
                barColor = "bg-red-500";
                statusText = `<i class="fas fa-exclamation-triangle mr-1"></i> ¡Excedido por ${formatCurrency(Math.abs(remaining))}!`;
                statusTextColor = "text-red-600 font-semibold";
              } else if (percentUsed > 80) {
                barColor = "bg-yellow-500";
                statusText = `Quedan ${formatCurrency(remaining)} / ${formatCurrency(budget)}.`;
                statusTextColor = "text-yellow-600";
              } else {
                barColor = "bg-green-500";
                statusText = `Quedan ${formatCurrency(remaining)} / ${formatCurrency(budget)}.`;
                statusTextColor = "text-green-600";
              }
            }

            const budgetTrackerHTML =
              budget > 0
                ? `
                    <div class="mt-2 mb-3 space-y-1">
                        <p class="text-xs ${statusTextColor}">${statusText}</p>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill ${barColor}" style="width: ${barWidth}%;"></div>
                        </div>
                    </div>
                `
                : "";
            const categoryContainer = document.createElement("div");
            categoryContainer.className = "bg-gray-50 p-4 rounded-xl border mb-3";
            const headerHTML = `
                    <button class='category-toggle-btn w-full text-left flex justify-between items-center pb-2 border-b' data-target-id="${contentId}">
                        <h4 class='text-lg font-bold text-gray-700'>${categoryName}</h4>
                        <div class="flex items-center">
                            <span class='font-semibold mr-3'>${formatCurrency(categoryTotal)}</span>
                            <i class="category-chevron fas fa-chevron-down text-gray-400 text-sm transition-transform duration-300"></i>
                        </div>
                    </button>
                `;
            const contentHTML = `
                    <div id="${contentId}" class="category-collapsible-content">
                        <div class="py-3"> 
                          ${budgetTrackerHTML}
                          <div class="space-y-3"> 
                            ${expenses
                              .sort((a, b) => new Date(b.dateCreated || b.date + "T00:00:00Z") - new Date(a.dateCreated || a.date + "T00:00:00Z"))
                              .map((exp) => createExpenseCardHTML(exp, participantsMap, paymentMethodsMap, true))
                              .join("")}
                          </div>
                        </div>
                    </div>
                `;
            categoryContainer.innerHTML = headerHTML + contentHTML;
            reportEl.appendChild(categoryContainer);
          });

        reportEl.removeEventListener("click", handleExpenseReportClick);
        reportEl.addEventListener("click", handleExpenseReportClick);
      }
      // ====================================================================================
      // --- NUEVA FUNCIÓN: LÓGICA DE RESALTADO DE CICLOS DE TC ---
      // ====================================================================================
      /**
       * Calcula los días de ciclo activo y días de pago para todas las tarjetas de crédito.
       * NOTA: Esto usa 'new Date()' para obtener los ciclos *actuales*,
       * independientemente del mes que se esté viendo en el calendario.
       */
      function getCalendarCycleHighlights() {
        const activeCycleDates = new Set();
        const paymentDates = new Set();
        const today = new Date(); // Usamos 'hoy' para calcular los ciclos *actuales*

        try {
          const creditCards = appState.paymentMethods.filter((m) => m.type === "credit" && m.paymentDay);

          creditCards.forEach((card) => {
            // Usamos la función que ya existe en tu código
            const { startDate, closingDate, paymentDate } = getCycleDates(card, today);

            if (paymentDate) {
              paymentDates.add(paymentDate);
            }

            if (startDate && closingDate) {
              let currentDate = new Date(startDate + "T00:00:00Z");
              const endDate = new Date(closingDate + "T00:00:00Z");

              // Itera día por día y añade al Set
              while (currentDate <= endDate) {
                activeCycleDates.add(currentDate.toISOString().split("T")[0]);
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
              }
            }
          });
        } catch (error) {
          console.error("Error al calcular los ciclos del calendario:", error);
        }

        return { activeCycleDates, paymentDates };
      }

      // ================================================================
      // ===== INICIO: REEMPLAZO COMPLETO DE renderInteractiveCalendar =====
      // ================================================================
      // ================================================================
      // ===== REEMPLAZA LA FUNCIÓN COMPLETA CON ESTA VERSIÓN =====
      // ================================================================
      function renderInteractiveCalendar() {
        // (El código de reseteo del acordeón se mantiene)
        const content = document.getElementById("calendar-accordion-content");
        const accordion = document.getElementById("calendar-accordion");
        const toggleWrapper = document.getElementById("calendar-toggle-wrapper");
        if (content) content.classList.remove("open");
        if (accordion) accordion.classList.remove("open");
        if (toggleWrapper) toggleWrapper.classList.remove("hidden");

        // 1. Obtener elementos de la UI
        const monthNameEl = document.getElementById("current-month-name");
        const yearEl = document.getElementById("current-year");
        const currentWeekGridEl = document.getElementById("calendar-grid-current-week");
        const otherWeeksGridEl = document.getElementById("calendar-grid-other-weeks");

        if (!monthNameEl || !yearEl || !currentWeekGridEl || !otherWeeksGridEl) {
          console.error("Faltan elementos del calendario interactivo en el DOM.");
          return;
        }

        // 2. Limpiar contenido anterior
        currentWeekGridEl.innerHTML = "";
        otherWeeksGridEl.innerHTML = "";

        // 3. Obtener datos de fechas
        const viewDate = currentFilterDate;
        const viewYear = viewDate.getFullYear();
        const viewMonth = viewDate.getMonth();
        const today = new Date();
        const todayString = today.toISOString().split("T")[0];
        const filterMonthString = getFilterMonthString(viewDate); // e.g., "2025-11"

        monthPickerYear = viewYear;
        monthNameEl.textContent = MONTH_NAMES[viewMonth];
        yearEl.textContent = viewYear;

        // 4. Lógica de Gastos (para las barras)
        const { dailySpendingMap, maxSpending } = calculateDailySpending(appState.expenses, filterMonthString);

        renderMonthPickerDropdown();

        // 6. Lógica de generación de la cuadrícula del calendario
        const firstDayOfMonth = new Date(viewYear, viewMonth, 1).getDay(); // 0=Domingo
        const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
        const calendarDays = [];

        // (Rellenar calendarDays - sin cambios)
        const daysInPrevMonth = new Date(viewYear, viewMonth, 0).getDate();
        for (let i = 0; i < firstDayOfMonth; i++) {
          const day = daysInPrevMonth - firstDayOfMonth + 1 + i;
          calendarDays.push({
            date: new Date(viewYear, viewMonth - 1, day),
            isCurrentMonth: false,
          });
        }
        for (let i = 1; i <= daysInMonth; i++) {
          calendarDays.push({
            date: new Date(viewYear, viewMonth, i),
            isCurrentMonth: true,
            dayNum: i,
          });
        }
        const remainingCells = 42 - calendarDays.length;
        for (let i = 1; i <= remainingCells; i++) {
          calendarDays.push({
            date: new Date(viewYear, viewMonth + 1, i),
            isCurrentMonth: false,
          });
        }

        // 7. Renderizar los días en las cuadrículas
        const allDayElements = [];

        calendarDays.forEach((day, index) => {
          const dateString = day.date.toISOString().split("T")[0];
          const dayNum = day.isCurrentMonth ? day.dayNum : day.date.getDate();

          const daySpending = dailySpendingMap.get(dateString) || 0;
          const barHeightPercentage = maxSpending > 0 ? (daySpending / maxSpending) * 100 : 0;

          const classes = ["calendar-day"];
          if (!day.isCurrentMonth) classes.push("other-month");
          if (dateString === todayString) classes.push("today");

          allDayElements.push(`
      <div class="${classes.join(" ")}">
        <span class="calendar-day-number">${dayNum}</span>
        <div class="calendar-day-bar" style="height: ${barHeightPercentage}%;"></div>
      </div>
    `);
        });

        const dayElements = allDayElements;

        if (!dayElements || dayElements.length < 42) {
          console.error("Fallo al generar los elementos del día del calendario", dayElements ? dayElements.length : 0);
          return;
        }
        const finalDayElements = dayElements.slice(0, 42);
        let todayRowIndex = -1;
        const isCurrentMonthView = today.getFullYear() === viewYear && today.getMonth() === viewMonth;

        // Solo busca la semana de "hoy" SI estamos viendo el mes actual
        if (isCurrentMonthView) {
          for (let i = 0; i < finalDayElements.length; i++) {
            if (finalDayElements[i].includes("today")) {
              todayRowIndex = Math.floor(i / 7);
              break;
            }
          }
        }

        if (todayRowIndex === -1) {
          let firstDayOfMonthIndex = -1;
          for (let i = 0; i < finalDayElements.length; i++) {
            if (!finalDayElements[i].includes("other-month")) {
              firstDayOfMonthIndex = i;
              break;
            }
          }
          // Esto asegura que en meses pasados/futuros, la semana visible sea la 0
          todayRowIndex = firstDayOfMonthIndex !== -1 ? Math.floor(firstDayOfMonthIndex / 7) : 0;
        }

        const weeksHTML = [];
        for (let i = 0; i < 6; i++) {
          weeksHTML.push(finalDayElements.slice(i * 7, (i + 1) * 7).join(""));
        }

        // Mostramos la semana por defecto (la de "hoy" o la "primera")
        currentWeekGridEl.innerHTML = weeksHTML[todayRowIndex];

        let otherWeeksHTML = "";
        for (let i = 0; i < 6; i++) {
          const shouldAddWeek = i > todayRowIndex; // <-- todayRowIndex es 0

          if (shouldAddWeek) {
            // Esto será true para i = 1, 2, 3, 4, 5
            if (weeksHTML[i] && !weeksHTML[i].includes('class="calendar-day other-month"'.repeat(7))) {
              otherWeeksHTML += weeksHTML[i];
            }
          }
        }
        otherWeeksGridEl.innerHTML = otherWeeksHTML;
      }
      function renderMonthPickerDropdown() {
        const monthListContainerEl = document.getElementById("month-list-container");
        const yearDisplayEl = document.getElementById("month-picker-year");

        if (!monthListContainerEl || !yearDisplayEl) return;

        // 1. Actualizar el año visible en el picker
        yearDisplayEl.textContent = monthPickerYear;

        // 2. Obtener el año y mes de la vista actual (para el highlight)
        const viewYear = currentFilterDate.getFullYear();
        const viewMonth = currentFilterDate.getMonth();

        // 3. Limpiar y generar los 12 meses
        monthListContainerEl.innerHTML = "";
        MONTH_NAMES.forEach((name, index) => {
          // El mes está "activo" SOLO SI el año del picker coincide con el año de la vista
          const isActive = index === viewMonth && monthPickerYear === viewYear;
          monthListContainerEl.insertAdjacentHTML("beforeend", `<button data-month="${index}" class="month-picker-btn ${isActive ? "active" : ""}">${name.substring(0, 3)}</button>`);
        });
      }
      // MODIFICADO: Añadir rotación de icono chevron al expandir/colapsar
      function handleExpenseReportClick(e) {
        // Primero, revisa si se hizo clic en un encabezado de CATEGORÍA
        const categoryToggleBtn = e.target.closest(".category-toggle-btn");
        if (categoryToggleBtn) {
          e.preventDefault(); // Evita que el navegador haga algo raro con el botón
          const targetId = categoryToggleBtn.dataset.targetId; // El ID del div a mostrar/ocultar
          const contentElement = document.getElementById(targetId); // El div con el contenido
          //const chevronIcon = categoryToggleBtn.querySelector('.category-chevron'); // El icono de flecha (no necesitamos rotarlo aquí si usamos la clase 'open' en el botón)

          if (contentElement) {
            // Alterna la clase 'open' en el div de contenido (el CSS hace la animación)
            const isOpen = contentElement.classList.toggle("open");
            // Alterna la clase 'open' en el botón mismo (para que el CSS rote el icono)
            categoryToggleBtn.classList.toggle("open", isOpen);
          }
          return; // Importante: Si fue clic en categoría, no hagas nada más
        }

        // Si NO fue clic en categoría, revisa si fue clic DENTRO de una tarjeta de GASTO
        const target = e.target.closest("button, .expense-header"); // Busca un botón (Editar/Eliminar) o la cabecera de un gasto compartido
        if (!target) return; // Si no fue en ninguno de esos, no hagas nada

        const id = target.dataset.id; // ID del gasto para Editar/Eliminar
        const expenseIdToggle = target.dataset.toggle; // ID del gasto para desplegar (si es compartido)

        // Si se hizo clic en la cabecera de un GASTO COMPARTIDO (tiene data-toggle)
        if (expenseIdToggle && target.classList.contains("expense-header")) {
          const detailEl = document.getElementById(`detail-${expenseIdToggle}`); // El div con los detalles de repartición
          const headerEl = target.closest(".expense-header"); // La cabecera misma
          const chevronIcon = headerEl?.querySelector(".fa-chevron-down"); // El icono de flecha DENTRO de la tarjeta de gasto

          if (detailEl) {
            // Alterna la clase 'hidden' (no usamos 'open' aquí, es un despliegue diferente)
            detailEl.classList.toggle("hidden");
            // Rota el icono DENTRO de la tarjeta de gasto
            if (chevronIcon) chevronIcon.classList.toggle("rotate-180");
          }
        }
        // Si se hizo clic en el botón EDITAR de un gasto
        else if (id && target.classList.contains("edit-expense-btn")) {
          openExpenseEditModal(id);
        }
        // Si se hizo clic en el botón ELIMINAR de un gasto
        else if (id && target.classList.contains("delete-btn")) {
          removeExpense(id);
        }
      }

      function renderFixedExpensesSummary(expensesForMonth) {
        // 1. Acepta el parámetro
        const fixedEl = document.getElementById("fixed-expenses-summary");

        // 2. ¡ESTA ES LA LÍNEA CORREGIDA!
        // Filtra la lista 'expensesForMonth' (que ya tiene las proyecciones)
        const fixedExpenses = expensesForMonth.filter((e) => e.isFixed);
        // 3. Ya no se usa 'filterString' ni 'appState.expenses' aquí

        if (fixedExpenses.length === 0) {
          fixedEl.innerHTML = '<p class="text-gray-500 italic">No hay gastos fijos para este ciclo.</p>';
          return;
        }

        const participantsMap = new Map(appState.participants.map((p) => [p.id, p.name]));
        const sharedFixed = fixedExpenses.filter((exp) => exp.type === "shared");
        const personalFixed = fixedExpenses.filter((exp) => exp.type === "personal");

        let html = "";

        if (sharedFixed.length > 0) {
          html += `<div class="mb-4">
              <h4 class="font-bold text-sm text-purple-800 bg-purple-100 p-2 rounded-t-lg">Gastos Fijos del Grupo</h4>
              <div class="space-y-2 border border-t-0 border-purple-200 p-2 rounded-b-lg">`;
          html += sharedFixed
            .map(
              (exp) => `
          <div class="p-2 bg-white rounded-md border border-gray-200 ${exp.isProjected ? "border-dashed border-gray-400 opacity-80" : ""}">
            <div class="flex justify-between items-center">
              <p class="font-semibold text-gray-800 text-sm">${exp.description}</p>
              <p class="font-bold text-purple-600 text-sm">${formatCurrency(exp.amount)}</p>
            </div>
            <p class="text-xs text-gray-500">Pagado por: ${participantsMap.get(exp.payerId) || "N/A"}</p>
          </div>`
            )
            .join("");
          html += `</div></div>`;
        }

        appState.participants.forEach((p) => {
          const pExpenses = personalFixed.filter((exp) => exp.payerId === p.id);
          if (pExpenses.length > 0) {
            html += `<div class="mb-4">
                   <h4 class="font-bold text-sm text-blue-800 bg-blue-100 p-2 rounded-t-lg">Fijos de ${p.name}</h4>
                   <div class="space-y-2 border border-t-0 border-blue-200 p-2 rounded-b-lg">`;
            html += pExpenses
              .map(
                (exp) => `
            <div class="p-2 bg-white rounded-md border border-gray-200 ${exp.isProjected ? "border-dashed border-gray-400 opacity-80" : ""}">
              <div class="flex justify-between items-center">
                <p class="font-semibold text-gray-800 text-sm">${exp.description}</p>
                <p class="font-bold text-blue-600 text-sm">${formatCurrency(exp.amount)}</p>
              </div>
            </div>`
              )
              .join("");
            html += `</div></div>`;
          }
        });

        fixedEl.innerHTML = html;
      }

      // ================================================================
      // ===== 2. REEMPLAZA ESTA FUNCIÓN COMPLETA =====
      // ================================================================
      function renderSharedBalanceSummary(summary) {
        const settlementContentEl = document.getElementById("settlement-summary-content");
        if (!settlementContentEl) return;

        // 1. Llamar a la función de liquidación para los participantes reales
        const settlements = calculateSettlements(summary.participantData);

        let balanceHtml = "";

        // 2. Balance de invitados (Corregido)
        if (Math.abs(summary.guestBalanceNet) > 0.01) {
          if (summary.guestBalanceNet < 0) {
            // El invitado debe al grupo
            balanceHtml += `
        <div class="flex justify-between items-center bg-gray-100 text-red-600 font-bold p-3 rounded-lg border border-red-200">
          <span><i class="fas fa-user-tag mr-2"></i>Invitado(s) debe(n) al grupo</span>
          <span class="text-lg">${formatCurrency(Math.abs(summary.guestBalanceNet))}</span>
        </div>
        <hr class="my-3">
      `;
          } else {
            // El grupo debe al invitado
            balanceHtml += `
        <div class="flex justify-between items-center bg-gray-100 text-green-600 font-bold p-3 rounded-lg border border-green-200">
          <span><i class="fas fa-user-tag mr-2"></i>El grupo debe a Invitado(s)</span>
          <span class="text-lg">${formatCurrency(summary.guestBalanceNet)}</span>
        </div>
        <hr class="my-3">
      `;
          }
        }

        // 3. Título principal
        balanceHtml += `<h4 class="font-bold text-gray-700 text-lg mb-2">Para saldar las cuentas:</h4>`;

        // 4. Mostrar la lista de acciones simples
        if (settlements.length > 0) {
          balanceHtml += '<div class="space-y-2">';
          balanceHtml += settlements
            .map((t) => {
              return `
          <div class="flex flex-col sm:flex-row justify-between sm:items-center bg-white border border-gray-200 p-4 rounded-lg shadow-sm gap-2">
            <span class="flex items-center text-lg">
              <strong class="font-bold text-red-600">${t.from}</strong>
              <i class="fas fa-long-arrow-alt-right mx-3 text-gray-400"></i>
              <strong class="font-bold text-green-600">${t.to}</strong>
            </span>
            <span class="font-bold text-xl text-blue-600 text-left sm:text-right">${formatCurrency(t.amount)}</span>
          </div>
        `;
            })
            .join("");
          balanceHtml += "</div>";
        }

        // 5. Mensaje si no hay deudas (Corregido)
        if (settlements.length === 0 && Math.abs(summary.guestBalanceNet) < 0.01) {
          settlementContentEl.innerHTML = `
      <div class="text-center p-4 py-8">
        <i class="fas fa-handshake text-green-500 text-4xl mb-3"></i>
        <p class="font-bold text-xl text-gray-800">¡Cuentas claras!</p>
        <p class="text-gray-500 text-sm">Nadie debe nada en este ciclo.</p>
      </div>`;
          return;
        }

        settlementContentEl.innerHTML = balanceHtml;
      }

      function setupSettlementModalListeners() {
        const modal = document.getElementById("settlement-modal");
        const openBtn = document.getElementById("open-settlement-modal-btn");
        const closeBtnTop = document.getElementById("close-settlement-modal-btn");
        const closeBtnBottom = document.getElementById("close-settlement-modal-btn-bottom");

        if (!modal || !openBtn || !closeBtnTop || !closeBtnBottom) {
          console.warn("Faltan elementos del modal de liquidación.");
          return;
        }

        const openModal = () => {
          // La función renderUI() ya habrá llenado el contenido.
          // Solo necesitamos mostrar el modal.
          modal.classList.remove("hidden");
          modal.classList.add("flex");
          document.body.classList.add("no-scroll");
        };

        const closeModal = () => {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          document.body.classList.remove("no-scroll");
        };

        openBtn.addEventListener("click", openModal);
        closeBtnTop.addEventListener("click", closeModal);
        closeBtnBottom.addEventListener("click", closeModal);
      }
      // ================================================================
      // ===== 2. REEMPLAZA ESTA FUNCIÓN COMPLETA =====
      // ================================================================
      function renderCategoryChart(filteredExpenses) {
        const ctx = document.getElementById("category-chart").getContext("2d");
        const noDataEl = document.getElementById("chart-no-data");

        if (categoryChart) categoryChart.destroy();

        // Aplicar filtros dinámicos también al gráfico
        const descriptionFilter = activeFilters.description;
        const categoryFilter = activeFilters.category;
        const participantFilter = activeFilters.participant;
        const paymentMethodFilter = activeFilters.paymentMethod;
        const guestOnlyFilter = activeFilters.guestOnly; // <-- ¡ESTA ES LA LÍNEA QUE FALTABA!

        let chartFilteredExpenses = filteredExpenses;
        if (descriptionFilter) {
          chartFilteredExpenses = chartFilteredExpenses.filter((e) => e.description.toLowerCase().includes(descriptionFilter) || (e.subcategory && e.subcategory.toLowerCase().includes(descriptionFilter)));
        }
        if (categoryFilter) {
          chartFilteredExpenses = chartFilteredExpenses.filter((e) => e.category === categoryFilter);
        }
        if (participantFilter) {
          chartFilteredExpenses = chartFilteredExpenses.filter((e) => e.payerId === participantFilter);
        }
        if (paymentMethodFilter) {
          chartFilteredExpenses = chartFilteredExpenses.filter((e) => e.paymentMethodId === paymentMethodFilter);
        }
        if (guestOnlyFilter) {
          chartFilteredExpenses = chartFilteredExpenses.filter((e) => e.payerId.startsWith("guest_"));
        }

        if (chartFilteredExpenses.length === 0) {
          noDataEl.classList.remove("hidden");
          if (categoryChart) {
            categoryChart.destroy();
            categoryChart = null;
          }
          return;
        }

        // (El resto de la función es idéntico y no necesita cambios)
        noDataEl.classList.add("hidden");

        const groupedData = chartFilteredExpenses.reduce((acc, expense) => {
          const category = expense.category || "Sin Categoría";
          acc[category] = (acc[category] || 0) + expense.amount;
          return acc;
        }, {});

        const labels = Object.keys(groupedData);
        const datasets = [
          {
            label: "Gasto",
            data: [],
            backgroundColor: "#4f46e5", // Indigo
          },
          {
            label: "Excedente",
            data: [],
            backgroundColor: "#ef4444", // Red
          },
        ];

        labels.forEach((label) => {
          const totalSpent = groupedData[label];
          const category = appState.categories.find((c) => c.name === label);
          const budget = category?.budget || 0;

          if (budget > 0 && totalSpent > budget) {
            datasets[0].data.push(budget);
            datasets[1].data.push(totalSpent - budget);
          } else {
            datasets[0].data.push(totalSpent);
            datasets[1].data.push(0);
          }
        });

        categoryChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            scales: {
              x: { stacked: true, beginAtZero: true },
              y: { stacked: true },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label || "";
                    if (label) label += ": ";
                    label += formatCurrency(context.raw);
                    return label;
                  },
                },
              },
            },
          },
        });
      }

      // ================================================================
      // ===== REEMPLAZA ESTA FUNCIÓN COMPLETA =====
      // ================================================================

      function renderCreditCardSummary(expensesForMonth, allExpenses) {
        const paymentMethods = appState.paymentMethods || [];
        const participants = appState.participants || [];
        const container = document.getElementById("credit-card-summary-cards");
        const section = document.getElementById("credit-card-summary-section");
        const today = new Date();

        paymentMethodPopovers.forEach((popover) => popover.destroy());
        paymentMethodPopovers = [];

        if (!container || !section) return;
        container.innerHTML = "";

        paymentMethods.forEach((method) => {
          let totalSpentOnMethod = 0;
          let expensesToConsider = [];
          let cardSubtitle = "";

          if (method.type === "credit") {
            const { startDate, closingDate } = getCycleDates(method, today);

            if (startDate && closingDate) {
              const cycleStart = new Date(startDate + "T00:00:00Z").getTime();
              const cycleEnd = new Date(closingDate + "T00:00:00Z").getTime();

              expensesToConsider = allExpenses.filter((exp) => {
                const expenseDate = new Date(exp.date + "T00:00:00Z").getTime();
                return exp.paymentMethodId === method.id && !isNaN(expenseDate) && expenseDate >= cycleStart && expenseDate <= cycleEnd;
              });

              cardSubtitle = `Ciclo: ${formatShortDate(startDate)} al ${formatShortDate(closingDate)}`;
            } else {
              cardSubtitle = "Error al calcular ciclo";
            }
          } else {
            expensesToConsider = expensesForMonth.filter((exp) => exp.paymentMethodId === method.id);
            cardSubtitle = `Gasto total en ${MONTH_NAMES[currentFilterDate.getMonth()]}`;
          }

          totalSpentOnMethod = expensesToConsider.reduce((sum, exp) => sum + exp.amount, 0);

          // ====================================================================
          // --- INICIO DE LÓGICA DE POPOVER MODIFICADA ---
          // ====================================================================
          // Lógica de cálculo del popover (Quién DEBE qué parte)

          // 1. Crear un mapa para la "deuda" (responsabilidad) de cada uno
          const debtMap = new Map();
          participants.forEach((p) => debtMap.set(p.id, { total: 0, name: p.name }));
          let debtInvitados = 0;
          const numParticipants = participants.length;

          // 2. Procesar cada gasto de esta tarjeta
          expensesToConsider.forEach((expense) => {
            if (expense.type === "shared") {
              // Gasto Compartido
              const numPayees = expense.payerId.startsWith("guest_") ? numParticipants + 1 : numParticipants;
              const splitAmount = expense.amount / numPayees;

              // Asignar su "parte" a cada participante
              debtMap.forEach((data) => {
                data.total += splitAmount;
              });

              // Asignar su "parte" al invitado si aplica
              if (numPayees > numParticipants) {
                debtInvitados += splitAmount;
              }
            } else {
              // Gasto Personal
              const payerDebt = debtMap.get(expense.payerId);
              if (payerDebt) {
                // El 100% del gasto personal va al "debe" del pagador
                payerDebt.total += expense.amount;
              } else if (expense.payerId.startsWith("guest_")) {
                // Un gasto personal de un invitado va 100% a él
                debtInvitados += expense.amount;
              }
            }
          });

          // 3. --- HTML del Popover ---
          let popoverContentHTML = "";

          debtMap.forEach((data, id) => {
            if (data.total > 0) {
              popoverContentHTML += `
          <div class="flex justify-between items-center text-sm">
            <span>${data.name} (su parte)</span>
            <span class="font-bold text-gray-800">${formatCurrency(data.total)}</span>
          </div>
        `;
            }
          });

          if (debtInvitados > 0) {
            popoverContentHTML += `
        <div class="flex justify-between items-center text-sm">
          <span>Invitado(s) (su parte)</span>
          <span class="font-bold text-gray-800">${formatCurrency(debtInvitados)}</span>
        </div>
      `;
          }

          if (popoverContentHTML === "") {
            popoverContentHTML = '<span class="text-xs text-gray-500 italic">Sin gastos.</span>';
          }

          // 4. Título del popover (¡Cambiado!)
          const popoverTitle = `<h4 class="text-xs font-bold uppercase text-gray-500 mb-2">Desglose de Responsabilidad</h4>`;

          // ====================================================================
          // --- FIN DE LÓGICA DE POPOVER MODIFICADA ---
          // ====================================================================

          // --- HTML DE FILA ---
          const popoverId = `pm-popover-${method.id}`;
          const iconClass = method.type === "credit" ? "fa-credit-card" : "fa-wallet";
          const iconBgClass = method.type === "credit" ? "credit" : "cash";

          const cardHTML = `
      <div>
        <div class="payment-method-row payment-method-summary-card" data-popover-target="${popoverId}" data-popover-trigger="hover" data-method-id="${method.id}">
          <div class="payment-method-icon ${iconBgClass}">
            <i class="fas ${iconClass}"></i>
          </div>
          <div class="payment-method-info">
            <p class="title">${method.name}</p>
            <p class="subtitle">${cardSubtitle}</p>
          </div>
          <div class="payment-method-amount">
            <span>${formatCurrency(totalSpentOnMethod)}</span>
          </div>
        </div>

        <div data-popover id="${popoverId}" role="tooltip" class="popover invisible opacity-0 z-10 saldos-popover">
          <div class="saldos-individuales-list">
            ${popoverTitle} ${popoverContentHTML} </div>
          <div data-popper-arrow class="popover-arrow"></div>
        </div>
      </div>
    `;

          container.insertAdjacentHTML("beforeend", cardHTML);
        });

        // Inicializar los popovers
        container.querySelectorAll("[data-popover-target]").forEach((triggerEl) => {
          const popoverId = triggerEl.getAttribute("data-popover-target");
          const popoverEl = document.getElementById(popoverId);

          if (popoverEl && window.Popover) {
            const options = {
              placement: triggerEl.getAttribute("data-popover-placement") || "bottom",
              triggerType: triggerEl.getAttribute("data-popover-trigger") || "hover",
            };
            const popoverInstance = new window.Popover(popoverEl, triggerEl, options);
            paymentMethodPopovers.push(popoverInstance);
          }
        });

        // Lógica para mostrar/ocultar
        if (paymentMethods.length === 0) {
          section.classList.add("hidden");
        } else {
          section.classList.remove("hidden");
        }
      }

      // ================================================================
      // ===== FIN DEL REEMPLAZO =====
      // ================================================================
      // --- Main Render Function ---
      function renderUI() {
        if (!appState) return;
        const filterMonthString = getFilterMonthString(currentFilterDate);

        // --- INICIO DE LA NUEVA LÓGICA DE PROYECCIÓN DE GASTOS FIJOS ---
        const allExpenses = appState.expenses || [];
        const projectedFixedExpenses = [];
        const filterViewDate = new Date(currentFilterDate.getTime()); // Fecha de la vista actual

        // 1. Encontrar todos los gastos que son la "plantilla" original de un gasto fijo
        const baseFixedExpenses = allExpenses.filter((e) => e.isFixed);

        baseFixedExpenses.forEach((baseExpense) => {
          const baseDate = new Date(baseExpense.date + "T00:00:00Z");
          const recurrenceMonths = baseExpense.fixedRecurrenceMonths || 12; // Asumir 12 meses si no está definido

          // Calcular la diferencia en meses entre la vista actual y la fecha base del gasto
          const baseYear = baseDate.getUTCFullYear();
          const baseMonth = baseDate.getUTCMonth(); // 0-11
          const viewYear = filterViewDate.getUTCFullYear();
          const viewMonth = filterViewDate.getUTCMonth(); // 0-11

          const monthDifference = (viewYear - baseYear) * 12 + (viewMonth - baseMonth);

          // 2. Comprobar si este gasto debe ocurrir en este mes
          // (Es el futuro, pero dentro del período de recurrencia, y no es el mes base original)
          if (monthDifference > 0 && monthDifference < recurrenceMonths) {
            // 3. Crear la fecha proyectada para este mes (mantiene el día original)
            let projectedDate = new Date(Date.UTC(viewYear, viewMonth, baseDate.getUTCDate()));

            // 4. Ajuste por si el mes es más corto (ej. base es 31, mes actual es Feb)
            // Si al poner el día 31, el mes cambió a Marzo, retrocedemos al último día de Feb.
            if (projectedDate.getUTCMonth() !== viewMonth) {
              projectedDate = new Date(Date.UTC(viewYear, viewMonth + 1, 0)); // 0 = último día del mes anterior
            }

            const projectedDateString = projectedDate.toISOString().split("T")[0];

            // 5. Verificar si un gasto *similar* (mismo nombre) ya fue registrado manualmente este mes
            // (Para evitar duplicados si el usuario lo pagó y registró)
            const alreadyExists = allExpenses.some((e) => e.date.startsWith(filterMonthString) && e.description.toLowerCase() === baseExpense.description.toLowerCase());

            if (!alreadyExists) {
              // 6. Añadir el gasto proyectado a la lista
              projectedFixedExpenses.push({
                ...baseExpense,
                id: `proj_${baseExpense.id}_${monthDifference}`, // ID único para la proyección
                date: projectedDateString, // La nueva fecha
                isProjected: true, // Un flag para saber que es virtual
              });
            }
          }
        });
        // --- FIN DE LA NUEVA LÓGICA ---

        // 7. Obtener los gastos REALES de este mes
        let expensesForMonth = allExpenses.filter((e) => e.date && e.date.startsWith(filterMonthString));

        // --- INICIO DE MODIFICACIÓN ---
        // 8. Combinar los gastos reales con los proyectados
        expensesForMonth = [...expensesForMonth, ...projectedFixedExpenses];
        // --- FIN DE MODIFICACIÓN ---

        // Si no hay gastos en el mes actual y hay gastos en total Y no es el mes actual, intenta ir al mes del último gasto
        // (El resto de la función de autoselección de mes se queda igual)

        const summary = calculateSummary(appState, expensesForMonth); // Calcular summary con gastos SIN filtrar dinámicamente

        //renderMonthSelector();
        renderInteractiveCalendar();
        renderDashboard(summary);
        renderParticipantsConfig(appState.participants, summary); // Usa el summary original, actualiza etiquetas de filtro
        renderCategoriesModal(appState.categories); // Popula filtros y modal, actualiza etiquetas de filtro
        // Los render de modals deben ir antes para poblar los selects
        renderPaymentMethodsModal(appState.paymentMethods);

        // MODIFICADO: Pasar 'expensesForMonth'
        renderCreditCardSummary(expensesForMonth, allExpenses);

        // Pasar los gastos del mes *antes* de aplicar filtros dinámicos
        renderExpenseReportByCategory(expensesForMonth, summary);
        renderCategoryChart(expensesForMonth); // Renderizar gráfico con gastos del mes (filtrados dinámicamente dentro)
        renderFixedExpensesSummary(expensesForMonth); // Usa appState.expenses, no necesita cambios
        renderSharedBalanceSummary(summary); // Usa el summary original

        // CLAVE: Inicializar los selects del formulario de gastos DESPUÉS de poblar las opciones
        initializeCustomSelect("expense-paid-by");
        initializeCustomSelect("expense-payment-method-id");
        initializeCustomSelect("expense-category");
        populateModalTags();

        // NUEVO: Actualizar estado visual del botón de filtros y las etiquetas
        updateFilterUIState();
      }

      window.onload = initializeFirebase;
      window.onerror = function (message, source, lineno, colno, error) {
        console.error("Error global:", message, error);
        showModal("Ocurrió un error inesperado.", error?.message || message, "Error Crítico");
        return true;
      };
    </script>
  </body>
</html>
