import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel, collection, increment, updateDoc
} from 'firebase/firestore';

// Set Firebase logging level to help with debugging
setLogLevel('debug');

// --- Global Variables (Mandatory Canvas Globals) ---
// These variables are provided by the hosting environment.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : { /* placeholder config */ };
const initialAuthToken = typeof __initial_auth_token !== 'undefined' 
  ? __initial_auth_token 
  : null;

// The data will be stored in a private path for the user:
// /artifacts/{appId}/users/{userId}/data/counter
const COLLECTION_NAME = 'data';
const DOCUMENT_ID = 'counter';


// Main Application Component
const App = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [count, setCount] = useState(0);
  const [error, setError] = useState(null);

  // 1. Initialization and Authentication Effect
  useEffect(() => {
    try {
      const app = initializeApp(firebaseConfig);
      const authInstance = getAuth(app);
      const dbInstance = getFirestore(app);

      setAuth(authInstance);
      setDb(dbInstance);

      // Listener to get the userId once auth state is settled
      const unsubscribeAuth = onAuthStateChanged(authInstance, async (user) => {
        if (user) {
          // User is signed in. The uid is now available.
          setUserId(user.uid);
          console.log(`[Auth] User signed in. UID: ${user.uid}`);
        } else {
          // No user, but we sign in now to establish authentication
          console.log('[Auth] Attempting sign-in...');
          try {
            if (initialAuthToken) {
              // Sign in with the provided custom token
              await signInWithCustomToken(authInstance, initialAuthToken);
              console.log('[Auth] Signed in with custom token.');
            } else {
              // Fallback to anonymous sign-in
              const anonUserCredential = await signInAnonymously(authInstance);
              setUserId(anonUserCredential.user.uid);
              console.log(`[Auth] Signed in anonymously. UID: ${anonUserCredential.user.uid}`);
            }
          } catch (e) {
            console.error('[Auth] Failed to sign in:', e);
            setError('Authentication failed. Check Firebase config/token.');
          }
        }
        // Auth state is ready regardless of success, stop global loading
        setLoading(false);
      });

      return () => unsubscribeAuth();
    } catch (e) {
      console.error('[Firebase Init] Error during initialization:', e);
      setError('Firebase initialization error. Check config.');
      setLoading(false);
    }
  }, []);

  // 2. Data Listener Effect (Runs ONLY when DB and authenticated UserId are ready)
  useEffect(() => {
    // CRITICAL FIX: Only attach the listener if BOTH db and userId are available.
    // This ensures we have sufficient permissions before querying the private path.
    if (!db || !userId) {
      console.log('[Firestore] Waiting for DB or User ID to be ready...');
      return;
    }

    const counterPath = `/artifacts/${appId}/users/${userId}/${COLLECTION_NAME}/${DOCUMENT_ID}`;
    const docRef = doc(db, counterPath);

    console.log(`[Firestore] Attaching listener to: ${counterPath}`);

    // Set up initial document if it doesn't exist
    const initializeCounter = async () => {
        try {
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) {
                console.log('[Firestore] Document does not exist. Creating initial counter (0).');
                // Use setDoc to create the document if it's missing
                await setDoc(docRef, { value: 0, lastUpdated: new Date().toISOString() });
            }
        } catch (e) {
            console.error('[Firestore] Error initializing document:', e);
            setError('Could not initialize counter document. Permission issue likely.');
        }
    };
    initializeCounter();

    // Attach real-time listener
    const unsubscribe = onSnapshot(docRef, (snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.data();
        setCount(data.value || 0);
        console.log(`[Firestore] Updated counter value received: ${data.value}`);
      } else {
        // This case should be handled by initializeCounter, but for safety:
        console.log('[Firestore] Document disappeared.');
        setCount(0);
      }
    }, (e) => {
      // THIS CATCHES THE PERMISSION ERROR
      console.error('Error al escuchar cambios en Firestore:', e);
      // Display the error clearly to the user
      setError(`Error fetching data: ${e.message}. Check security rules.`);
    });

    // Cleanup function for the listener
    return () => {
      console.log('[Firestore] Detaching listener.');
      unsubscribe();
    };
  }, [db, userId]); // Dependencies ensure this runs only when Firebase and Auth are ready

  // Function to increment the counter
  const incrementCount = useCallback(async () => {
    if (!db || !userId) {
      setError('System not ready. Please wait for authentication.');
      return;
    }

    const counterPath = `/artifacts/${appId}/users/${userId}/${COLLECTION_NAME}/${DOCUMENT_ID}`;
    const docRef = doc(db, counterPath);
    
    try {
      await updateDoc(docRef, {
        value: increment(1),
        lastUpdated: new Date().toISOString()
      });
    } catch (e) {
      console.error('[Firestore] Error incrementing counter:', e);
      setError(`Failed to update counter: ${e.message}`);
    }
  }, [db, userId]);

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-900 text-white">
        <svg className="animate-spin h-5 w-5 mr-3 text-indigo-400" viewBox="0 0 24 24">...</svg>
        <p>Initializing Firebase and Authentication...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-900 flex items-center justify-center p-4">
      <script src="https://cdn.tailwindcss.com"></script>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
      `}</style>
      
      <div className="w-full max-w-md bg-gray-800 p-8 rounded-xl shadow-2xl border border-indigo-700">
        <h1 className="text-3xl font-extrabold text-white mb-2 text-center">Secure Counter App</h1>
        <p className="text-indigo-400 text-sm mb-6 text-center">Data stored privately in Firestore.</p>

        {error && (
          <div className="bg-red-900 text-red-300 p-3 rounded-lg mb-4 text-sm break-all">
            <strong className="font-bold">Error:</strong> {error}
          </div>
        )}

        <div className="text-center mb-8">
          <p className="text-gray-400 text-lg">Current Value</p>
          <p className="text-7xl font-black text-indigo-400 transition-all duration-300 transform scale-100 hover:scale-105">
            {count}
          </p>
        </div>
        
        <button
          onClick={incrementCount}
          disabled={!db || !userId}
          className={`w-full py-3 rounded-lg text-lg font-semibold transition duration-200 shadow-lg ${
            db && userId
              ? 'bg-indigo-600 hover:bg-indigo-700 text-white transform hover:scale-[1.01] active:scale-95'
              : 'bg-gray-600 text-gray-400 cursor-not-allowed'
          }`}
        >
          Increment Counter
        </button>

        <div className="mt-8 text-center text-xs text-gray-500">
          <p className="mb-1">Authenticated User ID (Required for Firestore Access):</p>
          <p className="font-mono text-gray-400 break-all p-2 bg-gray-700 rounded-md shadow-inner">{userId || 'N/A (Loading)'}</p>
        </div>
      </div>
    </div>
  );
};

export default App;
